import*as e from"d3";var t="object"==typeof window&&window.d3?window.d3:e;function n(e,t,n){return n.find(n=>n.id!==t.id&&(n.id===e.rels.mother||n.id===e.rels.father))}function i(e,t,n){if(e.exiting=n,t)0!==e.depth||e.spouse?e.spouse?(e._x=e.spouse.x,e._y=e.spouse.y):e.is_ancestry?(e._x=e.parent.x,e._y=e.parent.y):(e._x=e.psx,e._y=e.psy):(e._x=e.x,e._y=e.y);else if(n){const t=e.x>0?1:-1,n=e.y>0?1:-1;e._x=e.x+400*t,e._y=e.y+400*n}}function s(e,t){const n=t?"rels":"_rels",i=t?"_rels":"rels";function s(t){e.data[n]&&e.data[n][t]&&(e.data[i]||(e.data[i]={}),e.data[i][t]=e.data[n][t],delete e.data[n][t])}e.is_ancestry||e.data.main?(s("father"),s("mother")):function(){if(!e.data[n]||!e.data[n].children)return;const t=e.data[n].children.slice(0),s=e.spouse?[e.spouse]:e.spouses||[];[e,...s].forEach(e=>t.forEach(t=>{e.data[n].children.includes(t)&&(e.data[i]||(e.data[i]={}),e.data[i].children||(e.data[i].children=[]),e.data[i].children.push(t),e.data[n].children.splice(e.data[n].children.indexOf(t),1))}))}()}function a({tree:e,data_stash:t,private_cards_config:n}){const i={},s=n.condition;if(!s)return console.error("private_cards_config.condition is not set");e.forEach(e=>{if(e.data._new_rel_data)return;const n=function(e){const n=[];let a=!1;return r(e),i[e]=a,a;function r(e){if(a)return;if(i.hasOwnProperty(e))return a=i[e],a;const o=t.find(t=>t.id===e);if(o._new_rel_data)return;if(s(o))return a=!0,!0;const l=o.rels;[l.father,l.mother,...l.spouses||[]].forEach(e=>{e&&(n.includes(e)||(n.push(e),r(e)))})}}(e.data.id);n&&(e.is_private=n)})}function r(e,t){const n=e.rels,i=[n.father,n.mother,...n.spouses||[],...n.children||[]].filter(e=>!!e),s=[];for(let n=0;n<i.length;n++){if(!a(t.find(e=>e.id===i[n]),[e])){s.push(i[n]);break}}return 0===s.length;function a(e,n){let i;return r(e)&&(i=[e]),function e(s,a){if(i)return;a=[...a,s],o(function(e){r(e)&&(i=a)}),i||o(l);function o(e){if(!s)return;const t=s.rels;[t.father,t.mother,...t.spouses||[],...t.children||[]].filter(e=>e&&![...n,...a].find(t=>t.id===e)).forEach(t=>e(t))}function l(n){const i=t.find(e=>e.id===n);e(i,a)}}(e,[e]),i}function r(e){return"object"==typeof e?e.id===t[0].id:e===t[0].id}}function o(e,t){const n=t[0];if(e.id===n.id)return!0;const i=[];let s=!1;return function e(a){if(s)return;const r=a.rels;[r.father,r.mother,...r.spouses||[],...r.children||[]].filter(e=>!!e).forEach(a=>{if(i.includes(a))return;i.push(a);const r=t.find(e=>e.id===a);r.id===n.id?s=!0:e(r)})}(e),s}function l(e,t,n){const i=e.id;n.forEach(e=>{e.rels.father===i&&(e.rels.father=t),e.rels.mother===i&&(e.rels.mother=t),(e.rels.spouses||[]).includes(i)&&(e.rels.spouses=e.rels.spouses.filter(e=>e!==i),e.rels.spouses.includes(t)||e.rels.spouses.push(t)),(e.rels.children||[]).includes(i)&&(e.rels.children=e.rels.children.filter(e=>e!==i),e.rels.children.includes(t)||e.rels.children.push(t))});const s=n.find(e=>e.id===t),a=n.find(e=>e.id===i);(a.rels.children||[]).forEach(e=>{s.rels.children||(s.rels.children=[]),s.rels.children.includes(e)||s.rels.children.push(e)}),(a.rels.spouses||[]).forEach(e=>{s.rels.spouses||(s.rels.spouses=[]),s.rels.spouses.includes(e)||s.rels.spouses.push(e)}),s.rels.father&&a.rels.father&&console.error("link rel already has father"),s.rels.mother&&a.rels.mother&&console.error("link rel already has mother"),a.rels.father&&(s.rels.father=a.rels.father),a.rels.mother&&(s.rels.mother=a.rels.mother),n.splice(n.findIndex(e=>e.id===i),1)}function d(e,t){const n=e._new_rel_data?t.find(t=>t.id===e._new_rel_data.rel_id):null,i=function(e,t){const n=[];return i(e),n;function i(e){[e.rels.father,e.rels.mother].forEach(e=>{e&&(n.push(e),i(t.find(t=>t.id===e)))})}}(e,t),s=a(e,t);return e._new_rel_data&&["son","daughter"].includes(e._new_rel_data.rel_type)&&s.push(...a(n,t)),t.filter(t=>t.id!==e.id&&t.id!==n?.id&&!t._new_rel_data&&!t.to_add&&!t.unknown).filter(e=>!i.includes(e.id)).filter(e=>!s.includes(e.id)).filter(t=>!(t.rels.spouses||[]).includes(e.id));function a(e,t){const n=[];return function e(i){(i.rels.children?[...i.rels.children]:[]).forEach(i=>{n.push(i),e(t.find(e=>e.id===i))})}(e),n}}function c(e,t){Object.keys(e.data).forEach(n=>{if(n.includes("__ref__")){const i=n.split("__ref__")[1],s=t.find(e=>e.id===i);if(!s)return;const a=n.split("__ref__")[0]+"__ref__"+e.id;s.data[a]=e.data[n]}})}function h(e,t){Object.keys(e.data).forEach(n=>{if(n.includes("__ref__")){const i=n.split("__ref__")[1],s=t.find(e=>e.id===i);if(!s)return;const a=n.split("__ref__")[0]+"__ref__"+e.id;delete s.data[a]}})}function u(e,t){return delete e.to_add,e}function p(e,t){return f(e,t),!1}function f(e,t){return r(e,t)?(t.forEach(t=>{for(let n in t.rels)t.rels.hasOwnProperty(n)&&(t.rels[n]===e.id?delete t.rels[n]:Array.isArray(t.rels[n])&&t.rels[n].includes(e.id)&&t.rels[n].splice(t.rels[n].findIndex(t=>t===e.id),1))}),h(e,t),t.splice(t.findIndex(t=>t.id===e.id),1),t.forEach(e=>{e.to_add&&f(e,t)}),0===t.length&&t.push(v({}).data[0]),{success:!0}):(h(e,t),e.data={gender:e.data.gender},e.unknown=!0,{success:!0})}function m({datum:e,data_stash:t,rel_type:n,rel_datum:i}){function s(e){!function(){if(!i.rels.spouses)return;i.rels.spouses.forEach(e=>{const n=t.find(t=>t.id===e);n.to_add&&p(n,t)})}(),i.rels.spouses||(i.rels.spouses=[]),i.rels.spouses.push(e.id),e.rels.spouses=[i.id]}"daughter"===n||"son"===n?function(e){e.data.other_parent&&(!function(n){"_new"===n&&(n=r().id);const a=t.find(e=>e.id===n);e.rels["M"===a.data.gender?"father":"mother"]=a.id,a.rels.hasOwnProperty("children")||(a.rels.children=[]);function r(){const e=_({rel_type:"spouse",rel_datum:i});return s(e),y({data_stash:t,datum:e}),e}a.rels.children.push(e.id)}(e.data.other_parent),delete e.data.other_parent);e.rels["M"===i.data.gender?"father":"mother"]=i.id,i.rels.children||(i.rels.children=[]);i.rels.children.push(e.id)}(e):"father"===n||"mother"===n?function(e){const n="M"===e.data.gender,s=i.rels[n?"father":"mother"];s&&p(t.find(e=>e.id===s),t);i.rels[n?"father":"mother"]=e.id,function(){const s=i.rels[n?"mother":"father"];if(!s)return;const a=t.find(e=>e.id===s);e.rels.spouses=[s],a.rels.spouses||(a.rels.spouses=[]),a.rels.spouses.push(e.id)}(),e.rels.children=[i.id]}(e):"spouse"===n&&s(e)}function g({data:e,rels:t}){return{id:(n=(new Date).getTime(),i=performance&&performance.now&&1e3*performance.now()||0,"xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx".replace(/[xy]/g,function(e){var t=16*Math.random();return n>0?(t=(n+t)%16|0,n=Math.floor(n/16)):(t=(i+t)%16|0,i=Math.floor(i/16)),("x"===e?t:3&t|8).toString(16)})),data:e||{},rels:t||{}};var n,i}function _({data:e,rel_type:t,rel_datum:n}){const i=function(e,t){return["daughter","mother"].includes(t)||"spouse"===t&&"M"===e.data.gender?"F":"M"}(n,t);return g({data:e=Object.assign(e||{},{gender:i})})}function y({data_stash:e,datum:t}){e.push(t)}function v({data:e,version:t}){return{data:[g({data:e})],version:t}}function b({amount:e,svg:n,transition_time:i=500}){const s=n.__zoomObj?n:n.parentNode,a=s.__zoomObj;t.select(s).transition().duration(i||0).delay(i?100:0).call(a.scaleBy,e)}function w(e,t){const n=e.data.rels;return[n.father,n.mother,...n.spouses||[],...n.children||[]].filter(e=>e).every(e=>t.some(t=>t.data.id===e))}function x(e,t,n=!0){const i=[];function s(e,t){return e.every(e=>t.some(t=>e.id===t.id))}function a(e){const t={},n=e;return(e.children||[]).forEach(e=>{const i=e.data.rels,s=i.father===n.data.id?i.mother:i.father;t[s]||(t[s]=[]),t[s].push(e)}),t}!function r(o){if(!o.children)return;const l=o.data,d=(o.data.rels.spouses||[]).map(e=>t.find(t=>t.id===e)),c=a(o);d.forEach(d=>{if(i.some(e=>e.some(e=>s([l,d],[e.p1,e.p2]))))return;const h=function(n,i,r){const o=[];return l(e),o;function l(e){if(e!==n&&e.children){const n=e.data,d=(e.data.rels.spouses||[]).map(e=>t.find(t=>t.id===e)),c=a(e);d.forEach(t=>{s([i,r],[n,t])?o.push({d:e,p1:n,p2:t}):(c[t.id]||[]).forEach(e=>{l(e)})})}}}(o,l,d);if(h.length>0){const t=[{d:o,p1:l,p2:d},...h];i.push(t),function(t){if(t.forEach(({d:n,p1:i,p2:s},a)=>{n.data._tgdp_sp||(n.data._tgdp_sp={});let r=e===n?"main":n.parent.data.id;!function(e,t,n){e.data.__tgdp_sp&&e.data.__tgdp_sp[t]&&e.data.__tgdp_sp[t].hasOwnProperty(n.id)&&(e.data._tgdp_sp[t][n.id]=e.data.__tgdp_sp[t][n.id],delete e.data.__tgdp_sp[t][n.id])}(n,r,s),n.data._tgdp_sp[r]||(n.data._tgdp_sp[r]={});let o=1;n.data._tgdp_sp[r].hasOwnProperty(s.id)?o=n.data._tgdp_sp[r][s.id]:n.data._tgdp_sp[r][s.id]=o,t[a].val=o}),n){if(t.every(e=>e.val<0)){const n=t.sort((e,t)=>t.val-e.val)[0],{d:i,p1:s,p2:a}=n,r=e===i?"main":i.parent.data.id;i.data._tgdp_sp[r][a.id]=1}if(t.filter(e=>e.val>0).length>1){const n=t.sort((e,t)=>t.val-e.val)[0];t.forEach(t=>{if(t===n)return;const{d:i,p1:s,p2:a}=t,r=e===i?"main":i.parent.data.id;i.data._tgdp_sp[r][a.id]=-1})}}}(t),function(t){t.forEach(({d:t,p1:n,p2:i})=>{const s=e===t?"main":t.parent.data.id;if(t.data._tgdp_sp[s][i.id]<0){const e=a(t);e[i.id]&&(t.children=t.children.filter(t=>!e[i.id].includes(t)),0===t.children.length&&delete t.children)}})}(t)}else{let t=e===o?"main":o.parent.data.id;!function(e,t,n){e.data._tgdp_sp&&e.data._tgdp_sp[t]&&e.data._tgdp_sp[t].hasOwnProperty(n.id)&&(e.data.__tgdp_sp||(e.data.__tgdp_sp={}),e.data.__tgdp_sp[t]||(e.data.__tgdp_sp[t]={}),e.data.__tgdp_sp[t][n.id]=e.data._tgdp_sp[t][n.id],delete e.data._tgdp_sp[t][n.id])}(o,t,d),(c[d.id]||[]).forEach(e=>{r(e)})}})}(e),function(e){let t=0;e.forEach(e=>{t+=1,e.forEach(e=>{e.d._toggle_id_sp||(e.d._toggle_id_sp={}),e.d._toggle_id_sp[e.p2.id]=t})})}(i)}function $(e,t=!0){const n=[];!function i(s){if(s.children){if(n.some(e=>e.includes(s)))return;const a=function(t){const n=[];return i(e),n;function i(e){var s,a;e.children&&(s=t,a=e.children,s!==a&&s.every(e=>a.some(t=>e.data.id===t.data.id))?n.push(e):e.children.forEach(e=>{i(e)}))}}(s.children);if(a.length>0){const i=[s,...a];n.push(i),function(n){if(n.forEach(t=>{t.data._tgdp||(t.data._tgdp={});const n=e===t?"main":t.parent.data.id;t.data._tgdp[n]||(t.data._tgdp[n]=-1),t._toggle=t.data._tgdp[n]}),t){if(n.every(e=>e._toggle<0)){const t=n.sort((e,t)=>t._toggle-e._toggle)[0],i=e===t?"main":t.parent.data.id;t.data._tgdp[i]=1}if(n.filter(e=>e._toggle>0).length>1){const t=n.sort((e,t)=>t._toggle-e._toggle)[0];n.forEach(n=>{if(n===t)return;const i=n,s=e===i?"main":i.parent.data.id;i.data._tgdp[s]=-1})}}}(i),function(t){t.forEach(t=>{const n=e===t?"main":t.parent.data.id;t.data._tgdp[n]<0&&delete t.children})}(i)}else s.children.forEach(e=>{i(e)})}}(e),function(e){let t=0;e.forEach(e=>{t+=1,e.forEach(e=>{e._toggle_id=t})})}(n)}function C({data:e,main_id:i=null,node_separation:s=250,level_separation:r=150,single_parent_empty_card:o=!0,is_horizontal:l=!1,one_level_rels:d=!1,sortChildrenFunction:c,sortSpousesFunction:h,ancestry_depth:u,progeny_depth:p,show_siblings_of_main:f=!1,modifyTreeHierarchy:m,private_cards_config:_,duplicate_branch_toggle:y=!1,on_toggle_one_close_others:v=!0}){if(!e||!e.length)return{data:[],data_stash:[],dim:{width:0,height:0},main_id:null};l&&([s,r]=[r,s]);const b=o?function(e){const t=[];for(let t=0;t<e.length;t++){const i=e[t];if(i.rels.children&&i.rels.children.length>0){i.rels.spouses||(i.rels.spouses=[]);const t="M"===i.data.gender;let s;i.rels.children.forEach(a=>{const r=e.find(e=>e.id===a);r.rels[t?"father":"mother"]===i.id&&(r.rels[t?"mother":"father"]||(s||(s=n(i)),s.rels.children.push(r.id),r.rels[t?"mother":"father"]=s.id))})}}return t.forEach(t=>e.push(t)),e;function n(n){return n.rels.spouses.map(t=>e.find(e=>e.id===t)).find(e=>e.to_add)||function(e){const n=g({data:{gender:"M"===e.data.gender?"F":"M"},rels:{spouses:[e.id],children:[]}});return n.to_add=!0,t.push(n),e.rels.spouses.push(n.id),n}(n)}}(e):e,C=null!==i&&b.find(e=>e.id===i)||b[0],S=M(C,"children",!1),k=M(C,"parents",!0);b.forEach(e=>e.main=e===C),function(e,t){const n=(e[0].x-t[0].x)/2;e.forEach(e=>e.x-=n),t.forEach(e=>e.x+=n)}(k,S);const E=(D=S,(I=k).forEach(e=>{e.is_ancestry=!0}),I.forEach(e=>1===e.depth?e.parent=D[0]:null),[...D,...I.slice(1)]);var I,D;!function({tree:e}){e.forEach(t=>{delete t.children,e.forEach(e=>{e.parent===t&&(e.is_ancestry?(t.parents||(t.parents=[]),t.parents.push(e)):(t.children||(t.children=[]),t.children.push(e)))})})}({tree:E}),function({tree:e,node_separation:t}){for(let n=e.length;n--;){const i=e[n];if(!i.is_ancestry&&i.data.rels.spouses&&i.data.rels.spouses.length>0){if(d&&i.depth>0)continue;const n="M"===i.data.data.gender?-1:1;i.x+=i.data.rels.spouses.length/2*t*n,i.data.rels.spouses.forEach((s,a)=>{const r={data:b.find(e=>e.id===s),added:!0};r.x=i.x-t*(a+1)*n,r.y=i.y,r.sx=a>0?r.x:r.x+t/2*n,r.sy=a>0?r.y:r.y+t/2*n,r.depth=i.depth,r.spouse=i,i.spouses||(i.spouses=[]),i.spouses.push(r),e.push(r)})}if(i.parents&&2===i.parents.length){const e=i.parents[0],n=i.parents[1],s=e.x-(e.x-n.x)/2,a=(e,n)=>s+t/2*(e.x<n.x?1:-1);n.x=a(e,n),e.x=a(n,e)}}}({tree:E,node_separation:s}),f&&!d&&function({tree:e,data_stash:n,node_separation:i,sortChildrenFunction:s}){const a=e.find(e=>e.data.main),r=a.data.rels.father,o=a.data.rels.mother,l=n.filter(e=>!(e.id===a.data.id||!(r&&e.rels.father===r||o&&e.rels.mother===o))),d=function(){const t=[];for(let n=0;n<l.length;n++){const i={data:l[n],sibling:!0,parents:[]},s=a.parents.find(e=>e.data.id===i.data.rels.father),r=a.parents.find(e=>e.data.id===i.data.rels.mother);s&&i.parents.push(s),r&&i.parents.push(r),i.x=void 0,i.y=a.y,i.depth=a.depth-1,e.push(i),t.push(i)}return t}();!function(){const e=[a,...d];s&&e.sort((e,t)=>s(e.data,t.data)),e.sort((e,t)=>{const n=a.parents.find(t=>t.data.id===e.data.rels.father),i=a.parents.find(t=>t.data.id===e.data.rels.mother),s=a.parents.find(e=>e.data.id===t.data.rels.father),r=a.parents.find(e=>e.data.id===t.data.rels.mother);return!i&&r?-1:i&&!r||!n&&s?1:n&&!s?-1:0});const n=a.x,r=(a.spouses||[]).map(e=>e.x),o=t.extent([n,...r]),l=e.findIndex(e=>e.data.id===a.data.id);for(let t=0;t<e.length;t++){if(t===l)continue;e[t].x=t<l?o[0]-i*(l-t):o[1]+i*(t-l)}}()}({tree:E,data_stash:b,node_separation:s,sortChildrenFunction:c}),function({tree:e}){e.forEach(e=>{if(e.is_ancestry)return;if(0===e.depth)return;if(e.added)return;if(e.sibling)return;const t=e.parent,n=(t.spouses||[]).find(t=>t.data.id===e.data.rels.father||t.data.id===e.data.rels.mother);if(t&&n){t.added||n.added||console.error("no added spouse",t,n);const s=t.added?t:n;i(e,s)}else if(t||n){const s=t||n;s.sx=s.x,s.sy=s.y,i(e,s)}function i(e,t){e.psx=l?t.y:t.sx,e.psy=l?t.sx:t.y}})}({tree:E}),function({tree:e}){e.forEach(e=>{if(e.y*=e.is_ancestry?-1:1,l){const t=e.x;e.x=e.y,e.y=t}})}({tree:E}),E.forEach(e=>e.all_rels_displayed=w(e,E)),_&&a({tree:E,data_stash:b,private_cards_config:_}),function({tree:e}){const t=[];e.forEach(n=>{if(t.includes(n.data.id)){const i=e.filter(e=>e.data.id===n.data.id);i.forEach((e,s)=>{e.tid=`${n.data.id}--x${s+1}`,e.duplicate=i.length,t.push(n.data.id)})}else n.tid=n.data.id,t.push(n.data.id)})}({tree:E}),function(e){e.forEach(e=>{if(e.data.main)e.from=[],e.to=[],e.to_ancestry=e.parents;else if(e.is_ancestry)e.from=[e.parent],e.to=e.parents;else{if(e.added)return e.from=[],e.from_spouse=e.spouse,void(e.to=[]);if(e.sibling)return;const t=e.parent,n=(e.parent.spouses||[]).find(t=>t.data.id===e.data.rels.father||t.data.id===e.data.rels.mother);e.from=[t],n&&e.from.push(n),t.to||(t.to=[]),t.to.push(e),n&&(n.to||(n.to=[]),n.to.push(e))}})}(E),y&&function(e){e.forEach(e=>{if(!e.spouse)return;const t=e.spouse;if(e.duplicate&&t.data._tgdp_sp){const n=t.data.main?"main":t.parent.data.id;t.data._tgdp_sp[n]?.hasOwnProperty(e.data.id)&&(e._toggle=t.data._tgdp_sp[n][e.data.id])}})}(E);const F=function(e,n,i){l&&([n,i]=[i,n]);const s=t.extent(e,e=>e.x),a=t.extent(e,e=>e.y);return{width:s[1]-s[0]+n,height:a[1]-a[0]+i,x_off:-s[0]+n/2,y_off:-a[0]+i/2}}(E,s,r);return{data:E,data_stash:b,dim:F,main_id:C.id,is_horizontal:l};function M(e,i,a){const o="children"===i?function(e){const t=[...e.rels.children||[]].map(e=>b.find(t=>t.id===e));c&&t.sort(c);(function(e){e.sort((e,t)=>{const n=e._new_rel_data,i=t._new_rel_data;return n&&!i?1:!n&&i?-1:0})})(t),h&&h(e,b);return function(e,t,i){if(!t.rels.children)return;const s=t.rels.spouses||[];e.sort((e,a)=>{const r=n(e,t,i)||{},o=n(a,t,i)||{},l=s.indexOf(r.id),d=s.indexOf(o.id);return"M"===t.data.gender?l-d:d-l})}(t,e,b),t}:function(e){return[e.rels.father,e.rels.mother].filter(e=>e).map(e=>b.find(t=>t.id===e))},l=t.tree().nodeSize([s,r]).separation(function(e,t){let n=1;a||(g(e,t)||(n+=.25),d||function(e,t){return _(e)||_(t)}(e,t)&&(n+=function(e,t){return.5*((e.data.rels.spouses||[]).length+(t.data.rels.spouses||[]).length)}(e,t)),g(e,t)&&!function(e,t){return e.data.rels.father===t.data.rels.father&&e.data.rels.mother===t.data.rels.mother}(e,t)&&(n+=.125));return n}),f=t.hierarchy(e,o);return a&&function(e){function t(e){e.children&&2===e.children.length&&(e.children[0]._spouse=e.children[1],e.children[1]._spouse=e.children[0]),e.children&&e.children.forEach(e=>t(e))}t(e)}(f),function(e,t){let n=t?u:p;d&&(n=1);return n||0===n?(i(e,0),e):e;function i(e,t){t===n?e.children&&delete e.children:e.children&&e.children.forEach(e=>{i(e,t+1)})}}(f,a),y&&function(e,t,n){n?$(e,v):x(e,t,v)}(f,b,a),m&&m(f,a),l(f),f.descendants();function g(e,t){return e.parent==t.parent}function _(e){return e.data.rels.spouses&&e.data.rels.spouses.length>0}}}function S({t:e,svg:n,transition_time:i=2e3}){const s=n.__zoomObj?n:n.parentNode,a=s.__zoomObj;t.select(s).transition().duration(i||0).delay(i?100:0).call(a.transform,t.zoomIdentity.scale(e.k).translate(e.x,e.y))}function k({svg:e,svg_dim:t,tree_dim:n,with_transition:i,transition_time:s}){S({t:E(t,n),svg:e,transition_time:s})}function E(e,t){let n=Math.min(e.width/t.width,e.height/t.height);n>1&&(n=1);return{k:n,x:t.x_off+(e.width-t.width*n)/n/2,y:t.y_off+(e.height-t.height*n)/n/2}}function I({datum:e,svg:t,svg_dim:n,scale:i,transition_time:s}){const a=i||1;S({t:{k:a,x:(n.width/2-e.x*a)/a,y:(n.height/2-e.y)/a},svg:t,transition_time:s})}function D(e,n){const i=t.line().curve(t.curveMonotoneY),s=t.line().curve(t.curveBasis),a=n?e._d():e.d;return e.curve?!0===e.curve?s(a):void 0:i(a)}function F(e,n){const i=t.select(e).selectAll("div.card_cont_2fake").data(n,e=>e.data.id),s=i.exit(),a=i.enter().append("div").attr("class","card_cont_2fake").style("display","none").attr("data-id",()=>Math.random()),r=a.merge(i);s.each(function(e){e.unique_id=t.select(this).attr("data-id"),t.select(this).remove()}),a.each(function(e){e.unique_id=t.select(this).attr("data-id")}),r.each(function(e){e.unique_id=t.select(this).attr("data-id")})}function M(e){t.select(e()).append("div").attr("class","cards_view_fake").style("display","none")}function A(e){return t.select(e()).select("div.cards_view_fake").node()}var R=Object.freeze({__proto__:null,assignUniqueIdToTreeData:F,createHtmlSvg:function(e){const n=t.select(e).select("#f3Canvas").append("div").attr("id","htmlSvg").attr("style","position: absolute; width: 100%; height: 100%; z-index: 2; top: 0; left: 0");return n.append("div").attr("class","cards_view").style("transform-origin","0 0"),M(()=>n.node()),n.node()},getCardsViewFake:A,getUniqueId:function(e){return e.unique_id},onZoomSetup:function(e,n){return function(i){const s=i.transform;t.select(e()).style("transform",`translate(${s.x}px, ${s.y}px) scale(${s.k}) `),t.select(n()).style("transform",`translate(${s.x}px, ${s.y}px) scale(${s.k}) `)}},setupHtmlSvg:M,setupReactiveTreeData:function(e){let t=[];return function(n){const i=function(e,t){return t.length>0?t.filter(t=>!e.find(e=>e.data.id===t.data.id)):[]}(n,t);return t=[...n,...i],F(A(e),t),t}}});function P(e,t,n){const i=.4*n,s=Math.max(...e.data.map(e=>e.is_ancestry?e.depth:0));let a=t.depth*i;return 0===t.depth&&!t.spouse||t.is_ancestry||(a+=s*i,t.spouse&&(a+=i),a+=t.depth*i),a}function L(e,{d:t}){var n,i;return n=e.getTree().data,i=!1,n.forEach(e=>{e.data.hide_rels=i,s(e,i)}),e.updateMainId(t.data.id),e.updateTree({tree_position:e.state.tree_fit_on_change}),!0}function T(e,{d:t,cardEditForm:n}){const i=t.data;n({datum:i,postSubmit:t=>{i.to_add&&u(i,e.getData()),t&&t.delete&&(i.main&&e.updateMainId(null),f(i,e.getData())),e.updateTree()},store:e})}function H(e,{d:t}){t.data.hide_rels=!t.data.hide_rels,s(t,t.data.hide_rels),e.updateTree({tree_position:e.state.tree_fit_on_change})}function O(){return`\n    <g data-icon="user">\n      ${_e()}\n      <path d="M12,4A4,4 0 0,1 16,8A4,4 0 0,1 12,12A4,4 0 0,1 8,8A4,4 0 0,1 12,4M12,14C16.42,14 20,15.79 20,18V20H4V18C4,15.79 7.58,14 12,14Z" />\n    </g>\n  `}function q(){return`\n    <g data-icon="user-edit">\n      ${_e()}\n      <path d="M21.7,13.35L20.7,14.35L18.65,12.3L19.65,11.3C19.86,11.09 20.21,11.09 20.42,11.3L21.7,12.58C21.91,\n      12.79 21.91,13.14 21.7,13.35M12,18.94L18.06,12.88L20.11,14.93L14.06,21H12V18.94M12,14C7.58,14 4,15.79 4,\n      18V20H10V18.11L14,14.11C13.34,14.03 12.67,14 12,14M12,4A4,4 0 0,0 8,8A4,4 0 0,0 12,12A4,4 0 0,0 16,8A4,4 0 0,0 12,4Z" />\n    </g>\n  `}function N(){return`\n    <g data-icon="user-plus">\n      ${_e()}\n      <path d="M15,14C12.33,14 7,15.33 7,18V20H23V18C23,15.33 17.67,14 15,14M6,10V7H4V10H1V12H4V15H6V12H9V10M15,12A4,4 0 0,0 19,8A4,4 0 0,0 15,4A4,4 0 0,0 11,8A4,4 0 0,0 15,12Z" />\n    </g>\n  `}function U(){return`\n    <g data-icon="user-plus-close">\n      ${_e()}\n      <path d="M15,14C12.33,14 7,15.33 7,18V20H23V18C23,15.33 17.67,14 15,14M6,10V7H4V10H1V12H4V15H6V12H9V10M15,12A4,4 0 0,0 19,8A4,4 0 0,0 15,4A4,4 0 0,0 11,8A4,4 0 0,0 15,12Z" />\n      <line x1="3" y1="3" x2="24" y2="24" stroke="currentColor" stroke-width="2" />\n    </g>\n  `}function j(){return`\n    <g data-icon="plus">\n      ${_e()}\n      <path d="M19,13H13V19H11V13H5V11H11V5H13V11H19V13Z" />\n    </g>\n  `}function V(){return`\n    <g data-icon="pencil">\n      ${_e()}\n      <path d="M20.71,7.04C21.1,6.65 21.1,6 20.71,5.63L18.37,3.29C18,2.9 17.35,2.9 16.96,3.29L15.12,5.12L18.87,8.87M3,17.25V21H6.75L17.81,9.93L14.06,6.18L3,17.25Z" />\n    </g>\n  `}function z(){return`\n    <g data-icon="pencil-off">\n      ${_e()}\n      <path d="M18.66,2C18.4,2 18.16,2.09 17.97,2.28L16.13,4.13L19.88,7.88L21.72,6.03C22.11,5.64 22.11,5 21.72,4.63L19.38,2.28C19.18,2.09 18.91,2 18.66,2M3.28,4L2,5.28L8.5,11.75L4,16.25V20H7.75L12.25,15.5L18.72,22L20,20.72L13.5,14.25L9.75,10.5L3.28,4M15.06,5.19L11.03,9.22L14.78,12.97L18.81,8.94L15.06,5.19Z" />\n    </g>\n  `}function B(){return`\n    <g data-icon="trash">\n      ${_e()}\n      <path d="M6,19A2,2 0 0,0 8,21H16A2,2 0 0,0 18,19V7H6V19M8,9H16V19H8V9M15.5,4L14.5,3H9.5L8.5,4H5V6H19V4H15.5Z" />\n    </g>\n  `}function J(){return`\n    <g data-icon="history-back">\n      ${_e()}\n      <path d="M20 13.5C20 17.09 17.09 20 13.5 20H6V18H13.5C16 18 18 16 18 13.5S16 9 13.5 9H7.83L10.91 12.09L9.5 13.5L4 8L9.5 2.5L10.92 3.91L7.83 7H13.5C17.09 7 20 9.91 20 13.5Z" />\n    </g>\n  `}function W(){return`\n    <g data-icon="history-forward">\n      ${_e()}\n      <path d="M10.5 18H18V20H10.5C6.91 20 4 17.09 4 13.5S6.91 7 10.5 7H16.17L13.08 3.91L14.5 2.5L20 8L14.5 13.5L13.09 12.09L16.17 9H10.5C8 9 6 11 6 13.5S8 18 10.5 18Z" />\n    </g>\n  `}function K(){return'\n    <g data-icon="person">\n      <path d="M256 288c79.5 0 144-64.5 144-144S335.5 0 256 0 112 \n        64.5 112 144s64.5 144 144 144zm128 32h-55.1c-22.2 10.2-46.9 16-72.9 16s-50.6-5.8-72.9-16H128C57.3 320 0 377.3 \n        0 448v16c0 26.5 21.5 48 48 48h416c26.5 0 48-21.5 48-48v-16c0-70.7-57.3-128-128-128z" />\n    </g>\n  '}function Z(){return'\n    <g transform="translate(31,25)" data-icon="mini-tree">\n      <rect x="-31" y="-25" width="72" height="15" fill="rgba(0,0,0,0)"></rect>\n      <g>\n        <rect x="-31" y="-25" width="72" height="15" fill="rgba(0,0,0,0)"></rect>\n        <line y2="-17.5" stroke="#fff" />\n        <line x1="-20" x2="20" y1="-17.5" y2="-17.5" stroke="#fff" />\n        <rect x="-31" y="-25" width="25" height="15" rx="5" ry="5" class="card-male" />\n        <rect x="6" y="-25" width="25" height="15" rx="5" ry="5" class="card-female" />\n      </g>\n    </g>\n  '}function Q(){return`\n    <g data-icon="toggle-on">\n      ${_e()}\n      <circle class="f3-small-circle" r="4" cx="18" cy="12" />\n      <path d="M17,7H7A5,5 0 0,0 2,12A5,5 0 0,0 7,17H17A5,5 0 0,0 22,12A5,5 0 0,0 17,7M17,15A3,3 0 0,1 14,12A3,3 0 0,1 17,9A3,3 0 0,1 20,12A3,3 0 0,1 17,15Z" />\n    </g>\n  `}function G(){return`\n    <g data-icon="toggle-off">\n      ${_e()}\n      <circle class="f3-small-circle" r="4" cx="6" cy="12" />\n      <path d="M17,7H7A5,5 0 0,0 2,12A5,5 0 0,0 7,17H17A5,5 0 0,0 22,12A5,5 0 0,0 17,7M7,15A3,3 0 0,1 4,12A3,3 0 0,1 7,9A3,3 0 0,1 10,12A3,3 0 0,1 7,15Z" />\n    </g>\n  `}function Y(){return`\n    <g data-icon="chevron-down">\n      ${_e()}\n      <path d="M7.41,8.58L12,13.17L16.59,8.58L18,10L12,16L6,10L7.41,8.58Z" />\n    </g>\n  `}function X(){return`\n    <g data-icon="chevron-up">\n      ${_e()}\n      <path d="M7.41,15.41L12,10.83L16.59,15.41L18,14L12,8L6,14L7.41,15.41Z" />\n    </g>\n  `}function ee(){return`\n    <g data-icon="link-off">\n      ${_e()}\n      <path d="M17,7H13V8.9H17C18.71,8.9 20.1,10.29 20.1,12C20.1,13.43 19.12,14.63 17.79,15L19.25,16.44C20.88,15.61 22,13.95 \n      22,12A5,5 0 0,0 17,7M16,11H13.81L15.81,13H16V11M2,4.27L5.11,7.38C3.29,8.12 2,9.91 2,12A5,5 0 0,0 7,17H11V15.1H7C5.29,15.1 \n      3.9,13.71 3.9,12C3.9,10.41 5.11,9.1 6.66,8.93L8.73,11H8V13H10.73L13,15.27V17H14.73L18.74,21L20,19.74L3.27,3L2,4.27Z" />\n    </g>\n  `}function te(){return`\n    <g data-icon="info">\n      ${_e()}\n      <path d="M13,9H11V7H13M13,17H11V11H13M12,2A10,10 0 0,0 2,12A10,10 0 0,0 12,22A10,10 0 0,0 22,12A10,10 0 0,0 12,2Z" />\n    </g>\n  `}function ne(){return ge(N())}function ie(){return ge(U())}function se(){return ge(j())}function ae(){return ge(V())}function re(){return ge(z())}function oe(){return ge(J())}function le(){return ge(W())}function de(){return ge('\n    <g data-icon="person">\n      <path d="M256 288c79.5 0 144-64.5 144-144S335.5 0 256 0 112 \n        64.5 112 144s64.5 144 144 144zm128 32h-55.1c-22.2 10.2-46.9 16-72.9 16s-50.6-5.8-72.9-16H128C57.3 320 0 377.3 \n        0 448v16c0 26.5 21.5 48 48 48h416c26.5 0 48-21.5 48-48v-16c0-70.7-57.3-128-128-128z" />\n    </g>\n  ',"0 0 512 512")}function ce(){return ge('\n    <g transform="translate(31,25)" data-icon="mini-tree">\n      <rect x="-31" y="-25" width="72" height="15" fill="rgba(0,0,0,0)"></rect>\n      <g>\n        <rect x="-31" y="-25" width="72" height="15" fill="rgba(0,0,0,0)"></rect>\n        <line y2="-17.5" stroke="#fff" />\n        <line x1="-20" x2="20" y1="-17.5" y2="-17.5" stroke="#fff" />\n        <rect x="-31" y="-25" width="25" height="15" rx="5" ry="5" class="card-male" />\n        <rect x="6" y="-25" width="25" height="15" rx="5" ry="5" class="card-female" />\n      </g>\n    </g>\n  ',"0 0 72 25")}function he(){return ge(Q())}function ue(){return ge(G())}function pe(){return ge(Y())}function fe(){return ge(ee())}function me(){return ge(te())}function ge(e,t="0 0 24 24"){const n=e.match(/data-icon="([^"]+)"/);return`\n    <svg xmlns="http://www.w3.org/2000/svg" viewBox="${t}" style="fill: currentColor" ${n?`data-icon="${n[1]}"`:""}>\n      ${e}\n    </svg>\n  `}function _e(){return'\n    <circle r="12" cx="12" cy="12" style="fill: rgba(0,0,0,0)" />\n  '}var ye=Object.freeze({__proto__:null,chevronDownIcon:Y,chevronDownSvgIcon:pe,chevronUpIcon:X,chevronUpSvgIcon:function(){return ge(X())},historyBackIcon:J,historyBackSvgIcon:oe,historyForwardIcon:W,historyForwardSvgIcon:le,infoIcon:te,infoSvgIcon:me,linkOffIcon:ee,linkOffSvgIcon:fe,miniTreeIcon:Z,miniTreeSvgIcon:ce,pencilIcon:V,pencilOffIcon:z,pencilOffSvgIcon:re,pencilSvgIcon:ae,personIcon:K,personSvgIcon:de,plusIcon:j,plusSvgIcon:se,toggleIconOff:G,toggleIconOn:Q,toggleSvgIconOff:ue,toggleSvgIconOn:he,trashIcon:B,trashSvgIcon:function(){return ge(B())},userEditIcon:q,userEditSvgIcon:function(){return ge(q())},userIcon:O,userPlusCloseIcon:U,userPlusCloseSvgIcon:ie,userPlusIcon:N,userPlusSvgIcon:ne,userSvgIcon:function(){return ge(O())}});var ve=Object.freeze({__proto__:null,addNewPerson:y,addNewPersonAndHandleRels:function({datum:e,data_stash:t,rel_type:n,rel_datum:i}){y({data_stash:t,datum:e}),m({datum:e,data_stash:t,rel_type:n,rel_datum:i})},calculateTreeFit:E,cardChangeMain:L,cardEdit:T,cardShowHideRels:H,cardToMiddle:I,checkIfConnectedToFirstPerson:o,checkIfRelativesConnectedWithoutPerson:r,cleanupDataJson:function(e){return e.forEach(t=>t.to_add?p(t,e):t),e.forEach(e=>{delete e.main,delete e._tgdp,delete e._tgdp_sp,delete e.__tgdp_sp}),e.forEach(e=>{Object.keys(e).forEach(e=>{"_"===e[0]&&console.error("key starts with _",e)})}),e},createForm:function({datum:e,store:t,fields:n,postSubmit:i,addRelative:s,removeRelative:a,deletePerson:r,onCancel:o,editFirst:l,link_existing_rel_config:h,getKinshipInfo:u,onFormCreation:p}){const f={datum_id:e.id,fields:[],onSubmit:function(n){n.preventDefault();new FormData(n.target).forEach((t,n)=>e.data[n]=t),c(e,t.getData()),e.to_add&&delete e.to_add;e.unknown&&delete e.unknown;i()},getKinshipInfo:u,onFormCreation:p};e._new_rel_data||(f.onDelete=function(){r(),i({delete:!0})},f.addRelative=()=>s.activate(e),f.addRelativeCancel=()=>s.onCancel(),f.addRelativeActive=s.is_active,f.removeRelative=()=>a.activate(e),f.removeRelativeCancel=()=>a.onCancel(),f.removeRelativeActive=a.is_active,f.editable=!1),e._new_rel_data&&(f.title=e._new_rel_data.label,f.new_rel=!0,f.editable=!0,f.onCancel=o),(e._new_rel_data||e.to_add||e.unknown)&&h&&(f.linkExistingRelative=function(e,t,n){const i={label:n.label,options:d(e,t).map(e=>({value:e.id,label:n.linkRelLabel(e)})).sort((e,t)=>"string"==typeof e.label&&"string"==typeof t.label?e.label.localeCompare(t.label):e.label<t.label?-1:1),onSelect:g};return i}(e,t.getData(),h)),f.onDelete&&(f.can_delete=!0),l&&(f.editable=!0);const m=(e.rels.children||[]).some(e=>!t.getDatum(e)._new_rel_data);return f.gender_field={id:"gender",type:"switch",label:"Gender",initial_value:e.data.gender,disabled:["father","mother"].some(t=>t===e._new_rel_data?.rel_type)||m,options:[{value:"M",label:"Male"},{value:"F",label:"Female"}]},n.forEach(n=>{"rel_reference"===n.type?function(n){n.getRelLabel||console.error("getRelLabel is not set");"spouse"===n.rel_type&&(e.rels.spouses||[]).forEach(i=>{const s=t.getDatum(i),a=`${n.id}__ref__${i}`;f.fields.push({id:a,type:"rel_reference",label:n.label,rel_id:i,rel_label:n.getRelLabel(s),initial_value:e.data[a]})})}(n):"select"===n.type?function(t){if(!t.optionCreator&&!t.options)return console.error("optionCreator or options is not set for field",t);f.fields.push({id:t.id,type:t.type,label:t.label,initial_value:e.data[t.id],placeholder:t.placeholder,options:t.options||t.optionCreator(e)})}(n):f.fields.push({id:n.id,type:n.type,label:n.label,initial_value:e.data[n.id]})}),f;function g(e){const t=e.target.value;i({link_rel_id:t})}},createHistory:function(e,t,n){let i=[],s=-1;return{changed:function(){s<i.length-1&&(i=i.slice(0,s+1));const n=t();n.main_id=e.getMainId(),i.push(n),s++},back:function(){if(!r())return;s--,o(i[s])},forward:function(){if(!a())return;s++,o(i[s])},canForward:a,canBack:r};function a(){return s<i.length-1}function r(){return s>0}function o(t){const i=e.getMainId();(t=JSON.parse(JSON.stringify(t))).find(e=>e.id===i)||e.updateMainId(t.main_id),e.updateData(t),n()}},createHistoryControls:function(e,n){const i=t.select(e).append("div").attr("class","f3-history-controls");e.insertBefore(i.node(),e.firstChild);const s=i.append("button").attr("class","f3-back-button").on("click",()=>{n.back(),r()}),a=i.append("button").attr("class","f3-forward-button").on("click",()=>{n.forward(),r()});return s.html(oe()),a.html(le()),{back_btn:s.node(),forward_btn:a.node(),updateButtons:r,destroy:function(){n=null,t.select(e).select(".f3-history-controls").remove()}};function r(){s.classed("disabled",!n.canBack()),a.classed("disabled",!n.canForward()),n.canBack()||n.canForward()?i.style("opacity",1).style("pointer-events","auto"):i.style("opacity",0).style("pointer-events","none")}},createNewPerson:g,createNewPersonWithGenderFromRel:_,createTreeDataWithMainNode:v,deletePerson:f,formInfoSetup:function(e,t){const n=document.createElement("div");return i(),n;function i(){const s=function(e){return` \n    <form id="familyForm" class="f3-form ${e.editable?"":"non-editable"}">\n      ${l()}\n      ${e.title?`<h3 class="f3-form-title">${e.title}</h3>`:""}\n      <div style="text-align: right; display: ${e.new_rel?"none":"block"}">\n        ${e.addRelative&&!e.no_edit?i():""}\n        ${e.no_edit?d():s()}\n      </div>\n\n      ${a()}\n\n      ${r()}\n      \n      <div class="f3-form-buttons">\n        <button type="button" class="f3-cancel-btn">Cancel</button>\n        <button type="submit">Submit</button>\n      </div>\n\n      ${e.linkExistingRelative?o():""}\n\n      <hr>\n\n      ${e.onDelete?t():""}\n\n      ${e.removeRelative?n():""}\n    </form>\n  `;function t(){return`\n      <div>\n        <button type="button" class="f3-delete-btn" ${e.can_delete?"":"disabled"}>\n          Delete\n        </button>\n      </div>\n    `}function n(){return`\n      <div>\n        <button type="button" class="f3-remove-relative-btn${e.removeRelativeActive?" active":""}">\n          ${e.removeRelativeActive?"Cancel Remove Relation":"Remove Relation"}\n        </button>\n      </div>\n    `}function i(){return`\n      <span class="f3-add-relative-btn">\n        ${e.addRelativeActive?ie():ne()}\n      </span>\n    `}function s(){return`\n      <span class="f3-edit-btn">\n        ${e.editable?re():ae()}\n      </span>\n    `}function a(){return e.editable?`\n      <div class="f3-radio-group">\n        ${e.gender_field.options.map(t=>`\n          <label>\n            <input type="radio" name="${e.gender_field.id}" \n              value="${t.value}" \n              ${t.value===e.gender_field.initial_value?"checked":""}\n              ${e.gender_field.disabled?"disabled":""}\n            >\n            ${t.label}\n          </label>\n        `).join("")}\n      </div>\n    `:""}function r(){if(!e.editable)return n();let t="";return e.fields.forEach(e=>{"text"===e.type?t+=`\n        <div class="f3-form-field">\n          <label>${e.label}</label>\n          <input type="${e.type}" \n            name="${e.id}" \n            value="${e.initial_value||""}"\n            placeholder="${e.label}">\n        </div>`:"textarea"===e.type?t+=`\n        <div class="f3-form-field">\n          <label>${e.label}</label>\n          <textarea name="${e.id}" \n            placeholder="${e.label}">${e.initial_value||""}</textarea>\n        </div>`:"select"===e.type?t+=`\n        <div class="f3-form-field">\n          <label>${e.label}</label>\n          <select name="${e.id}" value="${e.initial_value||""}">\n            <option value="">${e.placeholder||`Select ${e.label}`}</option>\n            ${e.options.map(t=>`<option ${t.value===e.initial_value?"selected":""} value="${t.value}">${t.label}</option>`).join("")}\n          </select>\n        </div>`:"rel_reference"===e.type&&(t+=`\n        <div class="f3-form-field">\n          <label>${e.label} - <i>${e.rel_label}</i></label>\n          <input type="text" \n            name="${e.id}" \n            value="${e.initial_value||""}"\n            placeholder="${e.label}">\n        </div>`)}),t;function n(){let t="";return e.fields.forEach(e=>{if("rel_reference"===e.type){if(!e.initial_value)return;t+=`\n          <div class="f3-info-field">\n            <span class="f3-info-field-label">${e.label} - <i>${e.rel_label}</i></span>\n            <span class="f3-info-field-value">${e.initial_value||""}</span>\n          </div>`}else if("select"===e.type){if(!e.initial_value)return;t+=`\n          <div class="f3-info-field">\n            <span class="f3-info-field-label">${e.label}</span>\n            <span class="f3-info-field-value">${e.options.find(t=>t.value===e.initial_value)?.label||""}</span>\n          </div>`}else t+=`\n          <div class="f3-info-field">\n            <span class="f3-info-field-label">${e.label}</span>\n            <span class="f3-info-field-value">${e.initial_value||""}</span>\n          </div>`}),t}}function o(){return`\n      <div>\n        <hr>\n        <div class="f3-link-existing-relative">\n          <label>${e.linkExistingRelative.hasOwnProperty("title")?e.linkExistingRelative.title:"Profile already exists?"}</label>\n          <select>\n            <option value="">${e.linkExistingRelative.hasOwnProperty("select_placeholder")?e.linkExistingRelative.select_placeholder:"Select profile"}</option>\n            ${e.linkExistingRelative.options.map(e=>`<option value="${e.value}">${e.label}</option>`).join("")}\n          </select>\n        </div>\n      </div>\n    `}function l(){return'\n      <span class="f3-close-btn">\n        Ã—\n      </span>\n    '}function d(){return'<div style="height: 24px;"></div>'}}(e);return n.innerHTML=s,function(){const s=n.querySelector("form");s.addEventListener("submit",e.onSubmit);s.querySelector(".f3-cancel-btn").addEventListener("click",c);const a=s.querySelector(".f3-edit-btn");a&&a.addEventListener("click",h);const r=s.querySelector(".f3-delete-btn");r&&e.onDelete&&r.addEventListener("click",e.onDelete);const o=s.querySelector(".f3-add-relative-btn");o&&e.addRelative&&o.addEventListener("click",()=>{e.addRelativeActive?e.addRelativeCancel():e.addRelative(),e.addRelativeActive=!e.addRelativeActive,i()});const l=s.querySelector(".f3-remove-relative-btn");l&&e.removeRelative&&l.addEventListener("click",()=>{e.removeRelativeActive?e.removeRelativeCancel():e.removeRelative(),e.removeRelativeActive=!e.removeRelativeActive,i()});s.querySelector(".f3-close-btn").addEventListener("click",t);const d=s.querySelector(".f3-link-existing-relative select");d&&d.addEventListener("change",e.linkExistingRelative.onSelect);e.onFormCreation&&e.onFormCreation({cont:n,form_creator:e});if(e.getKinshipInfo){const t=e.getKinshipInfo();t&&n.appendChild(t)}function c(){e.editable=!1,e.onCancel&&e.onCancel(),i()}function h(){e.editable=!e.editable,i()}}(),n}},getCurrentZoom:function(e){const n=e.__zoomObj?e:e.parentNode;return t.zoomTransform(n)},handleRelsOfNewDatum:m,isAllRelativeDisplayed:w,manualZoom:b,moveToAddToAdded:u,onDeleteSyncRelReference:h,removeToAdd:p,removeToAddFromData:function(e){return e.forEach(t=>t.to_add?p(t,e):t),e},syncRelReference:c,treeFit:k,zoomTo:function(e,n){const i=e.__zoomObj?e:e.parentNode;b({amount:n/t.zoomTransform(i).k,svg:e})}});function be({d:e,card_dim:t,card_display:n}){return{template:`\n    <g class="card-body">\n      <rect width="${t.w}" height="${t.h}" class="card-body-rect" />\n      ${we({d:e,card_dim:t,card_display:n}).template}\n    </g>\n  `}}function we({d:e,card_dim:t,card_display:n}){return{template:`\n    <g>\n      <g class="card-text" clip-path="url(#card_text_clip)">\n        <g transform="translate(${t.text_x}, ${t.text_y})">\n          <text>\n            ${Array.isArray(n)?n.map(t=>`<tspan x="0" dy="14">${t(e.data)}</tspan>`).join("\n"):n(e.data)}\n          </text>\n        </g>\n      </g>\n      <rect width="${t.w-10}" height="${t.h}" style="mask: url(#fade)" class="text-overflow-mask" /> \n    </g>\n  `}}function xe({d:e,card_dim:t,is_new:n}){return{template:`\n    <rect width="${t.w}" height="${t.h}" rx="4" ry="4" class="card-outline ${e.data.main&&!n?"card-main-outline":""} ${n?"card-new-outline":""}" />\n  `}}function $e({x:e,y:t,rt:n,closed:i}){return{template:`\n    <g style="\n          transform: translate(-12.2px, -.5px);\n          cursor: pointer;\n        " \n        fill="currentColor" class="card_break_link${i?" closed":""}"\n      >\n      <g style="transform: translate(${e}px,${t}px)scale(.02)rotate(${n+"deg"})">\n        <rect width="1000" height="700" y="150" style="opacity: 0" />\n        <g class="link_upper">\n          <g>\n            <path d="M616.3,426.4c19,4.5,38.1-7.4,42.6-26.4c4.4-19-7.4-38-26.5-42.5L522.5,332c-18,11.1-53.9,33.4-53.9,33.4l80.4,18.6c-7.8,4.9-19.5,12.1-31.3,19.4L616.3,426.4L616.3,426.4z"/>\n            <path d="M727.4,244.2c-50.2-11.6-100.3,3.3-135.7,35.4c28.6,22.6,64.5,30.2,116.4,51.3l141,32.6c23.9,5.6,56.6,47.2,51.1,71l-4.1,17c-5.6,23.7-47.3,56.4-71.2,51l-143.4-33.2c-66.8-8.6-104.1-16.6-132.9-7.5c17.4,44.9,55.9,80.8,106.5,92.4L800.9,588c81.3,18.8,162.3-31.5,181.2-112.4l4-17c18.8-81.1-31.7-161.8-112.9-180.6L727.4,244.2z"/>\n          </g>\n        </g>\n        <g class="link_lower">\n          <path d="M421.2,384.9l-128,127.6c-13.9,13.8-13.9,36.2,0,50s36.3,13.8,50.2,0.1l136.2-135.8v-36.7l-58.4,58.1V384.9L421.2,384.9z"/>\n          <path d="M204.6,742.8c-17.4,17.3-63.3,17.2-80.6,0.1l-12.3-12.3c-17.3-17.3,0.6-81.2,17.9-98.5l100.2-99.9c12.5-14.9,45.8-40.8,66.1-103.7c-47.7-9.4-98.9,4.2-135.8,40.9L54.2,575c-58.9,58.8-58.9,154,0,212.8L66.6,800c58.9,58.8,154.5,58.8,213.4,0l105.8-105.6c38.4-38.3,51.3-91.9,39.7-141c-44,22.7-89,62.3-116,84.8L204.6,742.8z"/>\n        </g>\n        <g class="link_particles">\n          <path d="M351.9,248.4l-26.5,63.4l80.6,30.1L351.9,248.4z"/>\n          <path d="M529.3,208l-43,26.6l35.4,52.3L529.3,208z"/>\n          <path d="M426.6,158.8l-44-2.9l61.7,134.6L426.6,158.8z"/>\n        </g>\n      </g>\n    </g>\n  `}}function Ce(e,t,n){const i=document.createElementNS("http://www.w3.org/2000/svg","g");i.innerHTML=e,n?t.insertBefore(i,t.firstChild):t.appendChild(i)}const Se={miniTree:function(e,n){if(e.data.to_add)return;const i=n.card_dim;if(e.all_rels_displayed)return;const s=t.create("svg:g").html(function({d:e,card_dim:t}){return{template:`\n    <g class="card_family_tree" style="cursor: pointer">\n      <rect x="-31" y="-25" width="72" height="15" fill="rgba(0,0,0,0)"></rect>\n      <g transform="translate(${.8*t.w},6)scale(.9)">\n        <rect x="-31" y="-25" width="72" height="15" fill="rgba(0,0,0,0)"></rect>\n        <line y2="-17.5" stroke="#fff" />\n        <line x1="-20" x2="20" y1="-17.5" y2="-17.5" stroke="#fff" />\n        <rect x="-31" y="-25" width="25" height="15" rx="5" ry="5" class="card-male" />\n        <rect x="6" y="-25" width="25" height="15" rx="5" ry="5" class="card-female" />\n      </g>\n    </g>\n  `}}({d:e,card_dim:i}).template);return s.on("click",function(t){t.stopPropagation(),n.onMiniTreeClick?n.onMiniTreeClick.call(this,t,e):L(n.store,{d:e})}),s.node()},lineBreak:function(e,n){if(e.data.to_add)return;const i=n.card_dim,s=t.create("svg:g").html(function({d:e,card_dim:t}){let n="",i=e.data.rels,s=e.data._rels||{},a=e.data.hide_rels,r=e=>e.father||e.mother,o=e=>e.children&&e.children.length>0;if((e.is_ancestry||e.data.main)&&(r(i)||r(s))&&(n+=$e({x:t.w/2,y:0,rt:-45,closed:a}).template),!e.is_ancestry&&e.added){const r=e.spouse,l=r.data.rels,d=r.data._rels||{};(o(i)||o(s))&&(o(l)||o(d))&&(n+=$e({x:e.sx-e.x+t.w/2+24.4,y:(e.x!==e.sx?t.h/2:t.h)+1,rt:135,closed:a}).template)}return{template:n}}({d:e,card_dim:i}).template);return s.on("click",t=>{t.stopPropagation(),H(n.store,{d:e})}),s.node()},cardBody:function(e,n){const i=n.cardEditForm?"ADD":"UNKNOWN",s=n.card_dim;let a;e.data.to_add?(a=t.create("svg:g").html(function({d:e,card_dim:t,card_add:n,label:i}){return{template:`\n    <g class="card-body ${n?"card_add":"card-unknown"}">\n      <rect class="card-body-rect" width="${t.w}" height="${t.h}" fill="rgb(59, 85, 96)" />\n      <text transform="translate(${t.w/2}, ${t.h/2})" text-anchor="middle" fill="#fff">\n        <tspan font-size="18" dy="8">${i}</tspan>\n      </text>\n    </g>\n  `}}({d:e,card_dim:s,card_add:n.cardEditForm,label:i}).template),a.on("click",t=>{t.stopPropagation(),T(n.store,{d:e,cardEditForm:n.cardEditForm})})):(a=t.create("svg:g").html(be({d:e,card_dim:s,card_display:n.card_display}).template),a.on("click",function(t){t.stopPropagation(),n.onCardClick?n.onCardClick.call(this,t,e):L(n.store,{d:e})}));return a.node()},cardImage:function(e,n){if(e.data.to_add)return;const i=n.card_dim;return t.create("svg:g").html(function({d:e,image:t,card_dim:n,maleIcon:i,femaleIcon:s}){return{template:`\n    <g style="transform: translate(${n.img_x}px,${n.img_y}px);" class="card_image" clip-path="url(#card_image_clip)">\n      ${t?`<image href="${t}" height="${n.img_h}" width="${n.img_w}" preserveAspectRatio="xMidYMin slice" />`:(e.data.data.gender,e.data.data.gender,`\n      <g class="genderless-icon">\n        <rect height="${n.img_h}" width="${n.img_w}" fill="rgb(59, 85, 96)" />\n        <g transform="scale(${.001616*n.img_w})">\n         <path transform="translate(50,40)" fill="lightgrey" d="M256 288c79.5 0 144-64.5 144-144S335.5 0 256 0 112 \n            64.5 112 144s64.5 144 144 144zm128 32h-55.1c-22.2 10.2-46.9 16-72.9 16s-50.6-5.8-72.9-16H128C57.3 320 0 377.3 \n            0 448v16c0 26.5 21.5 48 48 48h416c26.5 0 48-21.5 48-48v-16c0-70.7-57.3-128-128-128z" />\n        </g>\n      </g>\n    `)}      \n    </g>\n  `}}({d:e,image:e.data.data.avatar||null,card_dim:i,maleIcon:null,femaleIcon:null}).template).node()},cardEdit:function(e,n){if(e.data.to_add)return;const i=n.card_dim,s=t.create("svg:g").html(function({d:e,card_dim:t,x:n,y:i}){return{template:`\n    <g transform="translate(${n||t.w-20},${i||t.h-20})scale(.6)" style="cursor: pointer" class="card_edit pencil_icon">\n      <circle fill="rgba(0,0,0,0)" r="17" cx="8.5" cy="8.5" />\n      <path fill="currentColor" transform="translate(-1.5, -1.5)"\n         d="M19.082,2.123L17.749,0.79c-1.052-1.052-2.766-1.054-3.819,0L1.925,12.794c-0.06,0.06-0.104,0.135-0.127,0.216\n          l-1.778,6.224c-0.05,0.175-0.001,0.363,0.127,0.491c0.095,0.095,0.223,0.146,0.354,0.146c0.046,0,0.092-0.006,0.137-0.02\n          l6.224-1.778c0.082-0.023,0.156-0.066,0.216-0.127L19.082,5.942C20.134,4.89,20.134,3.176,19.082,2.123z M3.076,13.057l9.428-9.428\n          l3.738,3.739l-9.428,9.428L3.076,13.057z M2.566,13.961l3.345,3.344l-4.683,1.339L2.566,13.961z M18.375,5.235L16.95,6.66\n          l-3.738-3.739l1.425-1.425c0.664-0.663,1.741-0.664,2.405,0l1.333,1.333C19.038,3.493,19.038,4.572,18.375,5.235z"/>\n    </g>\n  `}}({card_dim:i,x:i.w-46,y:i.h-20}).template);return s.on("click",t=>{t.stopPropagation(),T(n.store,{d:e,cardEditForm:n.cardEditForm})}),s.node()},cardAdd:function(e,n){if(e.data.to_add)return;const i=n.card_dim,s=t.create("svg:g").html(function({d:e,card_dim:t,x:n,y:i}){return{template:`\n    <g class="card_add_relative">\n      <g transform="translate(${n||t.w/2},${i||t.h})scale(.13)">\n        <circle r="80" cx="40" cy="40" fill="rgba(0,0,0,0)" />\n        <g transform="translate(-10, -8)">\n          <line\n            x1="10" x2="90" y1="50" y2="50"\n            stroke="currentColor" stroke-width="15" stroke-linecap="round"\n          />\n          <line\n            x1="50" x2="50" y1="10" y2="90"\n            stroke="currentColor" stroke-width="15" stroke-linecap="round"\n          />\n        </g>\n      </g>\n    </g>\n  `}}({card_dim:i,x:i.w-26,y:i.h-20}).template);return s.on("click",t=>{t.stopPropagation(),n.addRelative({d:e})}),s.node()}};function ke(e,t,n){e&&(n?t.insertBefore(e,t.firstChild):t.appendChild(e))}function Ee(e,t){function n(e,t,n){const{w:i,h:s}=e,a=t,r=n||[],o=e=>r.includes(e);return`${o("lx")?"M0,0":`M0,${a} Q 0,0 5,0`} ${o("rx")?`H${i}`:`H${i-a} Q ${i},0 ${i},5`} ${o("ry")?`V${s}`:`V${s-a} Q ${i},${s} ${i-a},${s}`} ${o("ly")?"H0":`H${a} Q 0,${s} 0,${s-a}`} z`}e.querySelector("defs#f3CardDef")||e.insertAdjacentHTML("afterbegin",`\n      <defs id="f3CardDef">\n        <linearGradient id="fadeGrad">\n          <stop offset="0.9" stop-color="white" stop-opacity="0"/>\n          <stop offset=".91" stop-color="white" stop-opacity=".5"/>\n          <stop offset="1" stop-color="white" stop-opacity="1"/>\n        </linearGradient>\n        <mask id="fade" maskContentUnits="objectBoundingBox"><rect width="1" height="1" fill="url(#fadeGrad)"/></mask>\n        <clipPath id="card_clip"><path d="${n({w:t.w,h:t.h},5)}"></clipPath>\n        <clipPath id="card_text_clip"><rect width="${t.w-10}" height="${t.h}"></rect></clipPath>\n        <clipPath id="card_image_clip"><path d="M0,0 Q 0,0 0,0 H${t.img_w} V${t.img_h} H0 Q 0,${t.img_h} 0,${t.img_h} z"></clipPath>\n        <clipPath id="card_image_clip_curved"><path d="${n({w:t.img_w,h:t.img_h},5,["rx","ry"])}"></clipPath>\n      </defs>\n    `)}function Ie(e,t){this.cont=e,this.popup_cont=null,this.active=!1,this.onClose=t,this.init()}Ie.prototype.init=function(){this.popup_cont=t.select(this.cont).append("div").attr("class","f3-popup").node(),this.create()},Ie.prototype.create=function(){const e=t.select(this.popup_cont);e.html('\n    <div class="f3-popup-content">\n      <span class="f3-popup-close">&times;</span>\n      <div class="f3-popup-content-inner"></div>\n    </div>\n  '),e.select(".f3-popup-close").on("click",()=>{this.close()}),e.on("click",t=>{t.target==e.node()&&this.close()})},Ie.prototype.activate=function(e){e&&t.select(this.popup_cont).select(".f3-popup-content-inner").node().appendChild(e),this.open()},Ie.prototype.open=function(){this.active=!0},Ie.prototype.close=function(){this.popup_cont.remove(),this.active=!1,this.onClose&&this.onClose()};var De=Object.freeze({__proto__:null,Card:function(e){return Ee((e=function(e){const t={img:!0,mini_tree:!0,link_break:!1,card_dim:{w:220,h:70,text_x:75,text_y:15,img_w:60,img_h:60,img_x:5,img_y:5}};e||(e={});for(const n in t)void 0===e[n]&&(e[n]=t[n]);return e}(e)).svg,e.card_dim),function(n){const i="M"===n.data.data.gender?"card-male":"F"===n.data.data.gender?"card-female":"card-genderless",s=e.card_dim,a=t.create("svg:g").attr("class",`card ${i}`).attr("transform",`translate(${[-s.w/2,-s.h/2]})`);a.append("g").attr("class","card-inner").attr("clip-path","url(#card_clip)"),this.innerHTML="",this.appendChild(a.node()),Ce(xe({d:n,card_dim:s,is_new:n.data.to_add}).template,a.node(),!0),ke(Se.cardBody(n,e),this.querySelector(".card-inner")),e.img&&ke(Se.cardImage(n,e),this.querySelector(".card")),e.mini_tree&&ke(Se.miniTree(n,e),this.querySelector(".card"),!0),e.link_break&&ke(Se.lineBreak(n,e),this.querySelector(".card")),e.cardEditForm&&(ke(Se.cardEdit(n,e),this.querySelector(".card-inner")),ke(Se.cardAdd(n,e),this.querySelector(".card-inner"))),e.onCardUpdates&&e.onCardUpdates.map(e=>e.call(this,n)),e.onCardUpdate&&e.onCardUpdate.call(this,n)}},CardHtml:function(e){const n="default"===e.style?a:"imageCircleRect"===e.style?function(t){return t.data.data[e.cardImageField]?r(t):o(t)}:"imageCircle"===e.style?r:"imageRect"===e.style?function(e){return i(e)}:"rect"===e.style?o:a;return function(i){if(this.innerHTML=`\n    <div class="card ${function(e){const t=[];"M"===e.data.data.gender?t.push("card-male"):"F"===e.data.data.gender?t.push("card-female"):t.push("card-genderless");t.push(`card-depth-${e.is_ancestry?-e.depth:e.depth}`),e.data.main&&t.push("card-main");e.data._new_rel_data&&t.push("card-new-rel");e.data.to_add&&t.push("card-to-add");e.data.unknown&&t.push("card-unknown");return t}(i).join(" ")}" data-id="${i.tid}" style="transform: translate(-50%, -50%); pointer-events: auto;">\n      ${e.mini_tree?function(t){return e.mini_tree?t.data.to_add||t.data._new_rel_data||t.all_rels_displayed?"":`<div class="mini-tree">${ce()}</div>`:""}(i):""}\n      ${e.cardInnerHtmlCreator&&!i.data._new_rel_data?e.cardInnerHtmlCreator(i):n(i)}\n    </div>\n    `,this.querySelector(".card").addEventListener("click",t=>e.onCardClick(t,i)),e.onCardUpdate&&e.onCardUpdate.call(this,i),e.onCardMouseenter&&t.select(this).select(".card").on("mouseenter",t=>e.onCardMouseenter(t,i)),e.onCardMouseleave&&t.select(this).select(".card").on("mouseleave",t=>e.onCardMouseleave(t,i)),i.duplicate&&function(e,n){t.select(e).on("mouseenter",i=>{t.select(e.closest(".cards_view")).selectAll(".card_cont").select(".card").classed("f3-card-duplicate-hover",e=>e.data.id===n.data.id)}),t.select(e).on("mouseleave",n=>{t.select(e.closest(".cards_view")).selectAll(".card_cont").select(".card").classed("f3-card-duplicate-hover",!1)})}(this,i),e.duplicate_branch_toggle&&function(e,n,i,s){if(!n.hasOwnProperty("_toggle"))return;const a=e.querySelector(".card"),r=a.querySelector(".card-inner"),o=e.querySelector(".card").offsetWidth;let l,d;e.querySelector(".card").offsetHeight;const c={};if(n.spouse){const e=n.spouse,t=e.data.main?"main":e.parent.data.id;if(l=e.data._tgdp_sp[t][n.data.id]<0,c.top=60,c.left=n.sx-n.x-30+o/2,i&&(c.top=n.sy-n.x+4,c.left=o/2+4,Math.abs(n.sx-n.y)<10&&(c.left=o-4)),d=e._toggle_id_sp?e._toggle_id_sp[n.data.id]:-1,-1===d)return}else{const e=n.data.main?"main":n.parent.data.id;l=n.data._tgdp[e]<0,c.top=-65,c.left=o/2-30,i&&(c.top=5,c.left=-55),d=n._toggle_id}if(r.style.zIndex=1,t.select(a).append("div").attr("class","f3-toggle-div").attr("style","cursor: pointer; width: 60px; height: 60px;position: absolute; z-index: -1;").style("top",c.top+"px").style("left",c.left+"px").on("click",e=>{if(e.stopPropagation(),n.spouse){const e=n.spouse,t=e.data.main?"main":e.parent.data.id;e.data._tgdp_sp[t].hasOwnProperty(n.data.id)||console.error("no toggle",n,e);let i=e.data._tgdp_sp[t][n.data.id];i=i<0?(new Date).getTime():-(new Date).getTime(),e.data._tgdp_sp[t][n.data.id]=i}else{const e=n.data.main?"main":n.parent.data.id;let t=n.data._tgdp[e];t=t<0?(new Date).getTime():-(new Date).getTime(),n.data._tgdp[e]=t}s()}).append("div").html(l?ue():he()).select("svg").classed("f3-toggle-icon",!0).style("color",l?"#585656":"#61bf52").style("padding","0"),t.select(a).select(".f3-toggle-icon .f3-small-circle").style("fill","#fff"),t.select(a).select(".f3-toggle-icon").append("text").attr("transform",l?"translate(10.6, 14.5)":"translate(4.1, 14.5)").attr("fill","#fff").attr("font-size","7px").text("C"+d),l){let e;e=n.is_ancestry?i?"translate(5, -30)rotate(-90)":"translate(0, -10)":i?"translate(11, -22)rotate(90)":"translate(-7, -32)rotate(180)",t.select(a).select(".f3-toggle-div").insert("div").html(ce()).select("svg").attr("style","position: absolute; z-index: -1;top: 0;left: 0;border-radius: 0;").style("width","66px").style("height","112px").attr("transform",e).attr("viewBox","0 0 72 125").select("line").attr("y1",n.is_ancestry?"62":"92")}}(this,i,e.store.state.is_horizontal,e.store.updateTree),location.origin.includes("localhost")&&(i.__node=this.querySelector(".card"),i.__label=i.data.data["first name"],i.data.to_add)){const e=i.spouse||i._spouse||null;e&&t.select(this).select(".card").attr("data-to-add",e.data.data["first name"])}};function i(t){return`\n    <div class="card-inner card-image-rect" ${l()}>\n      ${t.data.data[e.cardImageField]?`<img src="${t.data.data[e.cardImageField]}" ${d()}>`:c(t)}\n      <div class="card-label">${s(t)}</div>\n      ${t.duplicate?h(t):""}\n    </div>\n    `}function s(t){return t.data._new_rel_data?function(e){const t=[];t.push(`data-rel-type="${e.data._new_rel_data.rel_type}"`),["son","daughter"].includes(e.data._new_rel_data.rel_type)&&t.push(`data-other-parent-id="${e.data._new_rel_data.other_parent_id}"`);return`<div ${t.join(" ")}>${e.data._new_rel_data.label}</div>`}(t):t.data.to_add?`<div>${e.empty_card_label||"ADD"}</div>`:t.data.unknown?`<div>${e.unknown_card_label||"UNKNOWN"}</div>`:`\n      ${e.card_display.map(e=>`<div>${e(t.data)}</div>`).join("")}\n    `}function a(e){return i(e)}function r(t){return function(t){return`\n    <div class="card-inner card-image-circle" ${l()}>\n      ${t.data.data[e.cardImageField]?`<img src="${t.data.data[e.cardImageField]}" ${d()}>`:c(t)}\n      <div class="card-label">${s(t)}</div>\n      ${t.duplicate?h(t):""}\n    </div>\n    `}(t)}function o(e){return function(e){return`\n    <div class="card-inner card-rect" ${l()}>\n      ${s(e)}\n      ${e.duplicate?h(e):""}\n    </div>\n    `}(e)}function l(){let t='style="';return e.card_dim.w||e.card_dim.h?(t+=`width: ${e.card_dim.w}px; min-height: ${e.card_dim.h}px;`,e.card_dim.height_auto?t+="height: auto;":t+=`height: ${e.card_dim.h}px;`,t+='"',t):""}function d(){let t='style="position: relative;';return e.card_dim.img_w||e.card_dim.img_h||e.card_dim.img_x||e.card_dim.img_y?(t+=`width: ${e.card_dim.img_w}px; height: ${e.card_dim.img_h}px;`,t+=`left: ${e.card_dim.img_x}px; top: ${e.card_dim.img_y}px;`,t+='"',t):""}function c(t){return t.data._new_rel_data?`<div class="person-icon" ${d()}>${se()}</div>`:`<div class="person-icon" ${d()}>${e.defaultPersonIcon?e.defaultPersonIcon(t):de()}</div>`}function h(e){return`<div class="f3-card-duplicate-tag">x${e.duplicate}</div>`}},CardSvg:function(e){return Ee((e=function(e){const t={img:!0,mini_tree:!0,link_break:!1,card_dim:{w:220,h:70,text_x:75,text_y:15,img_w:60,img_h:60,img_x:5,img_y:5}};e||(e={});for(const n in t)void 0===e[n]&&(e[n]=t[n]);return e}(e)).svg,e.card_dim),function(n){const i="M"===n.data.data.gender?"card-male":"F"===n.data.data.gender?"card-female":"card-genderless",s=e.card_dim,a=t.create("svg:g").attr("class",`card ${i}`).attr("transform",`translate(${[-s.w/2,-s.h/2]})`);a.append("g").attr("class","card-inner").attr("clip-path","url(#card_clip)"),this.innerHTML="",this.appendChild(a.node()),a.on("click",function(t){t.stopPropagation(),e.onCardClick.call(this,t,n)}),n.data._new_rel_data?(Ce(xe({d:n,card_dim:s,is_new:n.data.to_add}).template,a.node(),!0),Ce(function({d:e,card_dim:t,label:n}){return{template:`\n    <g class="card-body">\n      <rect class="card-body-rect" width="${t.w}" height="${t.h}" />\n      <text transform="translate(${t.img_w+5}, ${t.h/2})">\n        <tspan font-size="18" dy="8" pointer-events="none">${n}</tspan>\n      </text>\n    </g>\n  `}}({d:n,card_dim:s,label:n.data._new_rel_data.label}).template,this.querySelector(".card-inner"),!0),t.select(this.querySelector(".card-inner")).append("g").attr("class","card-edit-icon").attr("fill","currentColor").attr("transform",`translate(-1,2)scale(${s.img_h/22})`).html(j())):(Ce(xe({d:n,card_dim:s,is_new:n.data.to_add}).template,a.node(),!0),Ce(be({d:n,card_dim:s,card_display:e.card_display}).template,this.querySelector(".card-inner")),e.img&&ke(Se.cardImage(n,e),this.querySelector(".card")),e.mini_tree&&ke(Se.miniTree(n,e),this.querySelector(".card"),!0),e.link_break&&ke(Se.lineBreak(n,e),this.querySelector(".card"))),e.onCardUpdate&&e.onCardUpdate.call(this,n)}},appendElement:ke,infoPopup:function(...e){return new Ie(...e)}});function Fe(e,t,n){return this.store=e,this.onActivate=t,this.cancelCallback=n,this.datum=null,this.onChange=null,this.onCancel=null,this.is_active=!1,this.addRelLabels=this.addRelLabelsDefault(),this}Fe.prototype.activate=function(e){this.is_active&&this.onCancel(),this.onActivate(),this.is_active=!0,this.store.state.one_level_rels=!0;const t=this.store;this.datum=e;let n=this.datum.data.gender;!function(e,t,n){if(!e.rels.father){const i=g({data:{gender:"M"},rels:{children:[e.id]}});i._new_rel_data={rel_type:"father",label:n.father,rel_id:e.id},e.rels.father=i.id,t.push(i)}if(!e.rels.mother){const i=g({data:{gender:"F"},rels:{children:[e.id]}});i._new_rel_data={rel_type:"mother",label:n.mother,rel_id:e.id},e.rels.mother=i.id,t.push(i)}const i=t.find(t=>t.id===e.rels.mother),s=t.find(t=>t.id===e.rels.father);i.rels.spouses||(i.rels.spouses=[]);s.rels.spouses||(s.rels.spouses=[]);i.rels.spouses.includes(s.id)||i.rels.spouses.push(s.id);s.rels.spouses.includes(i.id)||s.rels.spouses.push(i.id);i.rels.children||(i.rels.children=[]);s.rels.children||(s.rels.children=[]);i.rels.children.includes(e.id)||i.rels.children.push(e.id);s.rels.children.includes(e.id)||s.rels.children.push(e.id);e.rels.spouses||(e.rels.spouses=[]);if(e.rels.children){let i;e.rels.children.forEach(s=>{const a=t.find(e=>e.id===s);a.rels.mother||(i||(i=g({data:{gender:"F"},rels:{spouses:[e.id],children:[]}})),i._new_rel_data={rel_type:"spouse",label:n.spouse,rel_id:e.id},i.rels.children.push(a.id),e.rels.spouses.push(i.id),a.rels.mother=i.id,t.push(i)),a.rels.father||(i||(i=g({data:{gender:"M"},rels:{spouses:[e.id],children:[]}})),i._new_rel_data={rel_type:"spouse",label:n.spouse,rel_id:e.id},i.rels.children.push(a.id),e.rels.spouses.push(i.id),a.rels.father=i.id,t.push(i))})}const a="M"===e.data.gender?"F":"M",r=g({data:{gender:a},rels:{spouses:[e.id]}});r._new_rel_data={rel_type:"spouse",label:n.spouse,rel_id:e.id},e.rels.spouses.push(r.id),t.push(r),e.rels.children||(e.rels.children=[]);e.rels.spouses.forEach(i=>{const s=t.find(e=>e.id===i),a="M"===e.data.gender?s.id:e.id,r="F"===e.data.gender?s.id:e.id;s.rels.children||(s.rels.children=[]);const o=g({data:{gender:"M"},rels:{father:r,mother:a}});o._new_rel_data={rel_type:"son",label:n.son,other_parent_id:s.id,rel_id:e.id},s.rels.children.push(o.id),e.rels.children.push(o.id),t.push(o);const l=g({data:{gender:"F"},rels:{mother:a,father:r}});l._new_rel_data={rel_type:"daughter",label:n.daughter,other_parent_id:s.id,rel_id:e.id},s.rels.children.push(l.id),e.rels.children.push(l.id),t.push(l)})}(e,this.getStoreData(),this.addRelLabels),t.updateTree({}),this.onChange=function(i,s){i?._new_rel_data?s?.link_rel_id?l(i,s.link_rel_id,t.getData()):delete i._new_rel_data:i.id===e.id?i.data.gender!==n&&function(){n=i.data.gender;t.getData().forEach(e=>{const t=e._new_rel_data;t&&("spouse"===t.rel_type&&(e.data.gender="M"===e.data.gender?"F":"M"),["son","daughter"].includes(t.rel_type)&&([e.rels.father,e.rels.mother]=[e.rels.mother,e.rels.father]))})}():console.error("Something went wrong")}.bind(this),this.onCancel=function(){if(!this.is_active)return;this.is_active=!1,this.store.state.one_level_rels=!1,this.cleanUp(),this.cancelCallback(this.datum),this.datum=null,this.onChange=null,this.onCancel=null}.bind(this)},Fe.prototype.setAddRelLabels=function(e){if("object"==typeof e){for(let t in e)this.addRelLabels[t]=e[t];return this}console.error("add_rel_labels must be an object")},Fe.prototype.addRelLabelsDefault=function(){return{father:"Add Father",mother:"Add Mother",spouse:"Add Spouse",son:"Add Son",daughter:"Add Daughter"}},Fe.prototype.getStoreData=function(){return this.store.getData()},Fe.prototype.cleanUp=function(e){e||(e=this.store.getData());for(let t=e.length-1;t>=0;t--){const n=e[t];n._new_rel_data&&(e.forEach(e=>{e.rels.father===n.id&&delete e.rels.father,e.rels.mother===n.id&&delete e.rels.mother,(e.rels.children||[]).includes(n.id)&&e.rels.children.splice(e.rels.children.indexOf(n.id),1),(e.rels.spouses||[]).includes(n.id)&&e.rels.spouses.splice(e.rels.spouses.indexOf(n.id),1)}),e.splice(t,1))}return e};function Me(e,t,n,i){return this.store=e,this.onActivate=t,this.cancelCallback=n,this.modal=i,this.datum=null,this.onChange=null,this.onCancel=null,this.is_active=!1,this}function Ae(e){this.cont=e,this.modal_cont=null,this.active=!1,this.onClose=null,this.init()}function Re(e,t,n={}){const i=t.find(t=>t.id===e),s={};return function e(n,i,a,r){if(!n)return;s[n]&&s[n]!==i&&console.error("kinship mismatch, kinship 1: ",s[n],"kinship 2: ",i);if(s[n])return;i&&(s[n]=i);const o=t.find(e=>e.id===n),l=o.rels;if("self"===i)e(l.father,"parent",a-1,n),e(l.mother,"parent",a-1,n),(l.spouses||[]).forEach(t=>e(t,"spouse",a)),(l.children||[]).forEach(t=>e(t,"child",a+1));else if("parent"===i)e(l.father,"grandparent",a-1,n),e(l.mother,"grandparent",a-1,n),(l.children||[]).forEach(t=>{r&&r===t||e(t,"sibling",a+1)});else if("spouse"===i);else if("child"===i)(l.children||[]).forEach(t=>e(t,"grandchild",a+1));else if("sibling"===i)(l.children||[]).forEach(t=>e(t,"nephew",a+1));else if("grandparent"===i)r||console.error(`${i} should have prev_rel_id`),e(l.father,"great-grandparent",a-1,n),e(l.mother,"great-grandparent",a-1,n),(l.children||[]).forEach(t=>{r&&r===t||e(t,"uncle",a+1)});else if(i.includes("grandchild"))(l.children||[]).forEach(t=>e(t,Oe(i,a+1),a+1));else if(i.includes("great-grandparent"))r||console.error(`${i} should have prev_rel_id`),e(l.father,Oe(i,a-1),a-1,n),e(l.mother,Oe(i,a-1),a-1,n),(l.children||[]).forEach(t=>{if(r&&r===t)return;const n=He(a+1);0===n?e(t,"granduncle",a+1):n>0?e(t,Oe("granduncle",a+1),a+1):console.error(`${i} should have great_count > -1`)});else if("nephew"===i)(l.children||[]).forEach(t=>e(t,"grandnephew",a+1));else if(i.includes("grandnephew"))(l.children||[]).forEach(t=>e(t,Oe(i,a+1),a+1));else if("uncle"===i)(l.children||[]).forEach(t=>e(t,"1st Cousin",a+1));else if("granduncle"===i)(l.children||[]).forEach(t=>e(t,"1st Cousin 1x removed",a+1));else if(i.includes("great-granduncle")){const t=a+1,n=Math.abs(t);(l.children||[]).forEach(i=>e(i,`1st Cousin ${n}x removed`,t))}else i.slice(4).startsWith("Cousin")?(l.children||[]).forEach(t=>{const n=a+1,s=Math.abs(n),r=+i[0];0===n?e(t,`${Te(r+1)} Cousin`,n):n<0?e(t,`${Te(r+1)} Cousin ${s}x removed`,n):n>0&&e(t,`${Te(r)} Cousin ${s}x removed`,n)}):console.error(`${i} not found`)}(i.id,"self",0),function(e){const n=[];Object.keys(e).forEach(s=>{const a=e[s];if(a.includes("child"))return;if("spouse"===a)return;const r=Pe(i.id,s,t);if(!r)return console.error(`${t.find(e=>e.id===s).data} not found in main_ancestry`);r.is_half_kin&&n.push(s)}),n.forEach(t=>{e[t]=`Half ${e[t]}`})}(s),n.show_in_law&&function(e,t){Object.keys(e).forEach(n=>{const i=e[n],s=t.find(e=>e.id===n);if("spouse"===i){const t=[];s.rels.mother&&(a(s.rels.mother).rels.children||[]).forEach(e=>t.push(e)),s.rels.father&&(a(s.rels.father).rels.children||[]).forEach(e=>t.push(e)),t.forEach(t=>{e[t]||(e[t]="sibling-in-law")})}"child"===i&&(s.rels.spouses||[]).forEach(t=>{e[t]||(e[t]="child-in-law")}),"uncle"===i&&(s.rels.spouses||[]).forEach(t=>{e[t]||(e[t]="uncle-in-law")}),i.includes("Cousin")&&(s.rels.spouses||[]).forEach(t=>{e[t]||(e[t]=`${i} in-law`)})})}(s,t),function(e){Object.keys(e).forEach(n=>{const i=e[n],s=t.find(e=>e.id===n).data.gender;if(i.includes("parent")){const t="M"===s?"father":"F"===s?"mother":"parent";e[n]=e[n].replace("parent",t)}else if(i.includes("sibling")){const t="M"===s?"brother":"F"===s?"sister":"sibling";e[n]=e[n].replace("sibling",t)}else if(i.includes("child")){const t="M"===s?"son":"F"===s?"daughter":"child";e[n]=e[n].replace("child",t)}else if(i.includes("uncle")){const t="M"===s?"uncle":"F"===s?"aunt":"aunt/uncle";e[n]=e[n].replace("uncle",t)}else if(i.includes("nephew")){const t="M"===s?"nephew":"F"===s?"niece":"neice/nephew";e[n]=e[n].replace("nephew",t)}})}(s),s;function a(e){return t.find(t=>t.id===e)}}function Pe(e,t,n){const i=function(e){const t=[];return function e(i){const s=n.find(e=>e.id===i),a=s.rels;t.push(o(a)),a.father&&e(a.father);a.mother&&e(a.mother)}(e),t}(e);let s,a,r;return function(e){const t=n.find(t=>t.id===e);i.find(e=>e[0]===t.id||e[1]===t.id)&&(a=!0,s=e,r=!1)}(t),function(t){(n.find(t=>t.id===e).rels.spouses||[]).includes(t)&&(s=[e,t])}(t),function t(l){if(s)return;if(l===e)return a=!0,s=l,void(r=!1);const d=n.find(e=>e.id===l),c=d.rels,h=o(c),u=i.find(e=>e[0]&&h[0]&&e[0]===h[0]||e[1]&&h[1]&&e[1]===h[1]);if(u)return s=h.filter((e,t)=>e===u[t]),f=u,void(r=(p=h)[0]!==f[0]||p[1]!==f[1]);var p,f;c.father&&t(c.father);c.mother&&t(c.mother)}(t),s?{found:s,is_ancestor:a,is_half_kin:r}:null;function o(e){return[e.father,e.mother]}}function Le(e,n,i,s){let a;const r=s[n].toLowerCase();if(r.includes("in-law")){a=n;const t=i.find(e=>e.id===a);n=r.includes("sister")||r.includes("brother")?e:t.rels.spouses.find(e=>s[e]&&!s[e].includes("in-law"))}const o=Pe(e,n,i);if(!o)return console.error(`${n} not found in main_ancestry`);const l=o.is_ancestor?o.found:o.found[0],d=i.find(e=>e.id===l),c=t.hierarchy(d,function(e){return[...e.rels.children||[]].map(e=>i.find(t=>t.id===e))}),h=c.descendants().map(e=>e.data.id),u=m(e,h),p=m(n,h);!function e(t){t.children=(t.children||[]).filter(e=>!!u.includes(e.data.id)||!!p.includes(e.data.id)),t.children.forEach(t=>e(t)),0===t.children.length&&delete t.children}(c);const f=c.descendants().map(e=>{const t={id:e.data.id,data:JSON.parse(JSON.stringify(e.data.data)),kinship:s[e.data.id],rels:{}};return e.children&&e.children.length>0&&(t.rels.children=e.children.map(e=>e.data.id)),t});return f.length>0&&!o.is_ancestor&&!o.is_half_kin&&function(e){const t=e[0],n=l===o.found[0]?o.found[1]:o.found[0];t.rels.spouses=[n];const a=i.find(e=>e.id===n),r={id:a.id,data:JSON.parse(JSON.stringify(a.data)),kinship:s[a.id],rels:{spouses:[t.id],children:t.rels.children}};e.push(r),(t.rels.children||[]).forEach(t=>{const n=i.find(e=>e.id===t),s=e.find(e=>e.id===t);s.rels.father=n.rels.father,s.rels.mother=n.rels.mother})}(f),a&&function(e){r.includes("sister")||r.includes("brother")?function(e){const t=e.find(e=>e.id===n),i=g(a);e.push({id:a,data:JSON.parse(JSON.stringify(i.data)),kinship:s[a],rels:{spouses:[],children:[]}});const r=[];i.rels.mother&&(g(i.rels.mother).rels.children||[]).forEach(e=>r.push(e));i.rels.father&&(g(i.rels.father).rels.children||[]).forEach(e=>r.push(e));const o=g(n).rels.spouses.find(e=>r.includes(e));t.rels.spouses=[o];const l=g(o),d={id:l.id,data:JSON.parse(JSON.stringify(l.data)),kinship:s[l.id],rels:{spouses:[t.id],children:[]}};if(e.push(d),i.rels.father){const t=g(i.rels.father),n={id:t.id,data:JSON.parse(JSON.stringify(t.data)),kinship:"Father-in-law",rels:{spouses:[],children:[o,a]}};i.rels.mother&&n.rels.spouses.push(i.rels.mother),e.unshift(n)}if(i.rels.mother){const t=g(i.rels.mother),n={id:t.id,data:JSON.parse(JSON.stringify(t.data)),kinship:"Mother-in-law",rels:{spouses:[],children:[o,a]}};i.rels.father&&n.rels.spouses.push(i.rels.father),e.unshift(n)}}(e):function(e){const t=e.find(e=>e.id===n),r=a;t.rels.spouses=[r];const o=i.find(e=>e.id===r),l={id:o.id,data:JSON.parse(JSON.stringify(o.data)),kinship:s[o.id],rels:{spouses:[t.id],children:[]}};e.push(l)}(e)}(f),f;function m(e,t){const n=[e];return function e(s){const a=i.find(e=>e.id===s),r=a.rels;t.includes(r.mother)&&(n.push(r.mother),e(r.mother));t.includes(r.father)&&(n.push(r.father),e(r.father))}(e),n}function g(e){return i.find(t=>t.id===e)}}function Te(e){const t=["st","nd","rd"];return t[e-1]?e+t[e-1]:e+"th"}function He(e){return Math.abs(e)-2}function Oe(e,t){const n=He(t);return e.includes("great-")&&(e=e.split("great-")[1]),1===n?`great-${e}`:n>1?`${n}x-great-${e}`:(console.error(`${e} should have great_count > 1`),e)}function qe(e,n,i){const{self_id:s,getLabel:a,title:r}=e,o=Re(s,i,e),l=o[n];if(!l)return;let d=l;d="self"===l?"You":Ne(d);const c=`\n    <div class="f3-kinship-info">\n      <div class="f3-info-field">\n        <span class="f3-info-field-label">${r}</span>\n        <span class="f3-info-field-value">\n          <span>${d}</span>\n          <span class="f3-kinship-info-icon">${me()}</span>\n        </span>\n      </div>\n    </div>\n  `,h=t.create("div").html(c).select("div").node();let u;return t.select(h).select(".f3-kinship-info-icon").on("click",e=>function(e,r){const l=250,d=400;let c=e.clientX-l-10,h=e.clientY-d-10;c+l>window.innerWidth&&(c=window.innerWidth-l-10);h<0&&(h=10);if(u&&u.active)return u.close(),void(u=null);u=nt.elements.infoPopup(r),t.select(u.popup_cont).style("width",`${l}px`).style("height",`${d}px`).style("left",`${c}px`).style("top",`${h}px`);const p=u.popup_cont.querySelector(".f3-popup-content-inner");u.activate(),function(e,n,i,s,a,r){t.select(a).select("#SmallChart").node()||t.select(a).append("div").attr("id","SmallChart").attr("class","f3");const o=t.select("#SmallChart");o.selectAll("*").remove();const l=Le(e,n,i,s);let d=!0;const c=o.append("div");function h(e){const i=nt.createChart("#SmallChart",e).setTransitionTime(500).setCardXSpacing(170).setCardYSpacing(70).setSingleParentEmptyCard(!1);function s(e){let t="self"===e.data.kinship?"You":e.data.kinship;return t=Ne(t),d||(t=r(e.data)),`\n        <div class="card-inner card-rect ${i()}">\n          <div class="card-label">${t}</div>\n        </div>\n      `;function i(){return"self"===e.data.kinship?"card-kinship-self"+(d?"":" f3-real-label"):e.data.id===n?"card-kinship-rel":"card-kinship-default"}}function a(){c.classed("f3-kinship-labels-toggle",!0),c.append("label").text("Kinship labels").append("input").attr("type","checkbox").attr("checked",!0).on("change",e=>{d=!d,i.updateTree({initial:!1,tree_position:"inherit"})})}function o(e){const t=i.cont.querySelector("svg.main_svg");nt.handlers.getCurrentZoom(t).k>e&&nt.handlers.zoomTo(t,e)}i.setCard(nt.CardHtml).setStyle("rect").setCardInnerHtmlCreator(e=>s(e)).setOnCardUpdate(function(e){t.select(this).select(".card").classed("card-main",!1)}).onCardClick=(e,t)=>{},i.updateTree({initial:!0}),setTimeout(()=>o(.65),100),a()}h(l)}(s,n,i,o,p,a)}(e,h)),h}function Ne(e){return(e=e[0].toUpperCase()+e.slice(1)).includes("great-")&&(e=e.replace("great-","Great-")),e}function Ue(e,t){return this.cont=e,this.store=t,this.fields=[{type:"text",label:"first name",id:"first name"},{type:"text",label:"last name",id:"last name"},{type:"text",label:"birthday",id:"birthday"},{type:"text",label:"avatar",id:"avatar"}],this.form_cont=null,this.is_fixed=!0,this.history=null,this.no_edit=!1,this.onChange=null,this.editFirst=!1,this.postSubmit=null,this.link_existing_rel_config=null,this.onFormCreation=null,this.kinship_info_config=null,this.init(),this}function je(e,t){this.cont=e,this.autocomplete_cont=null,this.options=[],this.onSelect=t,this.init()}function Ve(...e){return new ze(...e)}function ze(e,t){return this.cont=null,this.store=null,this.svg=null,this.getCard=null,this.node_separation=250,this.level_separation=150,this.is_horizontal=!1,this.single_parent_empty_card=!0,this.transition_time=2e3,this.linkSpouseText=!1,this.personSearch=null,this.is_card_html=!1,this.beforeUpdate=null,this.afterUpdate=null,this.init(e,t),this}function Be(e){const t=[];return Array.isArray(e)?e.forEach(e=>{"function"==typeof e?t.push(e):"string"==typeof e?t.push(t=>t.data[e]):Array.isArray(e)&&t.push(t=>e.map(e=>t.data[e]).join(" "))}):"function"==typeof e?t.push(e):"string"==typeof e&&t.push(t=>t.data[e]),t}function Je(...e){return new We(...e)}function We(e,t){return this.cont=e,this.store=t,this.svg=null,this.getCard=null,this.card_dim={w:220,h:70,text_x:75,text_y:15,img_w:60,img_h:60,img_x:5,img_y:5},this.card_display=[e=>`${e.data["first name"]} ${e.data["last name"]}`],this.mini_tree=!0,this.link_break=!1,this.onCardClick=this.onCardClickDefault.bind(this),this.onCardUpdate=null,this.init(),this}function Ke(...e){return new Ze(...e)}function Ze(e,t){return this.cont=e,this.store=t,this.getCard=null,this.card_display=[e=>`${e.data["first name"]} ${e.data["last name"]}`],this.cardImageField="avatar",this.onCardClick=this.onCardClickDefault,this.style="default",this.mini_tree=!1,this.onCardUpdate=null,this.card_dim={},this.cardInnerHtmlCreator=null,this.init(),this}function Qe(e){return e&&e.__esModule&&Object.prototype.hasOwnProperty.call(e,"default")?e.default:e}Me.prototype.activate=function(e){this.is_active&&this.onCancel(),this.onActivate(),this.is_active=!0,this.store.state.one_level_rels=!0;const n=this.store;this.datum=e,n.updateTree({}),this.onChange=function(i,s){const a=function(t){if(t.is_ancestry){if(e.rels.father===t.data.id)return"father";if(e.rels.mother===t.data.id)return"mother"}else if(t.spouse){if(e.rels.spouses.includes(t.data.id))return"spouse"}else if(e.rels.children.includes(t.data.id))return"children";return null}(i),r=e.rels;"father"===a?function(){const t=n.getDatum(r.father);t.rels.children=t.rels.children.filter(t=>t!==e.id),r.father=null,s()}.call(this):"mother"===a?function(){const t=n.getDatum(r.mother);t.rels.children=t.rels.children.filter(t=>t!==e.id),r.mother=null,s()}.call(this):"spouse"===a?function(){const a=i.data;o()?l.call(this):d.call(this,!0);function o(){return(a.rels.children||[]).some(e=>{const t=n.getDatum(e);return t.rels.father===a.id||t.rels.mother===a.id})}function l(){const n="M"===e.data.gender?"f3-male-bg":"F"===e.data.gender?"f3-female-bg":null,i="M"===a.data.gender?"f3-male-bg":"F"===a.data.gender?"f3-female-bg":null,s=t.create("div").html(`\n          <p>You are removing a spouse relationship. Since there are shared children, please choose which parent should keep them in the family tree.</p>\n          <div class="f3-modal-options">\n            <button data-option="assign-to-current" class="f3-btn ${n}">Keep children with current person</button>\n            <button data-option="assign-to-spouse" class="f3-btn ${i}">Keep children with spouse</button>\n          </div>\n        `);s.selectAll('[data-option="assign-to-current"]').on("click",()=>{d(!0),this.modal.close()}),s.selectAll('[data-option="assign-to-spouse"]').on("click",()=>{d(!1),this.modal.close()}),this.modal.activate(s.node())}function d(t){i.data.rels.spouses=i.data.rels.spouses.filter(t=>t!==e.id),r.spouses=r.spouses.filter(e=>e!==i.data.id);const a=t?e:i.data,o=t?i.data:e;(r.children||[]).forEach(e=>{const t=n.getDatum(e);t.rels.father===o.id&&(t.rels.father=null),t.rels.mother===o.id&&(t.rels.mother=null)}),o.rels.children&&(o.rels.children=o.rels.children.filter(e=>!(a.rels.children||[]).includes(e))),s()}}.call(this):"children"===a&&function(){r.children=r.children.filter(e=>e!==i.data.id);const t=i.data.rels.father===e.id?"father":"mother";i.data.rels[t]=null,s()}.call(this)}.bind(this),this.onCancel=function(){if(!this.is_active)return;this.is_active=!1,this.store.state.one_level_rels=!1,this.cancelCallback(this.datum),this.datum=null,this.onChange=null,this.onCancel=null}.bind(this)},Ae.prototype.init=function(){this.modal_cont=t.select(this.cont).append("div").attr("class","f3-modal").node(),t.select(this.modal_cont).style("display","none"),this.create()},Ae.prototype.create=function(){const e=t.select(this.modal_cont);e.html('\n    <div class="f3-modal-content">\n      <span class="f3-modal-close">&times;</span>\n      <div class="f3-modal-content-inner"></div>\n      <div class="f3-modal-content-bottom"></div>\n    </div>\n  '),e.select(".f3-modal-close").on("click",()=>{this.close()}),e.on("click",t=>{t.target==e.node()&&this.close()})},Ae.prototype.activate=function(e,{boolean:n,onAccept:i,onCancel:s}={}){this.reset(),"string"==typeof e?t.select(this.modal_cont).select(".f3-modal-content-inner").html(e):t.select(this.modal_cont).select(".f3-modal-content-inner").node().appendChild(e),n&&(t.select(this.modal_cont).select(".f3-modal-content-bottom").html('\n      <button class="f3-modal-accept f3-btn">Accept</button>\n      <button class="f3-modal-cancel f3-btn">Cancel</button>\n    '),t.select(this.modal_cont).select(".f3-modal-accept").on("click",()=>{i(),this.reset(),this.close()}),t.select(this.modal_cont).select(".f3-modal-cancel").on("click",()=>{this.close()}),this.onClose=s),this.open()},Ae.prototype.reset=function(){this.onClose=null,t.select(this.modal_cont).select(".f3-modal-content-inner").html(""),t.select(this.modal_cont).select(".f3-modal-content-bottom").html("")},Ae.prototype.open=function(){this.modal_cont.style.display="block",this.active=!0},Ae.prototype.close=function(){this.modal_cont.style.display="none",this.active=!1,this.onClose&&this.onClose()},Ue.prototype.init=function(){this.form_cont=t.select(this.cont).append("div").classed("f3-form-cont",!0).node(),this.modal=this.setupModal(),this.addRelativeInstance=this.setupAddRelative(),this.removeRelativeInstance=this.setupRemoveRelative(),this.createHistory()},Ue.prototype.open=function(e){e.data.data&&"object"==typeof e.data.data&&(e=e.data);const t=this.store.getTreeDatum(e.id);this.addRelativeInstance.is_active?function(){e._new_rel_data?this.cardEditForm(e):(this.addRelativeInstance.onCancel(),this.cardEditForm(e),this.store.updateMainId(e.id),this.store.updateTree({}))}.call(this,e):this.removeRelativeInstance.is_active?function(){if(e.id===this.removeRelativeInstance.datum.id)this.removeRelativeInstance.onCancel(),this.cardEditForm(e);else{function n(){this.removeRelativeInstance.onCancel(),this.updateHistory(),this.store.updateTree({})}this.removeRelativeInstance.onChange(t,n.bind(this))}}.call(this,t):this.cardEditForm(e)},Ue.prototype.openWithoutRelCancel=function(e){this.cardEditForm(e)},Ue.prototype.cardEditForm=function(e){const t={},n=e?._new_rel_data;n?t.onCancel=()=>this.addRelativeInstance.onCancel():(t.addRelative=this.addRelativeInstance,t.removeRelative=this.removeRelativeInstance,t.deletePerson=()=>{f(e,this.store.getData()),this.openFormWithId(this.store.getLastAvailableMainDatum().id),this.store.updateTree({})});const i=nt.handlers.createForm({store:this.store,datum:e,postSubmit:function(t){if(this.addRelativeInstance.is_active){this.addRelativeInstance.onChange(e,t),this.postSubmit&&this.postSubmit(e,this.store.getData());const n=this.addRelativeInstance.datum;this.store.updateMainId(n.id),this.openWithoutRelCancel(n)}else(e.to_add||e.unknown)&&t?.link_rel_id?(l(e,t.link_rel_id,this.store.getData()),this.store.updateMainId(t.link_rel_id),this.openFormWithId(t.link_rel_id)):t?.delete||(this.postSubmit&&this.postSubmit(e,this.store.getData()),this.openFormWithId(e.id));this.is_fixed||this.closeForm();this.store.updateTree({}),this.updateHistory()}.bind(this),fields:this.fields,addRelative:null,onCancel:()=>{},editFirst:this.editFirst,link_existing_rel_config:this.link_existing_rel_config,getKinshipInfo:this.kinship_info_config?()=>qe(this.kinship_info_config,e.id,this.store.getData()):null,onFormCreation:this.onFormCreation,...t});i.no_edit=this.no_edit,this.no_edit&&(i.editable=!1);const s=nt.handlers.formInfoSetup(i,this.closeForm.bind(this));this.form_cont.innerHTML="",this.form_cont.appendChild(s),this.openForm()},Ue.prototype.openForm=function(){t.select(this.form_cont).classed("opened",!0)},Ue.prototype.closeForm=function(){t.select(this.form_cont).classed("opened",!1).html(""),this.store.updateTree({})},Ue.prototype.fixed=function(){return this.is_fixed=!0,t.select(this.form_cont).style("position","relative"),this},Ue.prototype.absolute=function(){return this.is_fixed=!1,t.select(this.form_cont).style("position","absolute"),this},Ue.prototype.setCardClickOpen=function(e){return e.setOnCardClick((t,n)=>{this.isAddingRelative()||this.isRemovingRelative()?this.open(n.data):(this.open(n.data),e.onCardClickDefault(t,n))}),this},Ue.prototype.openFormWithId=function(e){if(e){const t=this.store.getDatum(e);this.openWithoutRelCancel(t)}else{const e=this.store.getMainDatum();this.openWithoutRelCancel(e)}},Ue.prototype.createHistory=function(){return this.history=nt.handlers.createHistory(this.store,this.getStoreDataCopy.bind(this),function(){this.addRelativeInstance.is_active&&this.addRelativeInstance.onCancel();this.removeRelativeInstance.is_active&&this.removeRelativeInstance.onCancel();this.store.updateTree({initial:!1}),this.history.controls.updateButtons(),this.openFormWithId(this.store.getMainDatum()?.id),this.onChange&&this.onChange()}.bind(this)),this.history.controls=nt.handlers.createHistoryControls(this.cont.querySelector(".f3-nav-cont"),this.history),this.history.changed(),this.history.controls.updateButtons(),this},Ue.prototype.setNoEdit=function(){return this.no_edit=!0,this},Ue.prototype.setEdit=function(){return this.no_edit=!1,this},Ue.prototype.setFields=function(e){const t=[];if(!Array.isArray(e))return console.error("fields must be an array"),this;for(const n of e)"string"==typeof n?t.push({type:"text",label:n,id:n}):"object"==typeof n?n.id?t.push(n):console.error("fields must be an array of objects with id property"):console.error("fields must be an array of strings or objects");return this.fields=t,this},Ue.prototype.setOnChange=function(e){return this.onChange=e,this},Ue.prototype.addRelative=function(e){return e||(e=this.store.getMainDatum()),this.addRelativeInstance.activate(e),this},Ue.prototype.setupAddRelative=function(){return((...e)=>new Fe(...e))(this.store,function(){this.removeRelativeInstance.is_active&&this.removeRelativeInstance.onCancel()}.bind(this),function(e){this.store.updateMainId(e.id),this.store.updateTree({}),this.openFormWithId(e.id)}.bind(this))},Ue.prototype.setupRemoveRelative=function(){return((...e)=>new Me(...e))(this.store,function(){this.addRelativeInstance.is_active&&this.addRelativeInstance.onCancel();e(this.cont,!0)}.bind(this),function(t){e(this.cont,!1),this.store.updateMainId(t.id),this.store.updateTree({}),this.openFormWithId(t.id)}.bind(this),this.modal);function e(e,n){t.select(e).select("#f3Canvas").classed("f3-remove-relative-active",n)}},Ue.prototype.setupModal=function(){return function(...e){return new Ae(...e)}(this.cont)},Ue.prototype.setEditFirst=function(e){return this.editFirst=e,this},Ue.prototype.isAddingRelative=function(){return this.addRelativeInstance.is_active},Ue.prototype.isRemovingRelative=function(){return this.removeRelativeInstance.is_active},Ue.prototype.setAddRelLabels=function(e){return this.addRelativeInstance.setAddRelLabels(e),this},Ue.prototype.setLinkExistingRelConfig=function(e){return this.link_existing_rel_config=e,this},Ue.prototype.setOnFormCreation=function(e){return this.onFormCreation=e,this},Ue.prototype.setKinshipInfo=function(e){return this.kinship_info_config=e,this},Ue.prototype.getStoreDataCopy=function(){let e=JSON.parse(JSON.stringify(this.store.getData()));return this.addRelativeInstance.is_active&&(e=this.addRelativeInstance.cleanUp(e)),e=nt.handlers.cleanupDataJson(e),e},Ue.prototype.getDataJson=function(){return JSON.stringify(this.getStoreDataCopy(),null,2)},Ue.prototype.updateHistory=function(){this.history&&(this.history.changed(),this.history.controls.updateButtons()),this.onChange&&this.onChange()},Ue.prototype.setPostSubmit=function(e){return this.postSubmit=e,this},Ue.prototype.destroy=function(){return this.history.controls.destroy(),this.history=null,t.select(this.cont).select(".f3-form-cont").remove(),this.addRelativeInstance.onCancel&&this.addRelativeInstance.onCancel(),this.store.updateTree({}),this},je.prototype.init=function(){this.autocomplete_cont=t.select(this.cont).append("div").attr("class","f3-autocomplete-cont").node(),t.select(this.autocomplete_cont),this.create()},je.prototype.create=function(){const e=this;t.select(this.autocomplete_cont).html(`\n    <div class="f3-autocomplete">\n      <div class="f3-autocomplete-input-cont">\n        <input type="text" placeholder="Search">\n        <span class="f3-autocomplete-toggle">${pe()}</span>\n      </div>\n      <div class="f3-autocomplete-items" tabindex="0"></div>\n    </div>\n  `);const n=t.select(this.autocomplete_cont).select(".f3-autocomplete"),i=n.select("input"),s=n.select(".f3-autocomplete-items");function a(){n.classed("active",!0);const t=i.property("value"),s=e.options.filter(e=>e.label.toLowerCase().includes(t.toLowerCase()));s.forEach(function(e){const n=e.label.toLowerCase().indexOf(t.toLowerCase());e.label_html=-1!==n?e.label.substring(0,n)+"<strong>"+e.label.substring(n,n+t.length)+"</strong>"+e.label.substring(n+t.length):e.label}),s.sort(function(e,t){return e.label<t.label?-1:e.label>t.label?1:0}),o(s)}function r(){n.classed("active",!1),o([])}function o(t){s.selectAll("div.f3-autocomplete-item").data(t,e=>e?.value).join("div").attr("class","f3-autocomplete-item").on("click",(t,n)=>{e.onSelect(n.value)}).html(e=>e.optionHtml?e.optionHtml(e):function(e){return`<div class="${e.class?e.class:""}">${e.label_html}</div>`}(e))}n.on("focusout",()=>{setTimeout(()=>{n.node().contains(document.activeElement)||r()},200)}),i.on("focus",()=>{e.options=e.getOptions(),a()}).on("input",a).on("keydown",function(n){const i=s.selectAll("div.f3-autocomplete-item").nodes(),a=i.findIndex(e=>t.select(e).classed("f3-selected"));if("ArrowDown"===n.key){n.preventDefault();r(i,a<i.length-1?a+1:0)}else if("ArrowUp"===n.key){n.preventDefault();r(i,a>0?a-1:i.length-1)}else if("Enter"===n.key&&-1!==a){n.preventDefault();const s=t.select(i[a]).datum();s&&e.onSelect(s.value)}function r(e,n){e.forEach(e=>t.select(e).classed("f3-selected",!1)),e[n]&&(t.select(e[n]).classed("f3-selected",!0),e[n].scrollIntoView({block:"nearest"}))}}),s.on("wheel",e=>e.stopPropagation()),n.select(".f3-autocomplete-toggle").on("click",e=>{e.stopPropagation();const t=n.classed("active");n.classed("active",!t),t?r():(i.node().focus(),a())})},je.prototype.setOptionsGetter=function(e){return this.getOptions=e,this},je.prototype.setOptionsGetterPerson=function(e,t){return this.getOptions=()=>{const i=[];return e().forEach(e=>{e.to_add||e.unknown||e._new_rel_data||i.find(t=>t.value===e.id)||i.push({label:t(e),value:e.id,optionHtml:n(e)})}),i},this;function n(t){const n=!o(t,e());return e=>`\n      <div>\n        <span style="float: left; width: 10px; height: 10px; margin-right: 10px;" class="f3-${function(e){return"M"===e.data.gender?"male":"F"===e.data.gender?"female":"genderless"}(t)}-color">${de()}</span>\n        <span>${e.label_html}</span>\n        ${n?`<span style="float: right; width: 10px; height: 10px; margin-left: 5px;" title="This profile is not connected to the main profile">${fe()}</span>`:""}\n      </div>\n    `}},je.prototype.destroy=function(){this.autocomplete_cont.remove()},ze.prototype.init=function(e,n){this.cont=e=function(e){"string"==typeof e&&(e=document.querySelector(e));return e}(e);this.svg=nt.createSvg(e,{onZoom:nt.htmlHandlers.onZoomSetup(()=>e.querySelector("svg .view"),()=>e.querySelector("#htmlSvg .cards_view"))}),nt.htmlHandlers.createHtmlSvg(e),function(e){t.select(e).append("div").attr("class","f3-nav-cont")}(this.cont),this.store=nt.createStore({data:n,node_separation:this.node_separation,level_separation:this.level_separation,single_parent_empty_card:this.single_parent_empty_card,is_horizontal:this.is_horizontal}),this.store.setOnUpdate(n=>{this.beforeUpdate&&this.beforeUpdate(n),n=Object.assign({transition_time:this.transition_time},n||{}),this.is_card_html&&(n=Object.assign({},n||{},{cardHtml:e.querySelector("#htmlSvg")})),nt.view(this.store.getTree(),this.svg,this.getCard(),n||{}),this.linkSpouseText&&function(e,n,i={}){const s=[];n.data.forEach(e=>{e._spouse&&"F"===e.data.data.gender&&s.push({nodes:[e,e._spouse],id:`${e.data.id}--${e._spouse.data.id}`}),e.spouses&&e.spouses.forEach(t=>s.push({nodes:[t,e],id:`${t.data.id}--${e.data.id}`}))});const a=t.select(e).select(".links_view").selectAll("g.link-text").data(s,e=>e.id),r=a.exit(),o=a.enter().append("g").attr("class","link-text"),l=o.merge(a),d=(e,t)=>e.spouse&&"F"===e.data.data.gender?e.x-i.node_separation/2:t.spouse&&"M"===t.data.data.gender?t.x+i.node_separation/2:Math.min(e.x,t.x)+i.node_separation/2;r.each(function(e){const n=t.select(this);n.transition("text").duration(100).style("opacity",0).on("end",()=>n.remove())}),o.each(function(e){const[n,i]=e.nodes,s=t.select(this);s.attr("transform",`translate(${d(n,i)}, ${n.y-3})`).style("opacity",0),s.append("text").style("font-size","12px").style("fill","#fff").style("text-anchor","middle")}),l.each(function(e){const[s,a]=e.nodes,r=t.select(this),o=i.initial?P(n,s,i.transition_time):0;r.select("text").text(i.linkSpouseText(s,a)),r.transition("text").duration(i.transition_time).delay(o).attr("transform",`translate(${d(s,a)}, ${s.y-3})`),r.transition("text-op").duration(100).delay(o+i.transition_time).style("opacity",1)})}(this.svg,this.store.getTree(),Object.assign({},n||{},{linkSpouseText:this.linkSpouseText,node_separation:this.node_separation})),this.afterUpdate&&this.afterUpdate(n)})},ze.prototype.updateTree=function(e={initial:!1}){return this.store.updateTree(e),this},ze.prototype.updateData=function(e){return this.store.updateData(e),this},ze.prototype.setCardYSpacing=function(e){return"number"!=typeof e?(console.error("card_y_spacing must be a number"),this):(this.level_separation=e,this.store.state.level_separation=e,this)},ze.prototype.setCardXSpacing=function(e){return"number"!=typeof e?(console.error("card_x_spacing must be a number"),this):(this.node_separation=e,this.store.state.node_separation=e,this)},ze.prototype.setOrientationVertical=function(){return this.is_horizontal=!1,this.store.state.is_horizontal=!1,this},ze.prototype.setOrientationHorizontal=function(){return this.is_horizontal=!0,this.store.state.is_horizontal=!0,this},ze.prototype.setShowSiblingsOfMain=function(e){return this.store.state.show_siblings_of_main=e,this},ze.prototype.setModifyTreeHierarchy=function(e){return this.store.state.modifyTreeHierarchy=e,this},ze.prototype.setPrivateCardsConfig=function(e){return this.store.state.private_cards_config=e,this},ze.prototype.setLinkSpouseText=function(e){return this.linkSpouseText=e,this},ze.prototype.setSingleParentEmptyCard=function(e,{label:t="Unknown"}={}){return this.single_parent_empty_card=e,this.store.state.single_parent_empty_card=e,this.store.state.single_parent_empty_card_label=t,this.editTreeInstance&&this.editTreeInstance.addRelativeInstance.is_active&&this.editTreeInstance.addRelativeInstance.onCancel(),nt.handlers.removeToAddFromData(this.store.getData()||[]),this},ze.prototype.setCard=function(e){this.is_card_html=e.is_html,this.is_card_html?(this.svg.querySelector(".cards_view").innerHTML="",this.cont.querySelector("#htmlSvg").style.display="block"):(this.cont.querySelector("#htmlSvg .cards_view").innerHTML="",this.cont.querySelector("#htmlSvg").style.display="none");const t=e(this.cont,this.store);return this.getCard=()=>t.getCard(),t},ze.prototype.setTransitionTime=function(e){return this.transition_time=e,this},ze.prototype.setSortChildrenFunction=function(e){return this.store.state.sortChildrenFunction=e,this},ze.prototype.setSortSpousesFunction=function(e){return this.store.state.sortSpousesFunction=e,this},ze.prototype.setAncestryDepth=function(e){return this.store.state.ancestry_depth=e,this},ze.prototype.setProgenyDepth=function(e){return this.store.state.progeny_depth=e,this},ze.prototype.getMaxDepth=function(e){return function(e,n){const i=n.find(t=>t.id===e),s=t.hierarchy(i,function(e){return[e.rels.father,e.rels.mother].filter(e=>e).map(e=>n.find(t=>t.id===e)).filter(e=>e&&!e._new_rel_data&&!e.to_add)}),a=t.hierarchy(i,function(e){return[...e.rels.children||[]].map(e=>n.find(t=>t.id===e)).filter(e=>e&&!e._new_rel_data&&!e.to_add)});return{ancestry:s.height,progeny:a.height}}(e,this.store.getData())},ze.prototype.calculateKinships=function(e,t){return Re(e,this.store.getData(),t)},ze.prototype.getKinshipsDataStash=function(e,t){return Le(e,t,this.store.getData(),this.calculateKinships(e))},ze.prototype.setDuplicateBranchToggle=function(e){return this.store.state.duplicate_branch_toggle=e,this},ze.prototype.editTree=function(){return this.editTreeInstance=function(...e){return new Ue(...e)}(this.cont,this.store)},ze.prototype.updateMain=function(e){return this.store.updateMainId(e.data.id),this.store.updateTree({}),this},ze.prototype.updateMainId=function(e){return this.store.updateMainId(e),this},ze.prototype.getMainDatum=function(){return this.store.getMainDatum()},ze.prototype.updateData=function(e){this.store.updateData(e)},ze.prototype.setBeforeUpdate=function(e){return this.beforeUpdate=e,this},ze.prototype.setAfterUpdate=function(e){return this.afterUpdate=e,this},ze.prototype.setPersonDropdown=function(e,t=this.cont.querySelector(".f3-nav-cont")){return this.personSearch=function(...e){return new je(...e)}(t,function(e){this.editTreeInstance&&this.editTreeInstance.open(this.store.getDatum(e));this.updateMainId(e),this.updateTree({initial:!1})}.bind(this)),this.personSearch.setOptionsGetterPerson(this.store.getData,e),this},ze.prototype.unSetPersonSearch=function(){return this.personSearch.destroy(),this.personSearch=null,this},Je.is_html=!1,We.prototype.init=function(){this.svg=this.cont.querySelector("svg.main_svg"),this.getCard=()=>nt.elements.CardSvg({store:this.store,svg:this.svg,card_dim:this.card_dim,card_display:this.card_display,mini_tree:this.mini_tree,link_break:this.link_break,onCardClick:this.onCardClick,onCardUpdate:this.onCardUpdate})},We.prototype.setCardDisplay=function(e){return this.card_display=Be(e),this},We.prototype.setCardDim=function(e){if("object"!=typeof e)return console.error("card_dim must be an object"),this;for(let t in e){const n=e[t];if("number"!=typeof n&&"boolean"!=typeof n)return console.error(`card_dim.${t} must be a number or boolean`),this;"width"===t&&(t="w"),"height"===t&&(t="h"),"img_width"===t&&(t="img_w"),"img_height"===t&&(t="img_h"),"img_x"===t&&(t="img_x"),"img_y"===t&&(t="img_y"),this.card_dim[t]=n}return function(e,t){e.querySelector("defs#f3CardDef")&&e.querySelector("defs#f3CardDef").remove(),Ee(e,t)}(this.svg,this.card_dim),this},We.prototype.setOnCardUpdate=function(e){return this.onCardUpdate=e,this},We.prototype.setMiniTree=function(e){return this.mini_tree=e,this},We.prototype.setLinkBreak=function(e){return this.link_break=e,this},We.prototype.onCardClickDefault=function(e,t){this.store.updateMainId(t.data.id),this.store.updateTree({})},We.prototype.setOnCardClick=function(e){return this.onCardClick=e,this},Ke.is_html=!0,Ze.prototype.is_html=!0,Ze.prototype.init=function(){this.svg=this.cont.querySelector("svg.main_svg"),this.getCard=()=>nt.elements.CardHtml({store:this.store,card_display:this.card_display,cardImageField:this.cardImageField,defaultPersonIcon:this.defaultPersonIcon,onCardClick:this.onCardClick,style:this.style,mini_tree:this.mini_tree,onCardUpdate:this.onCardUpdate,card_dim:this.card_dim,empty_card_label:this.store.state.single_parent_empty_card_label,cardInnerHtmlCreator:this.cardInnerHtmlCreator,duplicate_branch_toggle:this.store.state.duplicate_branch_toggle,onCardMouseenter:this.onCardMouseenter?this.onCardMouseenter.bind(this):null,onCardMouseleave:this.onCardMouseleave?this.onCardMouseleave.bind(this):null})},Ze.prototype.setCardDisplay=function(e){return this.card_display=Be(e),this},Ze.prototype.setCardImageField=function(e){return this.cardImageField=e,this},Ze.prototype.setDefaultPersonIcon=function(e){return this.defaultPersonIcon=e,this},Ze.prototype.setOnCardClick=function(e){return this.onCardClick=e,this},Ze.prototype.onCardClickDefault=function(e,t){this.store.updateMainId(t.data.id),this.store.updateTree({})},Ze.prototype.setStyle=function(e){return this.style=e,this},Ze.prototype.setMiniTree=function(e){return this.mini_tree=e,this},Ze.prototype.setOnCardUpdate=function(e){return this.onCardUpdate=e,this},Ze.prototype.setCardDim=function(e){if("object"!=typeof e)return console.error("card_dim must be an object"),this;for(let t in e){const n=e[t];if("number"!=typeof n&&"boolean"!=typeof n)return console.error(`card_dim.${t} must be a number or boolean`),this;"width"===t&&(t="w"),"height"===t&&(t="h"),"img_width"===t&&(t="img_w"),"img_height"===t&&(t="img_h"),"img_x"===t&&(t="img_x"),"img_y"===t&&(t="img_y"),this.card_dim[t]=n}return this},Ze.prototype.resetCardDim=function(){return this.card_dim={},this},Ze.prototype.setCardInnerHtmlCreator=function(e){return this.cardInnerHtmlCreator=e,this},Ze.prototype.setOnHoverPathToMain=function(){return this.onCardMouseenter=this.onEnterPathToMain.bind(this),this.onCardMouseleave=this.onLeavePathToMain.bind(this),this},Ze.prototype.unsetOnHoverPathToMain=function(){return this.onCardMouseenter=null,this.onCardMouseleave=null,this},Ze.prototype.onEnterPathToMain=function(e,n){this.to_transition=n.data.id;const i=this.store.getTreeMainDatum(),s=t.select(this.cont).select("div.cards_view").selectAll(".card_cont"),a=t.select(this.cont).select("svg.main_svg .links_view").selectAll(".link"),[r,o]=function(e,t,n,i){const s=n.is_ancestry,a=t.data();let r=[],o=[];if(s){const s=[];let c=n,h=0;for(;c!==i.data&&h<100;){h++;const e=a.find(e=>!0===e.spouse&&(e.source===c||e.target===c));if(e){const t=d(a.filter(t=>Array.isArray(t.target)&&t.target.includes(e.source)&&t.target.includes(e.target)),i);if(!t)break;s.push(e),s.push(t),c=t.source}else{const e=d(a.filter(e=>Array.isArray(e.target)&&e.target.includes(c)),i);if(!e)break;s.push(e),c=e.source}}t.each(function(e){s.includes(e)&&r.push({link:e,node:this})});const u=l(n,s);e.each(function(e){u.includes(e)&&o.push({card:e,node:this})})}else if(n.spouse&&n.spouse.data===i.data){t.each(function(e){e.target===n&&r.push({link:e,node:this})});const s=[i,n];e.each(function(e){s.includes(e)&&o.push({card:e,node:this})})}else if(n.sibling){t.each(function(e){e.source===n&&r.push({link:e,node:this}),e.source===i&&2===e.target.length&&r.push({link:e,node:this}),n.parents.includes(e.source)&&n.parents.includes(e.target)&&r.push({link:e,node:this})});const s=[i,n,...n.parents];e.each(function(e){s.includes(e)&&o.push({card:e,node:this})})}else{let s=[],d=n,c=0;for(;d!==i.data&&c<100;){c++;const e=a.find(e=>e.target===d&&Array.isArray(e.source));if(e){const t=a.find(t=>{return!0===t.spouse&&(n=[t.source,t.target],i=e.source,n.every(e=>i.some(t=>e===t)));var n,i});s.push(e),s.push(t),d=t?t.source:e.source[0]}else{const e=a.find(e=>e.target===d&&!Array.isArray(e.source));if(!e)break;s.push(e),d=e.source}}t.each(function(e){s.includes(e)&&r.push({link:e,node:this})});const h=l(i,s);e.each(function(e){h.includes(e)&&o.push({card:e,node:this})})}return[o,r];function l(e,t){const s=t.filter(e=>e).reduce((e,t)=>(Array.isArray(t.target)?e.push(...t.target):e.push(t.target),Array.isArray(t.source)?e.push(...t.source):e.push(t.source),e),[]),a=[i,n];return function e(t){t.data.rels.children&&t.data.rels.children.forEach(t=>{const n=s.find(e=>e.data.id===t);n&&(a.push(n),e(n))})}(e),a}function d(e,t){return 0===e.length?null:1===e.length?e[0]:e.find(e=>e.source===t)}}(s,a,n,i);return r.forEach(e=>{const i=200*Math.abs(n.depth-e.card.depth);t.select(e.node.querySelector("div.card-inner")).transition().duration(0).delay(i).on("end",()=>this.to_transition===n.data.id&&t.select(e.node.querySelector("div.card-inner")).classed("f3-path-to-main",!0))}),o.forEach(e=>{const i=200*Math.abs(n.depth-e.link.depth);t.select(e.node).transition().duration(0).delay(i).on("end",()=>this.to_transition===n.data.id&&t.select(e.node).classed("f3-path-to-main",!0))}),this},Ze.prototype.onLeavePathToMain=function(e,n){return this.to_transition=!1,t.select(this.cont).select("div.cards_view").selectAll("div.card-inner").classed("f3-path-to-main",!1),t.select(this.cont).select("svg.main_svg .links_view").selectAll(".link").classed("f3-path-to-main",!1),this};var Ge=Qe(class{constructor(e={}){this.baseUrl=e.baseUrl||"/api",this.familyId=e.familyId,this.headers={"Content-Type":"application/json",...e.headers}}setFamilyId(e){this.familyId=e}async fetchFamily(e=this.familyId){if(!e)throw new Error("Family ID is required");try{const t=await fetch(`${this.baseUrl}/family/${e}`,{method:"GET",headers:this.headers});if(!t.ok)throw new Error(`Failed to fetch family data: ${t.statusText}`);const n=await t.json();return this.transformFromApi(n)}catch(e){throw console.error("Error fetching family data:",e),e}}async saveFamily(e,t=this.familyId){if(!t)throw new Error("Family ID is required");try{const n=this.transformToApi(e),i=await fetch(`${this.baseUrl}/family/${t}`,{method:"PUT",headers:this.headers,body:JSON.stringify(n)});if(!i.ok)throw new Error(`Failed to save family data: ${i.statusText}`);return await i.json()}catch(e){throw console.error("Error saving family data:",e),e}}async addPerson(e,t=this.familyId){if(!t)throw new Error("Family ID is required");try{const n=await fetch(`${this.baseUrl}/family/${t}/person`,{method:"POST",headers:this.headers,body:JSON.stringify(e)});if(!n.ok)throw new Error(`Failed to add person: ${n.statusText}`);return await n.json()}catch(e){throw console.error("Error adding person:",e),e}}async updatePerson(e,t,n=this.familyId){if(!n)throw new Error("Family ID is required");try{const i=await fetch(`${this.baseUrl}/family/${n}/person/${e}`,{method:"PUT",headers:this.headers,body:JSON.stringify(t)});if(!i.ok)throw new Error(`Failed to update person: ${i.statusText}`);return await i.json()}catch(e){throw console.error("Error updating person:",e),e}}async deletePerson(e,t=this.familyId){if(!t)throw new Error("Family ID is required");try{const n=await fetch(`${this.baseUrl}/family/${t}/person/${e}`,{method:"DELETE",headers:this.headers});if(!n.ok)throw new Error(`Failed to delete person: ${n.statusText}`);return await n.json()}catch(e){throw console.error("Error deleting person:",e),e}}transformFromApi(e){return Array.isArray(e)?e:e.members?e.members:e.data||e}transformToApi(e){return e.map(e=>({id:e.id,data:{...e.data},rels:{...e.rels}})).filter(e=>!e.data._new_rel_data&&!e.to_add)}async batchUpdate(e,t=this.familyId){if(!t)throw new Error("Family ID is required");try{const n=await fetch(`${this.baseUrl}/family/${t}/batch`,{method:"POST",headers:this.headers,body:JSON.stringify({operations:e})});if(!n.ok)throw new Error(`Failed to perform batch update: ${n.statusText}`);return await n.json()}catch(e){throw console.error("Error performing batch update:",e),e}}});class Ye{constructor(e,t,n={}){this.container=e,this.store=t,this.config={api:null,onPersonAdd:null,onPersonUpdate:null,onPersonDelete:null,enableDragDrop:!0,enableInlineEdit:!0,...n},this.isActive=!1,this.currentEditPerson=null,this.editMode=null,this.relationshipBuffer=null,this.init()}init(){this.createEditorUI(),this.attachEventListeners()}createEditorUI(){this.toolbar=document.createElement("div"),this.toolbar.className="f3-editor-toolbar",this.toolbar.innerHTML='\n      <div class="f3-editor-controls">\n        <button class="f3-btn f3-btn-add" data-action="add-person">\n          <i class="f3-icon-plus"></i> Add Person\n        </button>\n        <button class="f3-btn f3-btn-edit" data-action="edit-mode" title="Toggle Edit Mode">\n          <i class="f3-icon-edit"></i> Edit Mode\n        </button>\n        <button class="f3-btn f3-btn-save" data-action="save-all" title="Save All Changes">\n          <i class="f3-icon-save"></i> Save\n        </button>\n        <button class="f3-btn f3-btn-undo" data-action="undo" title="Undo Last Change">\n          <i class="f3-icon-undo"></i> Undo\n        </button>\n      </div>\n      <div class="f3-editor-status">\n        <span class="f3-status-text">Ready</span>\n      </div>\n    ',this.modal=document.createElement("div"),this.modal.className="f3-editor-modal",this.modal.innerHTML='\n      <div class="f3-modal-backdrop"></div>\n      <div class="f3-modal-content">\n        <div class="f3-modal-header">\n          <h3 class="f3-modal-title">Edit Person</h3>\n          <button class="f3-modal-close" type="button">&times;</button>\n        </div>\n        <div class="f3-modal-body">\n          <form class="f3-person-form">\n            <div class="f3-form-group">\n              <label for="firstName">First Name</label>\n              <input type="text" id="firstName" name="first name" class="f3-form-control">\n            </div>\n            <div class="f3-form-group">\n              <label for="lastName">Last Name</label>\n              <input type="text" id="lastName" name="last name" class="f3-form-control">\n            </div>\n            <div class="f3-form-group">\n              <label for="gender">Gender</label>\n              <select id="gender" name="gender" class="f3-form-control">\n                <option value="">Select...</option>\n                <option value="M">Male</option>\n                <option value="F">Female</option>\n              </select>\n            </div>\n            <div class="f3-form-group">\n              <label for="birthday">Birth Date</label>\n              <input type="date" id="birthday" name="birthday" class="f3-form-control">\n            </div>\n            <div class="f3-form-group">\n              <label for="avatar">Photo URL</label>\n              <input type="url" id="avatar" name="avatar" class="f3-form-control">\n            </div>\n            <div class="f3-form-group">\n              <label for="notes">Notes</label>\n              <textarea id="notes" name="notes" class="f3-form-control" rows="3"></textarea>\n            </div>\n          </form>\n        </div>\n        <div class="f3-modal-footer">\n          <button type="button" class="f3-btn f3-btn-secondary" data-action="cancel">Cancel</button>\n          <button type="button" class="f3-btn f3-btn-danger" data-action="delete" style="display:none;">Delete</button>\n          <button type="button" class="f3-btn f3-btn-primary" data-action="save">Save</button>\n        </div>\n      </div>\n    ',this.container.appendChild(this.toolbar),this.container.appendChild(this.modal)}attachEventListeners(){this.toolbar.addEventListener("click",e=>{const t=e.target.closest("[data-action]")?.dataset.action;t&&this.handleToolbarAction(t,e)}),this.modal.addEventListener("click",e=>{const t=e.target.dataset.action;t&&this.handleModalAction(t,e),(e.target.classList.contains("f3-modal-backdrop")||e.target.classList.contains("f3-modal-close"))&&this.closeModal()});this.modal.querySelector(".f3-person-form").addEventListener("submit",e=>{e.preventDefault(),this.handleModalAction("save",e)}),this.container.addEventListener("click",e=>{if(!this.isActive)return;const t=e.target.closest(".f3-card");if(t){const e=t.dataset.personId;e&&this.editPerson(e)}}),this.config.enableDragDrop&&this.setupDragDrop()}async handleToolbarAction(e,t){switch(e){case"add-person":await this.addPerson();break;case"edit-mode":this.toggleEditMode();break;case"save-all":await this.saveAll();break;case"undo":this.undo()}}async handleModalAction(e,t){switch(e){case"save":await this.savePerson();break;case"delete":await this.deletePerson();break;case"cancel":this.closeModal()}}async addPerson(e=null){const t={id:this.generateId(),data:{"first name":"","last name":"",gender:"M"},rels:{}};e&&this.setupRelationship(t,e),this.openModal(t,"add")}editPerson(e){const t=this.store.getDatum(e);t&&this.openModal(t,"edit")}openModal(e,t="edit"){this.currentEditPerson=e,this.editMode=t;const n="add"===t?"Add New Person":"Edit Person";this.modal.querySelector(".f3-modal-title").textContent=n;this.modal.querySelector('[data-action="delete"]').style.display="edit"===t?"block":"none",this.populateForm(e),this.modal.classList.add("f3-modal-active"),document.body.classList.add("f3-modal-open")}closeModal(){this.modal.classList.remove("f3-modal-active"),document.body.classList.remove("f3-modal-open"),this.currentEditPerson=null,this.editMode=null}populateForm(e){this.modal.querySelector(".f3-person-form").querySelectorAll("input, select, textarea").forEach(t=>{const n=e.data[t.name]||"";"checkbox"===t.type?t.checked=!!n:t.value=n})}getFormData(){const e=this.modal.querySelector(".f3-person-form"),t=new FormData(e),n={};for(const[e,i]of t.entries())n[e]=i;return n}async savePerson(){try{const e=this.getFormData(),t={...this.currentEditPerson};Object.assign(t.data,e),"add"===this.editMode?(this.config.onPersonAdd?await this.config.onPersonAdd(t):this.store.getData().push(t),this.updateStatus("Person added successfully")):(this.config.onPersonUpdate&&await this.config.onPersonUpdate(t.id,t),this.updateStatus("Person updated successfully")),this.closeModal()}catch(e){console.error("Failed to save person:",e),this.updateStatus("Failed to save person","error")}}async deletePerson(){if(!this.currentEditPerson)return;if(confirm("Are you sure you want to delete this person? This action cannot be undone."))try{if(this.config.onPersonDelete)await this.config.onPersonDelete(this.currentEditPerson.id);else{const e=this.store.getData(),t=e.findIndex(e=>e.id===this.currentEditPerson.id);t>-1&&e.splice(t,1)}this.updateStatus("Person deleted successfully"),this.closeModal()}catch(e){console.error("Failed to delete person:",e),this.updateStatus("Failed to delete person","error")}}toggleEditMode(){this.isActive=!this.isActive;const e=this.toolbar.querySelector('[data-action="edit-mode"]');this.isActive?(e.classList.add("f3-btn-active"),this.container.classList.add("f3-edit-mode"),this.updateStatus("Edit mode enabled - click cards to edit")):(e.classList.remove("f3-btn-active"),this.container.classList.remove("f3-edit-mode"),this.updateStatus("Edit mode disabled"))}async saveAll(){try{if(this.config.api){const e=this.store.getData();await this.config.api.saveFamily(e),this.updateStatus("All changes saved successfully")}}catch(e){console.error("Failed to save all changes:",e),this.updateStatus("Failed to save changes","error")}}undo(){this.updateStatus("Undo functionality not yet implemented")}setupDragDrop(){let e=null;this.container.addEventListener("dragstart",t=>{if(!this.isActive)return;const n=t.target.closest(".f3-card");n&&(e=n,t.dataTransfer.effectAllowed="link",t.dataTransfer.setData("text/plain",n.dataset.personId))}),this.container.addEventListener("dragover",t=>{this.isActive&&e&&(t.preventDefault(),t.dataTransfer.dropEffect="link")}),this.container.addEventListener("drop",t=>{if(!this.isActive||!e)return;t.preventDefault();const n=t.target.closest(".f3-card");if(n&&n!==e){const t=e.dataset.personId,i=n.dataset.personId;this.createRelationshipDialog(t,i)}e=null})}createRelationshipDialog(e,t){const n=this.store.getDatum(e),i=this.store.getDatum(t);if(!n||!i)return;const s=[{value:"spouse",label:"Spouse"},{value:"child",label:"Child of target"},{value:"parent",label:"Parent of target"},{value:"sibling",label:"Sibling of target"}].map(e=>`<option value="${e.value}">${e.label}</option>`).join(""),a=document.createElement("div");a.className="f3-relationship-dialog",a.innerHTML=`\n      <div class="f3-dialog-content">\n        <h4>Create Relationship</h4>\n        <p>Set relationship between:</p>\n        <p><strong>${n.data["first name"]} ${n.data["last name"]}</strong></p>\n        <p>and</p>\n        <p><strong>${i.data["first name"]} ${i.data["last name"]}</strong></p>\n        <select class="f3-relationship-select">\n          <option value="">Select relationship...</option>\n          ${s}\n        </select>\n        <div class="f3-dialog-actions">\n          <button class="f3-btn f3-btn-secondary" data-action="cancel">Cancel</button>\n          <button class="f3-btn f3-btn-primary" data-action="create">Create</button>\n        </div>\n      </div>\n    `,a.addEventListener("click",async n=>{if("create"===n.target.dataset.action){const n=a.querySelector(".f3-relationship-select").value;n&&await this.createRelationship(e,t,n)}a.remove()}),this.container.appendChild(a)}async createRelationship(e,t,n){try{const i=this.store.getDatum(e),s=this.store.getDatum(t);switch(n){case"spouse":i.rels.spouses||(i.rels.spouses=[]),s.rels.spouses||(s.rels.spouses=[]),i.rels.spouses.push(t),s.rels.spouses.push(e);break;case"child":s.rels.children||(s.rels.children=[]),s.rels.children.push(e),i.rels["M"===s.data.gender?"father":"mother"]=t;break;case"parent":i.rels.children||(i.rels.children=[]),i.rels.children.push(t),s.rels["M"===i.data.gender?"father":"mother"]=e;break;case"sibling":const n=this.getParents(i);n.father&&(s.rels.father=n.father),n.mother&&(s.rels.mother=n.mother)}this.config.onPersonUpdate&&(await this.config.onPersonUpdate(e,i),await this.config.onPersonUpdate(t,s)),this.updateStatus("Relationship created successfully")}catch(e){console.error("Failed to create relationship:",e),this.updateStatus("Failed to create relationship","error")}}getParents(e){const t=this.store.getData();return{father:e.rels.father?t.find(t=>t.id===e.rels.father):null,mother:e.rels.mother?t.find(t=>t.id===e.rels.mother):null}}setupRelationship(e,t){const{targetPersonId:n,relationshipType:i}=t,s=this.store.getDatum(n);if(s)switch(i){case"child":e.rels["M"===s.data.gender?"father":"mother"]=n;break;case"parent":e.rels.children||(e.rels.children=[]),e.rels.children.push(n);break;case"spouse":e.rels.spouses||(e.rels.spouses=[]),e.rels.spouses.push(n)}}updateStatus(e,t="info"){const n=this.toolbar.querySelector(".f3-status-text");n.textContent=e,n.className=`f3-status-text f3-status-${t}`,setTimeout(()=>{n.textContent="Ready",n.className="f3-status-text"},3e3)}generateId(){return"xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx".replace(/[xy]/g,function(e){var t=16*Math.random()|0;return("x"==e?t:3&t|8).toString(16)})}destroy(){this.toolbar&&this.toolbar.remove(),this.modal&&this.modal.remove(),this.container.classList.remove("f3-edit-mode")}}class Xe{constructor(e,t={}){this.container=e,this.config={data:()=>[],onSelect:null,searchFields:["first name","last name"],placeholder:"Search family members...",maxResults:10,minSearchLength:1,showAvatars:!0,groupByFamily:!1,...t},this.isOpen=!1,this.currentQuery="",this.selectedIndex=-1,this.filteredResults=[],this.init()}init(){this.createDropdownUI(),this.attachEventListeners()}createDropdownUI(){this.dropdown=document.createElement("div"),this.dropdown.className="f3-person-dropdown",this.dropdown.innerHTML=`\n      <div class="f3-dropdown-input-container">\n        <input \n          type="text" \n          class="f3-dropdown-input" \n          placeholder="${this.config.placeholder}"\n          autocomplete="off"\n        >\n        <div class="f3-dropdown-icon">\n          <svg width="16" height="16" viewBox="0 0 16 16">\n            <path d="M15.5 15l-4.2-4.2a6.5 6.5 0 1 0-1.4 1.4L14.5 16l1-1zM6.5 1a5.5 5.5 0 1 1 0 11 5.5 5.5 0 0 1 0-11z"/>\n          </svg>\n        </div>\n      </div>\n      <div class="f3-dropdown-results" style="display: none;">\n        <div class="f3-dropdown-list"></div>\n      </div>\n    `,this.container.appendChild(this.dropdown),this.input=this.dropdown.querySelector(".f3-dropdown-input"),this.results=this.dropdown.querySelector(".f3-dropdown-results"),this.resultsList=this.dropdown.querySelector(".f3-dropdown-list")}attachEventListeners(){this.input.addEventListener("input",e=>{this.currentQuery=e.target.value,this.handleSearch()}),this.input.addEventListener("focus",()=>{this.currentQuery.length>=this.config.minSearchLength&&this.showResults()}),this.input.addEventListener("blur",e=>{setTimeout(()=>{this.dropdown.contains(document.activeElement)||this.hideResults()},150)}),this.input.addEventListener("keydown",e=>{this.handleKeydown(e)}),this.resultsList.addEventListener("click",e=>{const t=e.target.closest(".f3-dropdown-item");if(t){const e=t.dataset.personId;this.selectPerson(e)}}),document.addEventListener("click",e=>{this.dropdown.contains(e.target)||this.hideResults()})}handleSearch(){this.currentQuery.length<this.config.minSearchLength?this.hideResults():(this.filteredResults=this.searchPeople(this.currentQuery),this.selectedIndex=-1,this.renderResults(),this.showResults())}searchPeople(e){const t=this.config.data(),n=e.toLowerCase();return t.filter(e=>this.config.searchFields.some(t=>{const i=this.getNestedValue(e.data,t);return i&&i.toLowerCase().includes(n)})).sort((e,t)=>{const i=this.calculateRelevance(e,n);return this.calculateRelevance(t,n)-i}).slice(0,this.config.maxResults)}calculateRelevance(e,t){let n=0;return this.config.searchFields.forEach(i=>{const s=this.getNestedValue(e.data,i);if(!s)return;const a=s.toLowerCase();a===t?n+=100:a.startsWith(t)?n+=50:a.includes(t)&&(n+=25)}),n}getNestedValue(e,t){return t.split(".").reduce((e,t)=>e&&void 0!==e[t]?e[t]:null,e)}renderResults(){if(0===this.filteredResults.length)return void(this.resultsList.innerHTML='\n        <div class="f3-dropdown-empty">\n          <div class="f3-empty-icon">ðŸ‘¤</div>\n          <div class="f3-empty-text">No people found</div>\n        </div>\n      ');let e="";if(this.config.groupByFamily){const t=this.groupResultsByFamily();for(const[n,i]of Object.entries(t))e+=`<div class="f3-dropdown-group-header">${n}</div>`,i.forEach((t,n)=>{e+=this.renderPersonItem(t,n)})}else this.filteredResults.forEach((t,n)=>{e+=this.renderPersonItem(t,n)});this.resultsList.innerHTML=e}renderPersonItem(e,t){const n=this.getPersonDisplayName(e),i=this.getPersonDetails(e),s=this.config.showAvatars?this.getPersonAvatar(e):"";return`\n      <div class="f3-dropdown-item ${t===this.selectedIndex?"f3-dropdown-item-selected":""}" data-person-id="${e.id}" data-index="${t}">\n        <div class="f3-dropdown-item-content">\n          ${s}\n          <div class="f3-dropdown-item-info">\n            <div class="f3-dropdown-item-name">${this.highlightMatch(n)}</div>\n            <div class="f3-dropdown-item-details">${i}</div>\n          </div>\n        </div>\n      </div>\n    `}getPersonDisplayName(e){return`${e.data["first name"]||""} ${e.data["last name"]||""}`.trim()||e.data.name||"Unknown Person"}getPersonDetails(e){const t=[];if(e.data.birthday){const n=new Date(e.data.birthday).getFullYear();t.push(`Born ${n}`)}e.data.profession&&t.push(e.data.profession),e.data.location&&t.push(e.data.location);const n=this.getRelationshipToMain(e);return n&&t.push(n),t.join(" â€¢ ")||"No additional info"}getPersonAvatar(e){return e.data.avatar?`\n        <div class="f3-dropdown-avatar">\n          <img src="${e.data.avatar}" alt="${this.getPersonDisplayName(e)}" \n               onerror="this.style.display='none'; this.nextElementSibling.style.display='flex';">\n          <div class="f3-dropdown-avatar-fallback" style="display:none;">\n            ${this.getAvatarInitials(e)}\n          </div>\n        </div>\n      `:`\n        <div class="f3-dropdown-avatar">\n          <div class="f3-dropdown-avatar-fallback">\n            ${this.getAvatarInitials(e)}\n          </div>\n        </div>\n      `}getAvatarInitials(e){const t=e.data["first name"]||"",n=e.data["last name"]||"";return(t.charAt(0)+n.charAt(0)).toUpperCase()||"?"}getRelationshipToMain(e){return e.rels.father||e.rels.mother?"Child":e.rels.children&&e.rels.children.length>0?"Parent":e.rels.spouses&&e.rels.spouses.length>0?"Married":""}groupResultsByFamily(){const e={};return this.filteredResults.forEach(t=>{const n=t.data["last name"]||"Other";e[n]||(e[n]=[]),e[n].push(t)}),e}highlightMatch(e){if(!this.currentQuery)return e;const t=new RegExp(`(${this.escapeRegExp(this.currentQuery)})`,"gi");return e.replace(t,"<mark>$1</mark>")}escapeRegExp(e){return e.replace(/[.*+?^${}()|[\]\\]/g,"\\$&")}handleKeydown(e){if(this.isOpen)switch(e.key){case"ArrowDown":e.preventDefault(),this.selectedIndex=Math.min(this.selectedIndex+1,this.filteredResults.length-1),this.updateSelection();break;case"ArrowUp":e.preventDefault(),this.selectedIndex=Math.max(this.selectedIndex-1,-1),this.updateSelection();break;case"Enter":e.preventDefault(),this.selectedIndex>=0&&this.filteredResults[this.selectedIndex]&&this.selectPerson(this.filteredResults[this.selectedIndex].id);break;case"Escape":this.hideResults(),this.input.blur()}}updateSelection(){this.resultsList.querySelectorAll(".f3-dropdown-item").forEach((e,t)=>{t===this.selectedIndex?(e.classList.add("f3-dropdown-item-selected"),e.scrollIntoView({block:"nearest"})):e.classList.remove("f3-dropdown-item-selected")})}selectPerson(e){const t=this.config.data().find(t=>t.id===e);if(!t)return;this.input.value=this.getPersonDisplayName(t),this.hideResults(),this.config.onSelect&&this.config.onSelect(e,t);const n=new CustomEvent("person-selected",{detail:{personId:e,person:t}});this.dropdown.dispatchEvent(n)}showResults(){this.isOpen=!0,this.results.style.display="block",this.dropdown.classList.add("f3-dropdown-open")}hideResults(){this.isOpen=!1,this.results.style.display="none",this.dropdown.classList.remove("f3-dropdown-open"),this.selectedIndex=-1}clear(){this.input.value="",this.currentQuery="",this.hideResults()}setValue(e){this.input.value=e,this.currentQuery=e,e&&this.handleSearch()}getValue(){return this.input.value}focus(){this.input.focus()}setEnabled(e){this.input.disabled=!e,e||this.hideResults()}updateData(e){this.config.data=e,this.currentQuery&&this.handleSearch()}destroy(){this.dropdown.remove()}}class et{constructor(e={}){this.config={api:null,onSubmit:null,onCancel:null,validateOnChange:!0,autoSave:!1,...e},this.currentForm=null,this.formData={},this.validators={},this.isSubmitting=!1}createForm(e){const{container:t,person:n=null,fields:i=this.getDefaultFields(),title:s=(n?"Edit Person":"Add Person"),submitText:a="Save",cancelText:r="Cancel",showDelete:o=!!n,layout:l="vertical"}=e;this.currentPerson=n,this.formData=n?{...n.data}:{};const d=this.buildForm({fields:i,title:s,submitText:a,cancelText:r,showDelete:o,layout:l});return t&&(t.innerHTML="",t.appendChild(d)),this.currentForm=d,d}buildForm(e){const t=document.createElement("div");return t.className=`f3-form-builder f3-form-${e.layout}`,t.innerHTML=`\n      <div class="f3-form-header">\n        <h3 class="f3-form-title">${e.title}</h3>\n      </div>\n      \n      <form class="f3-form" novalidate>\n        <div class="f3-form-fields">\n          ${e.fields.map(e=>this.buildField(e)).join("")}\n        </div>\n        \n        <div class="f3-form-footer">\n          <div class="f3-form-actions">\n            <button type="button" class="f3-btn f3-btn-secondary" data-action="cancel">\n              ${e.cancelText}\n            </button>\n            ${e.showDelete?'\n              <button type="button" class="f3-btn f3-btn-danger" data-action="delete">\n                Delete\n              </button>\n            ':""}\n            <button type="submit" class="f3-btn f3-btn-primary" data-action="submit">\n              ${e.submitText}\n            </button>\n          </div>\n          <div class="f3-form-status" style="display: none;"></div>\n        </div>\n      </form>\n    `,this.attachFormEvents(t),this.populateForm(t),t}buildField(e){const{name:t,label:n,type:i="text",required:s=!1,placeholder:a="",options:r=[],validation:o={},helpText:l="",colspan:d=1}=e,c=`field_${t.replace(/\s+/g,"_")}`,h=s?"required":"",u=s?'<span class="f3-required">*</span>':"";let p="";switch(i){case"text":case"email":case"url":case"tel":p=`\n          <input \n            type="${i}" \n            id="${c}" \n            name="${t}" \n            class="f3-form-control" \n            placeholder="${a}"\n            ${h}\n          >\n        `;break;case"date":p=`\n          <input \n            type="date" \n            id="${c}" \n            name="${t}" \n            class="f3-form-control"\n            ${h}\n          >\n        `;break;case"select":const e=r.map(e=>`<option value="${"string"==typeof e?e:e.value}">${"string"==typeof e?e:e.label}</option>`).join("");p=`\n          <select id="${c}" name="${t}" class="f3-form-control" ${h}>\n            <option value="">Select...</option>\n            ${e}\n          </select>\n        `;break;case"textarea":p=`\n          <textarea \n            id="${c}" \n            name="${t}" \n            class="f3-form-control" \n            placeholder="${a}"\n            rows="3"\n            ${h}\n          ></textarea>\n        `;break;case"checkbox":p=`\n          <div class="f3-checkbox-wrapper">\n            <input \n              type="checkbox" \n              id="${c}" \n              name="${t}" \n              class="f3-form-checkbox"\n              ${h}\n            >\n            <label for="${c}" class="f3-checkbox-label">${n}</label>\n          </div>\n        `;break;case"radio":p=`<div class="f3-radio-group">${r.map(e=>{const n="string"==typeof e?e:e.value,i="string"==typeof e?e:e.label,s=`${c}_${n}`;return`\n            <div class="f3-radio-option">\n              <input type="radio" id="${s}" name="${t}" value="${n}" class="f3-form-radio">\n              <label for="${s}" class="f3-radio-label">${i}</label>\n            </div>\n          `}).join("")}</div>`;break;case"file":p=`\n          <input \n            type="file" \n            id="${c}" \n            name="${t}" \n            class="f3-form-control f3-form-file"\n            accept="image/*"\n            ${h}\n          >\n          <div class="f3-file-preview" style="display: none;">\n            <img class="f3-file-preview-img" alt="Preview">\n            <button type="button" class="f3-file-remove">Remove</button>\n          </div>\n        `}return`\n      <div class="f3-form-group" data-field="${t}" style="grid-column: span ${d};">\n        ${"checkbox"!==i?`\n          <label for="${c}" class="f3-form-label">\n            ${n} ${u}\n          </label>\n        `:""}\n        \n        <div class="f3-form-input-wrapper">\n          ${p}\n        </div>\n        \n        ${l?`<div class="f3-form-help">${l}</div>`:""}\n        <div class="f3-form-error" style="display: none;"></div>\n      </div>\n    `}attachFormEvents(e){const t=e.querySelector(".f3-form");t.addEventListener("submit",e=>{e.preventDefault(),this.handleSubmit()}),e.addEventListener("click",e=>{const t=e.target.dataset.action;t&&this.handleAction(t,e)}),this.config.validateOnChange&&(t.addEventListener("change",e=>{e.target.matches(".f3-form-control, .f3-form-checkbox, .f3-form-radio")&&this.validateField(e.target)}),t.addEventListener("input",e=>{e.target.matches(".f3-form-control")&&this.clearFieldError(e.target)})),t.addEventListener("change",e=>{"file"===e.target.type&&this.handleFileChange(e.target)}),this.config.autoSave&&t.addEventListener("input",this.debounce(()=>{this.autoSave()},1e3))}async handleAction(e,t){switch(e){case"submit":await this.handleSubmit();break;case"cancel":this.handleCancel();break;case"delete":await this.handleDelete()}}async handleSubmit(){if(!this.isSubmitting){this.isSubmitting=!0,this.showStatus("Saving...","info");try{if(!this.validateForm())return void this.showStatus("Please fix the errors above","error");const e=this.collectFormData(),t=this.currentPerson?{...this.currentPerson,data:{...this.currentPerson.data,...e}}:{id:this.generateId(),data:e,rels:{}};this.config.onSubmit&&await this.config.onSubmit(t,!this.currentPerson),this.showStatus("Saved successfully!","success"),this.currentPerson||this.resetForm()}catch(e){console.error("Form submission error:",e),this.showStatus("Failed to save. Please try again.","error")}finally{this.isSubmitting=!1}}}handleCancel(){this.config.onCancel?this.config.onCancel():this.resetForm()}async handleDelete(){if(!this.currentPerson)return;if(confirm("Are you sure you want to delete this person? This action cannot be undone."))try{this.showStatus("Deleting...","info"),this.config.api&&await this.config.api.deletePerson(this.currentPerson.id),this.showStatus("Person deleted successfully","success"),this.config.onCancel&&this.config.onCancel()}catch(e){console.error("Delete error:",e),this.showStatus("Failed to delete person","error")}}populateForm(e){if(!this.currentPerson)return;e.querySelector(".f3-form").querySelectorAll(".f3-form-control, .f3-form-checkbox, .f3-form-radio").forEach(e=>{const t=this.currentPerson.data[e.name];void 0!==t&&("checkbox"===e.type?e.checked=!!t:"radio"===e.type?e.checked=e.value===t:e.value=t)})}collectFormData(){const e=this.currentForm.querySelector(".f3-form"),t=new FormData(e),n={};for(const[e,i]of t.entries())n[e]=i;return e.querySelectorAll(".f3-form-checkbox").forEach(e=>{n[e.name]=e.checked}),n}validateForm(){const e=this.currentForm.querySelector(".f3-form").querySelectorAll(".f3-form-control, .f3-form-checkbox, .f3-form-radio");let t=!0;return e.forEach(e=>{this.validateField(e)||(t=!1)}),t}validateField(e){const t=e.closest(".f3-form-group"),n=t.dataset.field,i=this.getInputValue(e);if(e.hasAttribute("required")&&!i)return this.showFieldError(t,"This field is required"),!1;if(i){const n=this.validateFieldType(e,i);if(n.length>0)return this.showFieldError(t,n[0]),!1}if(this.validators[n]){const e=this.validators[n](i);if(e)return this.showFieldError(t,e),!1}return this.clearFieldError(t),!0}validateFieldType(e,t){const n=[];switch(e.type){case"email":/^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(t)||n.push("Please enter a valid email address");break;case"url":try{new URL(t)}catch{n.push("Please enter a valid URL")}break;case"tel":/^[\d\s\-\+\(\)]+$/.test(t)||n.push("Please enter a valid phone number");break;case"date":const e=new Date(t);isNaN(e.getTime())&&n.push("Please enter a valid date")}return n}getInputValue(e){if("checkbox"===e.type)return e.checked;if("radio"===e.type){const t=e.closest("form").querySelector(`input[name="${e.name}"]:checked`);return t?t.value:""}return e.value.trim()}showFieldError(e,t){const n=e.querySelector(".f3-form-error"),i=e.querySelector(".f3-form-input-wrapper");n.textContent=t,n.style.display="block",e.classList.add("f3-form-group-error"),i.classList.add("f3-form-input-error")}clearFieldError(e){const t=e.closest?e.closest(".f3-form-group"):e,n=t.querySelector(".f3-form-error"),i=t.querySelector(".f3-form-input-wrapper");n.style.display="none",t.classList.remove("f3-form-group-error"),i.classList.remove("f3-form-input-error")}handleFileChange(e){const t=e.files[0],n=e.parentNode.querySelector(".f3-file-preview");if(t&&t.type.startsWith("image/")){const e=new FileReader;e.onload=e=>{n.querySelector(".f3-file-preview-img").src=e.target.result,n.style.display="block"},e.readAsDataURL(t)}else n.style.display="none"}showStatus(e,t="info"){const n=this.currentForm.querySelector(".f3-form-status");n.textContent=e,n.className=`f3-form-status f3-status-${t}`,n.style.display="block","success"===t&&setTimeout(()=>{n.style.display="none"},3e3)}resetForm(){if(!this.currentForm)return;const e=this.currentForm.querySelector(".f3-form");e.reset();e.querySelectorAll(".f3-form-error").forEach(e=>e.style.display="none");e.querySelectorAll(".f3-form-group-error").forEach(e=>e.classList.remove("f3-form-group-error"));e.querySelectorAll(".f3-form-input-error").forEach(e=>e.classList.remove("f3-form-input-error"));const t=e.querySelector(".f3-form-status");t&&(t.style.display="none")}async autoSave(){if(this.currentPerson&&!this.isSubmitting)try{const e=this.collectFormData(),t={...this.currentPerson,data:{...this.currentPerson.data,...e}};this.config.api&&(await this.config.api.updatePerson(t.id,t),this.showStatus("Auto-saved","success"))}catch(e){console.error("Auto-save failed:",e)}}addValidator(e,t){this.validators[e]=t}removeValidator(e){delete this.validators[e]}getDefaultFields(){return[{name:"first name",label:"First Name",type:"text",required:!0,placeholder:"Enter first name"},{name:"last name",label:"Last Name",type:"text",required:!0,placeholder:"Enter last name"},{name:"gender",label:"Gender",type:"select",options:[{value:"M",label:"Male"},{value:"F",label:"Female"}]},{name:"birthday",label:"Birth Date",type:"date"},{name:"avatar",label:"Photo URL",type:"url",placeholder:"https://example.com/photo.jpg"},{name:"profession",label:"Profession",type:"text",placeholder:"Enter profession"},{name:"location",label:"Location",type:"text",placeholder:"Enter location"},{name:"notes",label:"Notes",type:"textarea",placeholder:"Additional information..."}]}createRelationshipForm(e,t,n){return this.createForm({container:n,fields:[{name:"relationship_type",label:"Relationship Type",type:"select",required:!0,options:[{value:"spouse",label:"Spouse"},{value:"child",label:"Child"},{value:"parent",label:"Parent"},{value:"sibling",label:"Sibling"}]},{name:"start_date",label:"Relationship Start Date",type:"date",helpText:"Optional: When did this relationship begin?"},{name:"end_date",label:"Relationship End Date",type:"date",helpText:"Optional: When did this relationship end?"},{name:"notes",label:"Notes",type:"textarea",placeholder:"Additional details about this relationship..."}],title:"Create Relationship",submitText:"Create Relationship",showDelete:!1})}createQuickAddForm(e,t=null){const n=[{name:"first name",label:"First Name",type:"text",required:!0,placeholder:"Enter first name"},{name:"last name",label:"Last Name",type:"text",required:!0,placeholder:"Enter last name"},{name:"gender",label:"Gender",type:"radio",required:!0,options:[{value:"M",label:"Male"},{value:"F",label:"Female"}]}];return t&&n.push({name:"relationship_to_target",label:`Relationship to ${t.targetName}`,type:"select",required:!0,options:[{value:"spouse",label:"Spouse"},{value:"child",label:"Child"},{value:"parent",label:"Parent"},{value:"sibling",label:"Sibling"}]}),this.createForm({container:e,fields:n,title:"Quick Add Person",submitText:"Add Person",layout:"compact"})}debounce(e,t){let n;return function(...i){clearTimeout(n),n=setTimeout(()=>{clearTimeout(n),e(...i)},t)}}generateId(){return"xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx".replace(/[xy]/g,function(e){var t=16*Math.random()|0;return("x"==e?t:3&t|8).toString(16)})}exportFormData(){return JSON.stringify(this.collectFormData(),null,2)}importFormData(e){try{const t="string"==typeof e?JSON.parse(e):e;this.populateFormWithData(t)}catch(e){throw console.error("Failed to import form data:",e),new Error("Invalid JSON data")}}populateFormWithData(e){if(!this.currentForm)return;this.currentForm.querySelector(".f3-form").querySelectorAll(".f3-form-control, .f3-form-checkbox, .f3-form-radio").forEach(t=>{const n=e[t.name];void 0!==n&&("checkbox"===t.type?t.checked=!!n:"radio"===t.type?t.checked=t.value===n:t.value=n)})}getValidationState(){const e=this.currentForm.querySelector(".f3-form").querySelectorAll(".f3-form-control, .f3-form-checkbox, .f3-form-radio"),t={isValid:!0,errors:{},fields:{}};return e.forEach(e=>{const n=e.closest(".f3-form-group"),i=n.dataset.field,s=this.getInputValue(e);if(t.fields[i]={value:s,isValid:this.validateField(e),element:e},!t.fields[i].isValid){t.isValid=!1;const e=n.querySelector(".f3-form-error");t.errors[i]=e.textContent}}),t}setReadOnly(e=!0){if(!this.currentForm)return;const t=this.currentForm.querySelector(".f3-form"),n=t.querySelectorAll(".f3-form-control, .f3-form-checkbox, .f3-form-radio"),i=t.querySelector('[data-action="submit"]');n.forEach(t=>{t.disabled=e}),i&&(i.disabled=e),this.currentForm.classList.toggle("f3-form-readonly",e)}destroy(){this.currentForm&&(this.currentForm.remove(),this.currentForm=null),this.formData={},this.validators={}}}class tt{constructor(){this.relationshipCache=new Map}calculate(e,t,n={}){const{maxDepth:i=10,includeInLaws:s=!0,includeStepRelations:a=!0,cacheResults:r=!0}=n,o=`${e}-${t.length}-${JSON.stringify(n)}`;if(r&&this.relationshipCache.has(o))return this.relationshipCache.get(o);const l=t.find(t=>t.id===e);if(!l)return{};const d={},c=new Set;return this.calculateDirectRelationships(l,t,d,c,0,i),s&&this.calculateInLawRelationships(l,t,d),a&&this.calculateStepRelationships(l,t,d),r&&this.relationshipCache.set(o,d),d}calculateDirectRelationships(e,t,n,i,s,a){if(!(s>a||i.has(e.id))){if(i.add(e.id),e.rels.father){const r=t.find(t=>t.id===e.rels.father);r&&!n[r.id]&&(n[r.id]=this.getParentRelationship("father",s),this.calculateDirectRelationships(r,t,n,i,s+1,a))}if(e.rels.mother){const r=t.find(t=>t.id===e.rels.mother);r&&!n[r.id]&&(n[r.id]=this.getParentRelationship("mother",s),this.calculateDirectRelationships(r,t,n,i,s+1,a))}e.rels.children&&e.rels.children.forEach(e=>{const r=t.find(t=>t.id===e);r&&!n[r.id]&&(n[r.id]=this.getChildRelationship(r.data.gender,s),this.calculateDirectRelationships(r,t,n,i,s+1,a))}),this.calculateSiblingRelationships(e,t,n,s),e.rels.spouses&&e.rels.spouses.forEach(e=>{const i=t.find(t=>t.id===e);i&&!n[i.id]&&(n[i.id]="spouse")})}}calculateSiblingRelationships(e,t,n,i){this.findSiblings(e,t).forEach(e=>{n[e.id]||(n[e.id]=this.getSiblingRelationship(e.data.gender,i))})}findSiblings(e,t){const n=[],{father:i,mother:s}=e.rels;return(i||s)&&t.forEach(t=>{if(t.id===e.id)return;const a=i&&t.rels.father===i,r=s&&t.rels.mother===s;(a||r)&&n.push(t)}),n}calculateInLawRelationships(e,t,n){e.rels.spouses&&e.rels.spouses.forEach(e=>{const i=t.find(t=>t.id===e);if(!i)return;if(i.rels.father){const e=t.find(e=>e.id===i.rels.father);e&&!n[e.id]&&(n[e.id]="father-in-law")}if(i.rels.mother){const e=t.find(e=>e.id===i.rels.mother);e&&!n[e.id]&&(n[e.id]="mother-in-law")}this.findSiblings(i,t).forEach(e=>{n[e.id]||(n[e.id]="M"===e.data.gender?"brother-in-law":"sister-in-law")})}),e.rels.children&&e.rels.children.forEach(e=>{const i=t.find(t=>t.id===e);i&&i.rels.spouses&&i.rels.spouses.forEach(e=>{const s=t.find(t=>t.id===e);s&&!n[s.id]&&(n[s.id]="M"===i.data.gender?"daughter-in-law":"son-in-law")})})}calculateStepRelationships(e,t,n){["father","mother"].forEach(i=>{if(e.rels[i]){const s=t.find(t=>t.id===e.rels[i]);s&&s.rels.spouses&&s.rels.spouses.forEach(e=>{const s=t.find(t=>t.id===e);s&&!n[s.id]&&(n[s.id]=`step-${i}`)})}}),["father","mother"].forEach(i=>{if(e.rels[i]){const s=t.find(t=>t.id===e.rels[i]);s&&s.rels.spouses&&s.rels.spouses.forEach(i=>{const s=t.find(e=>e.id===i);s&&s.rels.children&&s.rels.children.forEach(i=>{if(i!==e.id&&!n[i]){const e=t.find(e=>e.id===i);e&&(n[i]="M"===e.data.gender?"step-brother":"step-sister")}})})}})}getParentRelationship(e,t){if(0===t)return e;if(1===t)return`grand${e}`;return`${"great-".repeat(t-1)}grand${e}`}getChildRelationship(e,t){const n="M"===e?"son":"daughter";if(0===t)return n;if(1===t)return`grand${n}`;return`${"great-".repeat(t-1)}grand${n}`}getSiblingRelationship(e,t){return 0===t?"M"===e?"brother":"sister":this.getCousinRelationship(t)}getCousinRelationship(e){return 1===e?"cousin":2===e?"2nd cousin":3===e?"3rd cousin":`${e}th cousin`}getRelationshipBetween(e,t,n){if(e===t)return"self";return this.calculate(e,n)[t]||"no relation"}findCommonAncestors(e,t,n){const i=this.getAncestors(e,n),s=this.getAncestors(t,n);return i.filter(e=>s.some(t=>t.id===e.id))}getAncestors(e,t,n=10){const i=[],s=new Set,a=(e,r)=>{if(r>n||s.has(e))return;s.add(e);const o=t.find(t=>t.id===e);o&&["father","mother"].forEach(e=>{if(o.rels[e]){const n=t.find(t=>t.id===o.rels[e]);n&&(i.push({...n,generation:r,relationship:this.getParentRelationship(e,r-1)}),a(n.id,r+1))}})};return a(e,1),i}getDescendants(e,t,n=10){const i=[],s=new Set,a=(e,r)=>{if(r>n||s.has(e))return;s.add(e);const o=t.find(t=>t.id===e);o&&o.rels.children&&o.rels.children.forEach(e=>{const n=t.find(t=>t.id===e);n&&(i.push({...n,generation:r,relationship:this.getChildRelationship(n.data.gender,r-1)}),a(n.id,r+1))})};return a(e,1),i}calculateFamilyStats(e){const t={totalPeople:e.length,males:0,females:0,marriages:0,generations:0,oldestPerson:null,youngestPerson:null,averageAge:0,familyNames:new Set};let n=0,i=0;if(e.forEach(e=>{if("M"===e.data.gender?t.males++:"F"===e.data.gender&&t.females++,e.data.birthday){const s=new Date(e.data.birthday),a=this.calculateAge(s);a>=0&&(n+=a,i++,(!t.oldestPerson||a>this.calculateAge(new Date(t.oldestPerson.data.birthday)))&&(t.oldestPerson=e),(!t.youngestPerson||a<this.calculateAge(new Date(t.youngestPerson.data.birthday)))&&(t.youngestPerson=e))}e.data["last name"]&&t.familyNames.add(e.data["last name"]),e.rels.spouses&&(t.marriages+=e.rels.spouses.length)}),t.averageAge=i>0?Math.round(n/i):0,t.marriages=Math.floor(t.marriages/2),t.familyNames=Array.from(t.familyNames),e.length>0){const n=e[0],i=this.getAncestors(n.id,e),s=this.getDescendants(n.id,e),a=i.length>0?Math.max(...i.map(e=>e.generation)):0,r=s.length>0?Math.max(...s.map(e=>e.generation)):0;t.generations=a+r+1}return t}calculateAge(e){const t=new Date;let n=t.getFullYear()-e.getFullYear();const i=t.getMonth()-e.getMonth();return(i<0||0===i&&t.getDate()<e.getDate())&&n--,n}clearCache(){this.relationshipCache.clear()}getRelationshipSuggestions(e,t,n){const i=n.find(t=>t.id===e),s=n.find(e=>e.id===t);if(!i||!s)return[];const a=[],r=i.data.birthday?this.calculateAge(new Date(i.data.birthday)):null,o=s.data.birthday?this.calculateAge(new Date(s.data.birthday)):null;if(null!==r&&null!==o){const e=Math.abs(r-o);e<5?(a.push({type:"sibling",confidence:.8}),a.push({type:"spouse",confidence:.6})):e>=20&&e<=40?r>o?a.push({type:"parent",confidence:.7,note:`${i.data["first name"]} could be parent of ${s.data["first name"]}`}):a.push({type:"child",confidence:.7,note:`${i.data["first name"]} could be child of ${s.data["first name"]}`}):e>=40&&(r>o?a.push({type:"grandparent",confidence:.6,note:`${i.data["first name"]} could be grandparent of ${s.data["first name"]}`}):a.push({type:"grandchild",confidence:.6,note:`${i.data["first name"]} could be grandchild of ${s.data["first name"]}`}))}return i.data["last name"]&&s.data["last name"]&&i.data["last name"]===s.data["last name"]&&(a.push({type:"sibling",confidence:.5,note:"Same last name"}),a.push({type:"cousin",confidence:.4,note:"Same family name"})),i.data.gender&&s.data.gender&&i.data.gender!==s.data.gender&&a.push({type:"spouse",confidence:.3}),a.sort((e,t)=>t.confidence-e.confidence)}validateFamilyTree(e){const t=[],n=[];return e.forEach(i=>{this.hasCircularRelationship(i.id,e)&&t.push({type:"circular_relationship",personId:i.id,message:`${i.data["first name"]} ${i.data["last name"]} has circular family relationships`}),i.rels.children&&i.rels.children.forEach(t=>{const s=e.find(e=>e.id===t);if(s&&i.data.birthday&&s.data.birthday){this.calculateAge(new Date(i.data.birthday))-this.calculateAge(new Date(s.data.birthday))<12&&n.push({type:"impossible_age",personId:i.id,relatedPersonId:t,message:`${i.data["first name"]} was too young to be parent of ${s.data["first name"]}`})}}),i.rels.children&&i.rels.children.forEach(t=>{const s=e.find(e=>e.id===t);if(s){const e=s.rels.father===i.id?s.rels.mother:s.rels.father;if(e){i.rels.spouses&&i.rels.spouses.includes(e)||n.push({type:"missing_spouse_relation",personId:i.id,relatedPersonId:e,message:`${i.data["first name"]} should be marked as spouse of other parent`})}}}),["father","mother"].forEach(s=>{if(i.rels[s]){const a=e.find(e=>e.id===i.rels[s]);a?a.rels.children&&a.rels.children.includes(i.id)||n.push({type:"asymmetric_relationship",personId:i.id,relatedPersonId:a.id,message:`${s} relationship is not reciprocal`}):t.push({type:"orphaned_relationship",personId:i.id,message:`${i.data["first name"]} references missing ${s}`})}})}),{isValid:0===t.length,errors:t,warnings:n,summary:{totalErrors:t.length,totalWarnings:n.length,peopleAffected:new Set([...t,...n].map(e=>e.personId)).size}}}hasCircularRelationship(e,t,n=new Set){if(n.has(e))return!0;n.add(e);const i=t.find(t=>t.id===e);if(!i)return!1;const s=[i.rels.father,i.rels.mother].filter(Boolean);for(const e of s)if(this.hasCircularRelationship(e,t,new Set(n)))return!0;return!1}fixRelationshipInconsistencies(e){const t=JSON.parse(JSON.stringify(e));return t.forEach(e=>{["father","mother"].forEach(n=>{if(e.rels[n]){const i=t.find(t=>t.id===e.rels[n]);i&&(i.rels.children||(i.rels.children=[]),i.rels.children.includes(e.id)||i.rels.children.push(e.id))}}),e.rels.spouses&&e.rels.spouses.forEach(n=>{const i=t.find(e=>e.id===n);i&&(i.rels.spouses||(i.rels.spouses=[]),i.rels.spouses.includes(e.id)||i.rels.spouses.push(e.id))}),e.rels.children&&e.rels.children.forEach(n=>{const i=t.find(e=>e.id===n);if(i){const t=i.rels.father===e.id?i.rels.mother:i.rels.father;t&&t!==e.id&&(e.rels.spouses||(e.rels.spouses=[]),e.rels.spouses.includes(t)||e.rels.spouses.push(t))}})}),t}getRelationshipPath(e,t,n){if(e===t)return[{personId:e,relationship:"self"}];const i=new Set,s=[{personId:e,path:[{personId:e,relationship:"start"}]}];for(;s.length>0;){const{personId:e,path:a}=s.shift();if(i.has(e))continue;i.add(e);const r=n.find(t=>t.id===e);if(!r)continue;const o=this.getDirectConnections(r,n);for(const e of o){if(e.personId===t)return[...a,{personId:e.personId,relationship:e.relationship}];!i.has(e.personId)&&a.length<10&&s.push({personId:e.personId,path:[...a,{personId:e.personId,relationship:e.relationship}]})}}return[]}getDirectConnections(e,t){const n=[];["father","mother"].forEach(t=>{e.rels[t]&&n.push({personId:e.rels[t],relationship:t})}),e.rels.children&&e.rels.children.forEach(e=>{const i=t.find(t=>t.id===e);i&&n.push({personId:e,relationship:"M"===i.data.gender?"son":"daughter"})}),e.rels.spouses&&e.rels.spouses.forEach(e=>{n.push({personId:e,relationship:"spouse"})});return this.findSiblings(e,t).forEach(e=>{n.push({personId:e.id,relationship:"M"===e.data.gender?"brother":"sister"})}),n}exportKinshipData(e,t){const n=this.calculate(e,t),i=t.find(t=>t.id===e);return{targetPerson:{id:i.id,name:`${i.data["first name"]||""} ${i.data["last name"]||""}`.trim(),data:i.data},relationships:Object.entries(n).map(([e,n])=>{const i=t.find(t=>t.id===e);return{personId:e,name:i?`${i.data["first name"]||""} ${i.data["last name"]||""}`.trim():"Unknown",relationship:n,data:i?i.data:null}}),statistics:this.calculateFamilyStats(t),generatedAt:(new Date).toISOString()}}}const nt={CalculateTree:C,createStore:function(e){let t;const n=e;return n.main_id_history=[],{state:n,updateTree:e=>{n.tree=C({data:n.data,main_id:n.main_id,node_separation:n.node_separation,level_separation:n.level_separation,single_parent_empty_card:n.single_parent_empty_card,is_horizontal:n.is_horizontal,one_level_rels:n.one_level_rels,sortChildrenFunction:n.sortChildrenFunction,sortSpousesFunction:n.sortSpousesFunction,ancestry_depth:n.ancestry_depth,progeny_depth:n.progeny_depth,show_siblings_of_main:n.show_siblings_of_main,modifyTreeHierarchy:n.modifyTreeHierarchy,private_cards_config:n.private_cards_config,duplicate_branch_toggle:n.duplicate_branch_toggle}),n.main_id||s(n.tree.main_id),t&&t(e)},updateData:e=>n.data=e,updateMainId:s,getMainId:()=>n.main_id,getData:()=>n.data,getTree:()=>n.tree,setOnUpdate:e=>t=e,getMainDatum:function(){return n.data.find(e=>e.id===n.main_id)},getDatum:i,getTreeMainDatum:function(){return n.tree?n.tree.data.find(e=>e.data.id===n.main_id):null},getTreeDatum:function(e){return n.tree?n.tree.data.find(t=>t.data.id===e):null},getLastAvailableMainDatum:function(){let e=n.main_id_history.slice(0).reverse().find(e=>i(e));e||(e=n.data[0].id);e!==n.main_id&&s(e);return i(e)},methods:{}};function i(e){return n.data.find(t=>t.id===e)}function s(e){e!==n.main_id&&(n.main_id_history=n.main_id_history.filter(t=>t!==e).slice(-10),n.main_id_history.push(e),n.main_id=e)}},view:function(e,n,s,a={}){a.initial=a.hasOwnProperty("initial")?a.initial:!t.select(n.parentNode).select(".card_cont").node(),a.transition_time=a.hasOwnProperty("transition_time")?a.transition_time:2e3,a.cardComponent?function(e,n,s,a={}){const r=t.select(A(()=>e)).selectAll("div.card_cont_fake").data(n.data,e=>e.data.id),o=r.exit(),l=r.enter().append("div").attr("class","card_cont_fake").style("display","none"),d=l.merge(r);o.each(e=>i(e,!1,!0)),l.each(e=>i(e,!0,!1)),o.each(function(e){const n=t.select(s(e)),i=t.select(this);n.transition().duration(a.transition_time).style("opacity",0).style("transform",`translate(${e._x}px, ${e._y}px)`).on("end",()=>i.remove())}),r.each(function(e){}),l.each(function(e){t.select(s(e)).style("position","absolute").style("top","0").style("left","0").style("opacity",0).style("transform",`translate(${e._x}px, ${e._y}px)`)}),d.each(function(e){const i=t.select(s(e)),r=a.initial?P(n,e,a.transition_time):0;i.transition().duration(a.transition_time).delay(r).style("transform",`translate(${e.x}px, ${e.y}px)`).style("opacity",1)})}(a.cardComponent,e,s,a):a.cardHtml?function(e,n,s,a={}){const r=t.select(e).select(".cards_view").selectAll("div.card_cont").data(n.data,e=>e.tid),o=r.exit(),l=r.enter().append("div").attr("class","card_cont").style("pointer-events","none"),d=l.merge(r);o.each(e=>i(e,!1,!0)),l.each(e=>i(e,!0,!1)),o.each(function(e){const n=t.select(this);n.transition().duration(a.transition_time).style("opacity",0).style("transform",`translate(${e._x}px, ${e._y}px)`).on("end",()=>n.remove())}),r.each(function(e){}),l.each(function(e){t.select(this).style("position","absolute").style("top","0").style("left","0").style("transform",`translate(${e._x}px, ${e._y}px)`).style("opacity",0),s.call(this,e)}),d.each(function(e){s.call(this,e);const i=a.initial?P(n,e,a.transition_time):0;t.select(this).transition().duration(a.transition_time).delay(i).style("transform",`translate(${e.x}px, ${e.y}px)`).style("opacity",1)})}(a.cardHtml,e,s,a):function(e,n,s,a={}){const r=t.select(e).select(".cards_view").selectAll("g.card_cont").data(n.data,e=>e.data.id),o=r.exit(),l=r.enter().append("g").attr("class","card_cont"),d=l.merge(r);o.each(e=>i(e,!1,!0)),l.each(e=>i(e,!0,!1)),o.each(function(e){const n=t.select(this);n.transition().duration(a.transition_time).style("opacity",0).attr("transform",`translate(${e._x}, ${e._y})`).on("end",()=>n.remove())}),r.each(function(e){}),l.each(function(e){t.select(this).attr("transform",`translate(${e._x}, ${e._y})`).style("opacity",0),s.call(this,e)}),d.each(function(e){s.call(this,e);const i=a.initial?P(n,e,a.transition_time):0;t.select(this).transition().duration(a.transition_time).delay(i).attr("transform",`translate(${e.x}, ${e.y})`).style("opacity",1)})}(n,e,s,a),function(e,n,i={}){const s=n.data.reduce((e,t)=>(function({d:e,tree:t,is_horizontal:n=!1}){const i=[];return(e.spouses||e._spouse)&&function({d:e}){function t(e,t){return{d:[[e.x,e.y],[t.x,t.y]],_d:()=>[e.is_ancestry?[a(e,"x")-1e-4,a(e,"y")]:[e.x,e.y],e.is_ancestry?[a(t,"x"),a(t,"y")]:[e.x-1e-4,e.y]],curve:!1,id:o(e,t),depth:e.depth,spouse:!0,is_ancestry:t.is_ancestry,source:e,target:t}}e.spouses?e.spouses.forEach(n=>i.push(t(e,n))):e._spouse&&i.push(t(e,e._spouse))}({d:e}),function({d:e}){if(!e.parents)return;const t=e.parents[0],n=e.parents[1]||t,a={x:s(t,n,"x"),y:s(t,n,"y")};i.push({d:r(e,a),_d:()=>r({x:e.x,y:e.y},{x:e.x,y:e.y}),curve:!0,id:o(e,t,n),depth:e.depth+1,is_ancestry:!0,source:e,target:[t,n]})}({d:e}),function({d:e}){e.children&&0!==e.children.length&&e.children.forEach((t,s)=>{const l=function(e,t){const n=(t.spouses||[]).find(t=>t.data.id===e.data.rels.mother||t.data.id===e.data.rels.father);return n}(t,e)||e,d=l.sx,c=n?{x:e.x,y:d}:{x:d,y:e.y};i.push({d:r(t,c),_d:()=>r(c,{x:a(c,"x"),y:a(c,"y")}),curve:!0,id:o(t,e,l),depth:e.depth+1,is_ancestry:!1,source:[e,l],target:t})})}({d:e}),i;function s(e,t,n,i){return e[n]-(e[n]-t[n])/2}function a(e,t){return e.hasOwnProperty("_"+t)?e["_"+t]:e[t]}function r(e,t){return n?function(e,t){const n=e.x+(t.x-e.x)/2;return[[e.x,e.y],[n,e.y],[n,e.y],[n,t.y],[n,t.y],[t.x,t.y]]}(e,t):function(e,t){const n=e.y+(t.y-e.y)/2;return[[e.x,e.y],[e.x,n],[e.x,n],[t.x,n],[t.x,n],[t.x,t.y]]}(e,t)}function o(...e){return e.map(e=>e.tid).sort().join(", ")}}({d:t,tree:n.data,is_horizontal:n.is_horizontal}).forEach(t=>e[t.id]=t),e),{}),a=Object.values(s),r=t.select(e).select(".links_view").selectAll("path.link").data(a,e=>e.id),o=r.exit(),l=r.enter().append("path").attr("class","link"),d=l.merge(r);o.each(function(e){const n=t.select(this);n.transition("op").duration(800).style("opacity",0),n.transition("path").duration(i.transition_time).attr("d",D(e,!0)).on("end",()=>n.remove())}),l.each(function(e){t.select(this).attr("fill","none").attr("stroke","#fff").attr("stroke-width",1).style("opacity",0).attr("d",D(e,!0))}),d.each(function(e){const s=t.select(this),a=i.initial?P(n,e,i.transition_time):0;s.transition("path").duration(i.transition_time).delay(a).attr("d",D(e)).style("opacity",1)})}(n,e,a);const r=a.tree_position||"fit";return a.initial?k({svg:n,svg_dim:n.getBoundingClientRect(),tree_dim:e.dim,transition_time:0}):"fit"===r?k({svg:n,svg_dim:n.getBoundingClientRect(),tree_dim:e.dim,transition_time:a.transition_time}):"main_to_middle"===r&&I({datum:e.data[0],svg:n,svg_dim:n.getBoundingClientRect(),scale:a.scale,transition_time:a.transition_time}),!0},createSvg:function(e,n={}){const i=e.getBoundingClientRect(),s=`\n    <svg class="main_svg">\n      <rect width="${i.width}" height="${i.height}" fill="transparent" />\n      <g class="view">\n        <g class="links_view"></g>\n        <g class="cards_view"></g>\n      </g>\n      <g style="transform: translate(100%, 100%)">\n        <g class="fit_screen_icon cursor-pointer" style="transform: translate(-50px, -50px); display: none">\n          <rect width="27" height="27" stroke-dasharray="13.5" stroke-dashoffset="6.75" \n            style="stroke:#fff;stroke-width:4px;fill:transparent;"/>\n          <circle r="5" cx="13.5" cy="13.5" style="fill:#fff" />          \n        </g>\n      </g>\n    </svg>\n  `,a=function(e){let n=e.querySelector("#f3Canvas");n||(n=t.create("div").attr("id","f3Canvas").attr("style","position: relative; overflow: hidden; width: 100%; height: 100%;").node());return n}(e),r=t.create("div").node();r.innerHTML=s;const o=r.querySelector("svg");return a.appendChild(o),e.appendChild(a),function(e,n={}){if(e.__zoom)return;const i=e.querySelector(".view"),s=t.zoom().on("zoom",n.onZoom||a);t.select(e).call(s),e.__zoomObj=s,n.zoom_polite&&s.filter(r);function a(e){t.select(i).attr("transform",e.transform)}function r(e){return!("wheel"===e.type&&!e.ctrlKey)&&!(e.touches&&e.touches.length<2)}}(a,n),o},handlers:ve,elements:De,htmlHandlers:R,icons:ye,createChart:function(e,t,n={}){const i=Ve(e,t);if(i._treeEditor=null,i._personDropdown=null,i._formBuilder=null,i._kinshipCalculator=new tt,i._beforeUpdateCallbacks=[],i._afterUpdateCallbacks=[],n.apiConfig&&(i.api=new Ge(n.apiConfig),i.loadFromApi=async function(e){try{e&&this.api.setFamilyId(e);const t=await this.api.fetchFamily();return this.updateData(t),this.updateTree({initial:!0}),t}catch(e){throw console.error("Failed to load from API:",e),e}},i.saveToApi=async function(){try{const e=this.store.getData();return await this.api.saveFamily(e),!0}catch(e){throw console.error("Failed to save to API:",e),e}},i.setApiConfig=function(e){return this.api=new Ge(e),this},n.autoSave)){const e=i.updateData.bind(i);i.updateData=function(t){return e(t),n.autoSave&&setTimeout(()=>this.saveToApi().catch(console.error),1e3),this}}return i.updateMain=async function(e){try{return this._beforeUpdateCallbacks.forEach(t=>t(e)),this.store.updateMainId(e.data?e.data.id:e.id),this.store.updateTree({}),this.api&&await this.saveToApi(),this._afterUpdateCallbacks.forEach(t=>t(e)),this}catch(e){throw console.error("Failed to update main person:",e),e}},i.updateMainId=async function(e){try{const t=this.store.getDatum(e);if(!t)throw new Error(`Person with ID ${e} not found`);return await this.updateMain(t)}catch(e){throw console.error("Failed to update main person by ID:",e),e}},i.getMainDatum=function(){return this.store.getMainDatum()},i.setBeforeUpdate=function(e){return"function"==typeof e&&this._beforeUpdateCallbacks.push(e),this},i.setAfterUpdate=function(e){return"function"==typeof e&&this._afterUpdateCallbacks.push(e),this},i.setSortChildrenFunction=function(e){return this.store.state.sortChildrenFunction=e,this},i.setSortSpousesFunction=function(e){return this.store.state.sortSpousesFunction=e,this},i.setAncestryDepth=function(e){return this.store.state.ancestry_depth=e,this},i.setProgenyDepth=function(e){return this.store.state.progeny_depth=e,this},i.setDuplicateBranchToggle=function(e){return this.store.state.duplicate_branch_toggle=e,this},i.setTransitionTime=function(e){return this.transition_time=e,this},i.getMaxDepth=function(e){const t=this.store.getData(),n=t.find(t=>t.id===e);if(!n)return{ancestry:0,progeny:0};const i=(e,n=0)=>{const s=e.rels.father?t.find(t=>t.id===e.rels.father):null,a=e.rels.mother?t.find(t=>t.id===e.rels.mother):null,r=s?i(s,n+1):n,o=a?i(a,n+1):n;return Math.max(r,o)},s=(e,n=0)=>{if(!e.rels.children||0===e.rels.children.length)return n;const i=e.rels.children.map(e=>{const i=t.find(t=>t.id===e);return i?s(i,n+1):n});return Math.max(...i)};return{ancestry:i(n),progeny:s(n)}},i.editTree=function(e={}){return this._treeEditor||(this._treeEditor=new Ye(this.cont,this.store,{api:this.api,onPersonAdd:async e=>{if(this.api)try{const t=await this.api.addPerson(e);return this.updateData(await this.api.fetchFamily()),this.updateTree({}),t}catch(e){throw console.error("Failed to add person via API:",e),e}},onPersonUpdate:async(e,t)=>{if(this.api)try{const n=await this.api.updatePerson(e,t);return this.updateData(await this.api.fetchFamily()),this.updateTree({}),n}catch(e){throw console.error("Failed to update person via API:",e),e}},onPersonDelete:async e=>{if(this.api)try{const t=await this.api.deletePerson(e);return this.updateData(await this.api.fetchFamily()),this.updateTree({}),t}catch(e){throw console.error("Failed to delete person via API:",e),e}},...e})),this._treeEditor},i.calculateKinships=function(e,t={}){const n=this.store.getData();return this._kinshipCalculator.calculate(e,n,t)},i.getKinshipsDataStash=function(e,t){const n=this.store.getData(),i=this.calculateKinships(e.id);return{person:e,target:t,relationship:i[t.id]||"no relation",data:n,kinships:i}},i.setCardWithMongoDB=function(e){const t=this.setCard(e);if(this.api){const e=t;if(e.onEdit){const t=e.onEdit.bind(e);e.onEdit=async function(e){try{await i.api.updatePerson(e.id,e),i.updateData(await i.api.fetchFamily()),i.updateTree({})}catch(e){console.error("Failed to save person edit:",e)}t(e)}}if(e.onDelete){const t=e.onDelete.bind(e);e.onDelete=async function(e){try{await i.api.deletePerson(e),i.updateData(await i.api.fetchFamily()),i.updateTree({})}catch(e){console.error("Failed to delete person:",e)}t(e)}}}return t},i.createFormWithMongoDB=function(e){return this._formBuilder||(this._formBuilder=new et({api:this.api,onSubmit:async(e,t)=>{try{t?await this.api.addPerson(e):await this.api.updatePerson(e.id,e),this.updateData(await this.api.fetchFamily()),this.updateTree({})}catch(e){throw console.error("Failed to save form data:",e),e}}})),this._formBuilder.createForm(e)},i.setPersonDropdownMongoDB=function(e={},t=null){const n=t||this.cont.querySelector(".f3-nav-cont");return n?(this._personDropdown=new Xe(n,{data:()=>this.store.getData(),onSelect:t=>{this.updateMainId(t),e.onSelect&&e.onSelect(t)},searchFields:["first name","last name","data.name","data.title"],...e}),this._personDropdown):(console.warn("No container found for person dropdown"),null)},i.enableAddRelativeMongoDB=function(e={}){return this._addRelativeConfig={onAdd:async(e,t,n)=>{try{const i=await this.api.addPerson(e),s=this.store.getDatum(n);return s&&(this.updateRelationships(i,s,t),await this.api.updatePerson(n,s)),this.updateData(await this.api.fetchFamily()),this.updateTree({}),i}catch(e){throw console.error("Failed to add relative:",e),e}},...e},this},i.enableRemoveRelativeMongoDB=function(e={}){return this._removeRelativeConfig={onRemove:async(t,n,i)=>{try{const s=this.store.getDatum(n);s&&(this.removeRelationships(t,s,i),await this.api.updatePerson(n,s)),e.deletePerson&&await this.api.deletePerson(t),this.updateData(await this.api.fetchFamily()),this.updateTree({})}catch(e){throw console.error("Failed to remove relative:",e),e}},...e},this},i.updateRelationships=function(e,t,n){switch(n){case"child":t.rels.children||(t.rels.children=[]),t.rels.children.push(e.id),e.rels["M"===t.data.gender?"father":"mother"]=t.id;break;case"parent":e.rels.children||(e.rels.children=[]),e.rels.children.push(t.id),t.rels["M"===e.data.gender?"father":"mother"]=e.id;break;case"spouse":e.rels.spouses||(e.rels.spouses=[]),t.rels.spouses||(t.rels.spouses=[]),e.rels.spouses.push(t.id),t.rels.spouses.push(e.id);break;case"sibling":const n=t.rels.father,i=t.rels.mother;n&&(e.rels.father=n),i&&(e.rels.mother=i)}},i.removeRelationships=function(e,t,n){switch(n){case"child":t.rels.children&&(t.rels.children=t.rels.children.filter(t=>t!==e));break;case"parent":t.rels.father===e&&delete t.rels.father,t.rels.mother===e&&delete t.rels.mother;break;case"spouse":t.rels.spouses&&(t.rels.spouses=t.rels.spouses.filter(t=>t!==e))}},i},createChartBasic:Ve,CardSvg:Je,CardHtml:Ke,FamilyApi:Ge,TreeEditor:Ye,PersonDropdown:Xe,FormBuilder:et,KinshipCalculator:tt,utils:{createPersonId:()=>"xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx".replace(/[xy]/g,function(e){var t=16*Math.random()|0;return("x"==e?t:3&t|8).toString(16)}),validatePersonData:e=>{if(!e.id)throw new Error("Person must have an id");if(!e.data)throw new Error("Person must have data object");if(!e.rels)throw new Error("Person must have rels object");return!0},createEmptyPerson:(e={})=>({id:nt.utils.createPersonId(),data:{gender:"M",...e},rels:{}}),findPersonById:(e,t)=>e.find(e=>e.id===t)||null,getChildren:(e,t)=>{const n=nt.utils.findPersonById(e,t);return n&&n.rels.children?n.rels.children.map(t=>nt.utils.findPersonById(e,t)).filter(e=>null!==e):[]},getParents:(e,t)=>{const n=nt.utils.findPersonById(e,t);return n?{father:n.rels.father?nt.utils.findPersonById(e,n.rels.father):null,mother:n.rels.mother?nt.utils.findPersonById(e,n.rels.mother):null}:{father:null,mother:null}},getSpouses:(e,t)=>{const n=nt.utils.findPersonById(e,t);return n&&n.rels.spouses?n.rels.spouses.map(t=>nt.utils.findPersonById(e,t)).filter(e=>null!==e):[]},getSiblings:(e,t)=>{if(!nt.utils.findPersonById(e,t))return[];const n=[],{father:i,mother:s}=nt.utils.getParents(e,t);if(i){const s=nt.utils.getChildren(e,i.id);n.push(...s.filter(e=>e.id!==t))}if(s){nt.utils.getChildren(e,s.id).forEach(e=>{e.id===t||n.find(t=>t.id===e.id)||n.push(e)})}return n},cleanFamilyData:e=>e.map(e=>{const t={...e};return delete t.to_add,delete t._new_rel_data,delete t.unknown,delete t._toggle,delete t._tgdp,delete t._tgdp_sp,delete t.__tgdp_sp,t.data||(t.data={}),t.rels||(t.rels={}),t}),exportFamilyData:(e,t="json")=>{const n=nt.utils.cleanFamilyData(e);switch(t.toLowerCase()){case"json":return JSON.stringify(n,null,2);case"csv":return[["id","first_name","last_name","gender","birth_date","father_id","mother_id","spouse_ids"],...n.map(e=>[e.id,e.data["first name"]||"",e.data["last name"]||"",e.data.gender||"",e.data.birthday||"",e.rels.father||"",e.rels.mother||"",(e.rels.spouses||[]).join(";")])].map(e=>e.map(e=>`"${e}"`).join(",")).join("\n");case"gedcom":let e="0 HEAD\n1 GEDC\n2 VERS 5.5.1\n2 FORM LINEAGE-LINKED\n1 CHAR UTF-8\n";return n.forEach((t,n)=>{e+=`0 @${`I${n+1}`}@ INDI\n`,(t.data["first name"]||t.data["last name"])&&(e+=`1 NAME ${t.data["first name"]||""} /${t.data["last name"]||""}/\n`),t.data.gender&&(e+=`1 SEX ${t.data.gender}\n`),t.data.birthday&&(e+=`1 BIRT\n2 DATE ${t.data.birthday}\n`)}),e+="0 TRLR\n",e;default:throw new Error(`Unsupported export format: ${t}`)}}}};export{nt as default};
