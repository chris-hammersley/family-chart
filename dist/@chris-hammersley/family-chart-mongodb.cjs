"use strict";function t(t){var e=Object.create(null);return t&&Object.keys(t).forEach(function(n){if("default"!==n){var i=Object.getOwnPropertyDescriptor(t,n);Object.defineProperty(e,n,i.get?i:{enumerable:!0,get:function(){return t[n]}})}}),e.default=t,Object.freeze(e)}var e=t(require("d3")),n="object"==typeof window&&window.d3?window.d3:e;function i(t,e,n){return n.find(n=>n.id!==e.id&&(n.id===t.rels.mother||n.id===t.rels.father))}function r(t,e,n){if(t.exiting=n,e)0!==t.depth||t.spouse?t.spouse?(t._x=t.spouse.x,t._y=t.spouse.y):t.is_ancestry?(t._x=t.parent.x,t._y=t.parent.y):(t._x=t.psx,t._y=t.psy):(t._x=t.x,t._y=t.y);else if(n){const e=t.x>0?1:-1,n=t.y>0?1:-1;t._x=t.x+400*e,t._y=t.y+400*n}}function a(t,e){const n=e?"rels":"_rels",i=e?"_rels":"rels";function r(e){t.data[n]&&t.data[n][e]&&(t.data[i]||(t.data[i]={}),t.data[i][e]=t.data[n][e],delete t.data[n][e])}t.is_ancestry||t.data.main?(r("father"),r("mother")):function(){if(!t.data[n]||!t.data[n].children)return;const e=t.data[n].children.slice(0),r=t.spouse?[t.spouse]:t.spouses||[];[t,...r].forEach(t=>e.forEach(e=>{t.data[n].children.includes(e)&&(t.data[i]||(t.data[i]={}),t.data[i].children||(t.data[i].children=[]),t.data[i].children.push(e),t.data[n].children.splice(t.data[n].children.indexOf(e),1))}))}()}function s({tree:t,data_stash:e,private_cards_config:n}){const i={},r=n.condition;if(!r)return console.error("private_cards_config.condition is not set");t.forEach(t=>{if(t.data._new_rel_data)return;const n=function(t){const n=[];let a=!1;return s(t),i[t]=a,a;function s(t){if(a)return;if(i.hasOwnProperty(t))return a=i[t],a;const o=e.find(e=>e.id===t);if(o._new_rel_data)return;if(r(o))return a=!0,!0;const d=o.rels;[d.father,d.mother,...d.spouses||[]].forEach(t=>{t&&(n.includes(t)||(n.push(t),s(t)))})}}(t.data.id);n&&(t.is_private=n)})}function o(t,e){const n=t.rels,i=[n.father,n.mother,...n.spouses||[],...n.children||[]].filter(t=>!!t),r=[];for(let n=0;n<i.length;n++){if(!a(e.find(t=>t.id===i[n]),[t])){r.push(i[n]);break}}return 0===r.length;function a(t,n){let i;return s(t)&&(i=[t]),function t(r,a){if(i)return;a=[...a,r],o(function(t){s(t)&&(i=a)}),i||o(d);function o(t){if(!r)return;const e=r.rels;[e.father,e.mother,...e.spouses||[],...e.children||[]].filter(t=>t&&![...n,...a].find(e=>e.id===t)).forEach(e=>t(e))}function d(n){const i=e.find(t=>t.id===n);t(i,a)}}(t,[t]),i}function s(t){return"object"==typeof t?t.id===e[0].id:t===e[0].id}}function d(t,e){const n=e[0];if(t.id===n.id)return!0;const i=[];let r=!1;return function t(a){if(r)return;const s=a.rels;[s.father,s.mother,...s.spouses||[],...s.children||[]].filter(t=>!!t).forEach(a=>{if(i.includes(a))return;i.push(a);const s=e.find(t=>t.id===a);s.id===n.id?r=!0:t(s)})}(t),r}function l(t,e,n){const i=t.id;n.forEach(t=>{t.rels.father===i&&(t.rels.father=e),t.rels.mother===i&&(t.rels.mother=e),(t.rels.spouses||[]).includes(i)&&(t.rels.spouses=t.rels.spouses.filter(t=>t!==i),t.rels.spouses.includes(e)||t.rels.spouses.push(e)),(t.rels.children||[]).includes(i)&&(t.rels.children=t.rels.children.filter(t=>t!==i),t.rels.children.includes(e)||t.rels.children.push(e))});const r=n.find(t=>t.id===e),a=n.find(t=>t.id===i);(a.rels.children||[]).forEach(t=>{r.rels.children||(r.rels.children=[]),r.rels.children.includes(t)||r.rels.children.push(t)}),(a.rels.spouses||[]).forEach(t=>{r.rels.spouses||(r.rels.spouses=[]),r.rels.spouses.includes(t)||r.rels.spouses.push(t)}),r.rels.father&&a.rels.father&&console.error("link rel already has father"),r.rels.mother&&a.rels.mother&&console.error("link rel already has mother"),a.rels.father&&(r.rels.father=a.rels.father),a.rels.mother&&(r.rels.mother=a.rels.mother),n.splice(n.findIndex(t=>t.id===i),1)}function c(t,e){const n=t._new_rel_data?e.find(e=>e.id===t._new_rel_data.rel_id):null,i=function(t,e){const n=[];return i(t),n;function i(t){[t.rels.father,t.rels.mother].forEach(t=>{t&&(n.push(t),i(e.find(e=>e.id===t)))})}}(t,e),r=a(t,e);return t._new_rel_data&&["son","daughter"].includes(t._new_rel_data.rel_type)&&r.push(...a(n,e)),e.filter(e=>e.id!==t.id&&e.id!==n?.id&&!e._new_rel_data&&!e.to_add&&!e.unknown).filter(t=>!i.includes(t.id)).filter(t=>!r.includes(t.id)).filter(e=>!(e.rels.spouses||[]).includes(t.id));function a(t,e){const n=[];return function t(i){(i.rels.children?[...i.rels.children]:[]).forEach(i=>{n.push(i),t(e.find(t=>t.id===i))})}(t),n}}function h(t,e){Object.keys(t.data).forEach(n=>{if(n.includes("__ref__")){const i=n.split("__ref__")[1],r=e.find(t=>t.id===i);if(!r)return;const a=n.split("__ref__")[0]+"__ref__"+t.id;r.data[a]=t.data[n]}})}function u(t,e){Object.keys(t.data).forEach(n=>{if(n.includes("__ref__")){const i=n.split("__ref__")[1],r=e.find(t=>t.id===i);if(!r)return;const a=n.split("__ref__")[0]+"__ref__"+t.id;delete r.data[a]}})}function p(t,e){return delete t.to_add,t}function f(t,e){return _(t,e),!1}function _(t,e){return o(t,e)?(e.forEach(e=>{for(let n in e.rels)e.rels.hasOwnProperty(n)&&(e.rels[n]===t.id?delete e.rels[n]:Array.isArray(e.rels[n])&&e.rels[n].includes(t.id)&&e.rels[n].splice(e.rels[n].findIndex(e=>e===t.id),1))}),u(t,e),e.splice(e.findIndex(e=>e.id===t.id),1),e.forEach(t=>{t.to_add&&_(t,e)}),0===e.length&&e.push(b({}).data[0]),{success:!0}):(u(t,e),t.data={gender:t.data.gender},t.unknown=!0,{success:!0})}function m({datum:t,data_stash:e,rel_type:n,rel_datum:i}){function r(t){!function(){if(!i.rels.spouses)return;i.rels.spouses.forEach(t=>{const n=e.find(e=>e.id===t);n.to_add&&f(n,e)})}(),i.rels.spouses||(i.rels.spouses=[]),i.rels.spouses.push(t.id),t.rels.spouses=[i.id]}"daughter"===n||"son"===n?function(t){t.data.other_parent&&(!function(n){"_new"===n&&(n=s().id);const a=e.find(t=>t.id===n);t.rels["M"===a.data.gender?"father":"mother"]=a.id,a.rels.hasOwnProperty("children")||(a.rels.children=[]);function s(){const t=y({rel_type:"spouse",rel_datum:i});return r(t),v({data_stash:e,datum:t}),t}a.rels.children.push(t.id)}(t.data.other_parent),delete t.data.other_parent);t.rels["M"===i.data.gender?"father":"mother"]=i.id,i.rels.children||(i.rels.children=[]);i.rels.children.push(t.id)}(t):"father"===n||"mother"===n?function(t){const n="M"===t.data.gender,r=i.rels[n?"father":"mother"];r&&f(e.find(t=>t.id===r),e);i.rels[n?"father":"mother"]=t.id,function(){const r=i.rels[n?"mother":"father"];if(!r)return;const a=e.find(t=>t.id===r);t.rels.spouses=[r],a.rels.spouses||(a.rels.spouses=[]),a.rels.spouses.push(t.id)}(),t.rels.children=[i.id]}(t):"spouse"===n&&r(t)}function g({data:t,rels:e}){return{id:(n=(new Date).getTime(),i=performance&&performance.now&&1e3*performance.now()||0,"xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx".replace(/[xy]/g,function(t){var e=16*Math.random();return n>0?(e=(n+e)%16|0,n=Math.floor(n/16)):(e=(i+e)%16|0,i=Math.floor(i/16)),("x"===t?e:3&e|8).toString(16)})),data:t||{},rels:e||{}};var n,i}function y({data:t,rel_type:e,rel_datum:n}){const i=function(t,e){return["daughter","mother"].includes(e)||"spouse"===e&&"M"===t.data.gender?"F":"M"}(n,e);return g({data:t=Object.assign(t||{},{gender:i})})}function v({data_stash:t,datum:e}){t.push(e)}function b({data:t,version:e}){return{data:[g({data:t})],version:e}}function x({amount:t,svg:e,transition_time:i=500}){const r=e.__zoomObj?e:e.parentNode,a=r.__zoomObj;n.select(r).transition().duration(i||0).delay(i?100:0).call(a.scaleBy,t)}function w(t,e){const n=t.data.rels;return[n.father,n.mother,...n.spouses||[],...n.children||[]].filter(t=>t).every(t=>e.some(e=>e.data.id===t))}function C(t,e,n=!0){const i=[];function r(t,e){return t.every(t=>e.some(e=>t.id===e.id))}function a(t){const e={},n=t;return(t.children||[]).forEach(t=>{const i=t.data.rels,r=i.father===n.data.id?i.mother:i.father;e[r]||(e[r]=[]),e[r].push(t)}),e}!function s(o){if(!o.children)return;const d=o.data,l=(o.data.rels.spouses||[]).map(t=>e.find(e=>e.id===t)),c=a(o);l.forEach(l=>{if(i.some(t=>t.some(t=>r([d,l],[t.p1,t.p2]))))return;const h=function(n,i,s){const o=[];return d(t),o;function d(t){if(t!==n&&t.children){const n=t.data,l=(t.data.rels.spouses||[]).map(t=>e.find(e=>e.id===t)),c=a(t);l.forEach(e=>{r([i,s],[n,e])?o.push({d:t,p1:n,p2:e}):(c[e.id]||[]).forEach(t=>{d(t)})})}}}(o,d,l);if(h.length>0){const e=[{d:o,p1:d,p2:l},...h];i.push(e),function(e){if(e.forEach(({d:n,p1:i,p2:r},a)=>{n.data._tgdp_sp||(n.data._tgdp_sp={});let s=t===n?"main":n.parent.data.id;!function(t,e,n){t.data.__tgdp_sp&&t.data.__tgdp_sp[e]&&t.data.__tgdp_sp[e].hasOwnProperty(n.id)&&(t.data._tgdp_sp[e][n.id]=t.data.__tgdp_sp[e][n.id],delete t.data.__tgdp_sp[e][n.id])}(n,s,r),n.data._tgdp_sp[s]||(n.data._tgdp_sp[s]={});let o=1;n.data._tgdp_sp[s].hasOwnProperty(r.id)?o=n.data._tgdp_sp[s][r.id]:n.data._tgdp_sp[s][r.id]=o,e[a].val=o}),n){if(e.every(t=>t.val<0)){const n=e.sort((t,e)=>e.val-t.val)[0],{d:i,p1:r,p2:a}=n,s=t===i?"main":i.parent.data.id;i.data._tgdp_sp[s][a.id]=1}if(e.filter(t=>t.val>0).length>1){const n=e.sort((t,e)=>e.val-t.val)[0];e.forEach(e=>{if(e===n)return;const{d:i,p1:r,p2:a}=e,s=t===i?"main":i.parent.data.id;i.data._tgdp_sp[s][a.id]=-1})}}}(e),function(e){e.forEach(({d:e,p1:n,p2:i})=>{const r=t===e?"main":e.parent.data.id;if(e.data._tgdp_sp[r][i.id]<0){const t=a(e);t[i.id]&&(e.children=e.children.filter(e=>!t[i.id].includes(e)),0===e.children.length&&delete e.children)}})}(e)}else{let e=t===o?"main":o.parent.data.id;!function(t,e,n){t.data._tgdp_sp&&t.data._tgdp_sp[e]&&t.data._tgdp_sp[e].hasOwnProperty(n.id)&&(t.data.__tgdp_sp||(t.data.__tgdp_sp={}),t.data.__tgdp_sp[e]||(t.data.__tgdp_sp[e]={}),t.data.__tgdp_sp[e][n.id]=t.data._tgdp_sp[e][n.id],delete t.data._tgdp_sp[e][n.id])}(o,e,l),(c[l.id]||[]).forEach(t=>{s(t)})}})}(t),function(t){let e=0;t.forEach(t=>{e+=1,t.forEach(t=>{t.d._toggle_id_sp||(t.d._toggle_id_sp={}),t.d._toggle_id_sp[t.p2.id]=e})})}(i)}function $(t,e=!0){const n=[];!function i(r){if(r.children){if(n.some(t=>t.includes(r)))return;const a=function(e){const n=[];return i(t),n;function i(t){var r,a;t.children&&(r=e,a=t.children,r!==a&&r.every(t=>a.some(e=>t.data.id===e.data.id))?n.push(t):t.children.forEach(t=>{i(t)}))}}(r.children);if(a.length>0){const i=[r,...a];n.push(i),function(n){if(n.forEach(e=>{e.data._tgdp||(e.data._tgdp={});const n=t===e?"main":e.parent.data.id;e.data._tgdp[n]||(e.data._tgdp[n]=-1),e._toggle=e.data._tgdp[n]}),e){if(n.every(t=>t._toggle<0)){const e=n.sort((t,e)=>e._toggle-t._toggle)[0],i=t===e?"main":e.parent.data.id;e.data._tgdp[i]=1}if(n.filter(t=>t._toggle>0).length>1){const e=n.sort((t,e)=>e._toggle-t._toggle)[0];n.forEach(n=>{if(n===e)return;const i=n,r=t===i?"main":i.parent.data.id;i.data._tgdp[r]=-1})}}}(i),function(e){e.forEach(e=>{const n=t===e?"main":e.parent.data.id;e.data._tgdp[n]<0&&delete e.children})}(i)}else r.children.forEach(t=>{i(t)})}}(t),function(t){let e=0;t.forEach(t=>{e+=1,t.forEach(t=>{t._toggle_id=e})})}(n)}function k({data:t,main_id:e=null,node_separation:r=250,level_separation:a=150,single_parent_empty_card:o=!0,is_horizontal:d=!1,one_level_rels:l=!1,sortChildrenFunction:c,sortSpousesFunction:h,ancestry_depth:u,progeny_depth:p,show_siblings_of_main:f=!1,modifyTreeHierarchy:_,private_cards_config:m,duplicate_branch_toggle:y=!1,on_toggle_one_close_others:v=!0}){if(!t||!t.length)return{data:[],data_stash:[],dim:{width:0,height:0},main_id:null};d&&([r,a]=[a,r]);const b=o?function(t){const e=[];for(let e=0;e<t.length;e++){const i=t[e];if(i.rels.children&&i.rels.children.length>0){i.rels.spouses||(i.rels.spouses=[]);const e="M"===i.data.gender;let r;i.rels.children.forEach(a=>{const s=t.find(t=>t.id===a);s.rels[e?"father":"mother"]===i.id&&(s.rels[e?"mother":"father"]||(r||(r=n(i)),r.rels.children.push(s.id),s.rels[e?"mother":"father"]=r.id))})}}return e.forEach(e=>t.push(e)),t;function n(n){return n.rels.spouses.map(e=>t.find(t=>t.id===e)).find(t=>t.to_add)||function(t){const n=g({data:{gender:"M"===t.data.gender?"F":"M"},rels:{spouses:[t.id],children:[]}});return n.to_add=!0,e.push(n),t.rels.spouses.push(n.id),n}(n)}}(t):t,x=null!==e&&b.find(t=>t.id===e)||b[0],k=F(x,"children",!1),S=F(x,"parents",!0);b.forEach(t=>t.main=t===x),function(t,e){const n=(t[0].x-e[0].x)/2;t.forEach(t=>t.x-=n),e.forEach(t=>t.x+=n)}(S,k);const E=(M=k,(I=S).forEach(t=>{t.is_ancestry=!0}),I.forEach(t=>1===t.depth?t.parent=M[0]:null),[...M,...I.slice(1)]);var I,M;!function({tree:t}){t.forEach(e=>{delete e.children,t.forEach(t=>{t.parent===e&&(t.is_ancestry?(e.parents||(e.parents=[]),e.parents.push(t)):(e.children||(e.children=[]),e.children.push(t)))})})}({tree:E}),function({tree:t,node_separation:e}){for(let n=t.length;n--;){const i=t[n];if(!i.is_ancestry&&i.data.rels.spouses&&i.data.rels.spouses.length>0){if(l&&i.depth>0)continue;const n="M"===i.data.data.gender?-1:1;i.x+=i.data.rels.spouses.length/2*e*n,i.data.rels.spouses.forEach((r,a)=>{const s={data:b.find(t=>t.id===r),added:!0};s.x=i.x-e*(a+1)*n,s.y=i.y,s.sx=a>0?s.x:s.x+e/2*n,s.sy=a>0?s.y:s.y+e/2*n,s.depth=i.depth,s.spouse=i,i.spouses||(i.spouses=[]),i.spouses.push(s),t.push(s)})}if(i.parents&&2===i.parents.length){const t=i.parents[0],n=i.parents[1],r=t.x-(t.x-n.x)/2,a=(t,n)=>r+e/2*(t.x<n.x?1:-1);n.x=a(t,n),t.x=a(n,t)}}}({tree:E,node_separation:r}),f&&!l&&function({tree:t,data_stash:e,node_separation:i,sortChildrenFunction:r}){const a=t.find(t=>t.data.main),s=a.data.rels.father,o=a.data.rels.mother,d=e.filter(t=>!(t.id===a.data.id||!(s&&t.rels.father===s||o&&t.rels.mother===o))),l=function(){const e=[];for(let n=0;n<d.length;n++){const i={data:d[n],sibling:!0,parents:[]},r=a.parents.find(t=>t.data.id===i.data.rels.father),s=a.parents.find(t=>t.data.id===i.data.rels.mother);r&&i.parents.push(r),s&&i.parents.push(s),i.x=void 0,i.y=a.y,i.depth=a.depth-1,t.push(i),e.push(i)}return e}();!function(){const t=[a,...l];r&&t.sort((t,e)=>r(t.data,e.data)),t.sort((t,e)=>{const n=a.parents.find(e=>e.data.id===t.data.rels.father),i=a.parents.find(e=>e.data.id===t.data.rels.mother),r=a.parents.find(t=>t.data.id===e.data.rels.father),s=a.parents.find(t=>t.data.id===e.data.rels.mother);return!i&&s?-1:i&&!s||!n&&r?1:n&&!r?-1:0});const e=a.x,s=(a.spouses||[]).map(t=>t.x),o=n.extent([e,...s]),d=t.findIndex(t=>t.data.id===a.data.id);for(let e=0;e<t.length;e++){if(e===d)continue;t[e].x=e<d?o[0]-i*(d-e):o[1]+i*(e-d)}}()}({tree:E,data_stash:b,node_separation:r,sortChildrenFunction:c}),function({tree:t}){t.forEach(t=>{if(t.is_ancestry)return;if(0===t.depth)return;if(t.added)return;if(t.sibling)return;const e=t.parent,n=(e.spouses||[]).find(e=>e.data.id===t.data.rels.father||e.data.id===t.data.rels.mother);if(e&&n){e.added||n.added||console.error("no added spouse",e,n);const r=e.added?e:n;i(t,r)}else if(e||n){const r=e||n;r.sx=r.x,r.sy=r.y,i(t,r)}function i(t,e){t.psx=d?e.y:e.sx,t.psy=d?e.sx:e.y}})}({tree:E}),function({tree:t}){t.forEach(t=>{if(t.y*=t.is_ancestry?-1:1,d){const e=t.x;t.x=t.y,t.y=e}})}({tree:E}),E.forEach(t=>t.all_rels_displayed=w(t,E)),m&&s({tree:E,data_stash:b,private_cards_config:m}),function({tree:t}){const e=[];t.forEach(n=>{if(e.includes(n.data.id)){const i=t.filter(t=>t.data.id===n.data.id);i.forEach((t,r)=>{t.tid=`${n.data.id}--x${r+1}`,t.duplicate=i.length,e.push(n.data.id)})}else n.tid=n.data.id,e.push(n.data.id)})}({tree:E}),function(t){t.forEach(t=>{if(t.data.main)t.from=[],t.to=[],t.to_ancestry=t.parents;else if(t.is_ancestry)t.from=[t.parent],t.to=t.parents;else{if(t.added)return t.from=[],t.from_spouse=t.spouse,void(t.to=[]);if(t.sibling)return;const e=t.parent,n=(t.parent.spouses||[]).find(e=>e.data.id===t.data.rels.father||e.data.id===t.data.rels.mother);t.from=[e],n&&t.from.push(n),e.to||(e.to=[]),e.to.push(t),n&&(n.to||(n.to=[]),n.to.push(t))}})}(E),y&&function(t){t.forEach(t=>{if(!t.spouse)return;const e=t.spouse;if(t.duplicate&&e.data._tgdp_sp){const n=e.data.main?"main":e.parent.data.id;e.data._tgdp_sp[n]?.hasOwnProperty(t.data.id)&&(t._toggle=e.data._tgdp_sp[n][t.data.id])}})}(E);const A=function(t,e,i){d&&([e,i]=[i,e]);const r=n.extent(t,t=>t.x),a=n.extent(t,t=>t.y);return{width:r[1]-r[0]+e,height:a[1]-a[0]+i,x_off:-r[0]+e/2,y_off:-a[0]+i/2}}(E,r,a);return{data:E,data_stash:b,dim:A,main_id:x.id,is_horizontal:d};function F(t,e,s){const o="children"===e?function(t){const e=[...t.rels.children||[]].map(t=>b.find(e=>e.id===t));c&&e.sort(c);(function(t){t.sort((t,e)=>{const n=t._new_rel_data,i=e._new_rel_data;return n&&!i?1:!n&&i?-1:0})})(e),h&&h(t,b);return function(t,e,n){if(!e.rels.children)return;const r=e.rels.spouses||[];t.sort((t,a)=>{const s=i(t,e,n)||{},o=i(a,e,n)||{},d=r.indexOf(s.id),l=r.indexOf(o.id);return"M"===e.data.gender?d-l:l-d})}(e,t,b),e}:function(t){return[t.rels.father,t.rels.mother].filter(t=>t).map(t=>b.find(e=>e.id===t))},d=n.tree().nodeSize([r,a]).separation(function(t,e){let n=1;s||(m(t,e)||(n+=.25),l||function(t,e){return g(t)||g(e)}(t,e)&&(n+=function(t,e){return.5*((t.data.rels.spouses||[]).length+(e.data.rels.spouses||[]).length)}(t,e)),m(t,e)&&!function(t,e){return t.data.rels.father===e.data.rels.father&&t.data.rels.mother===e.data.rels.mother}(t,e)&&(n+=.125));return n}),f=n.hierarchy(t,o);return s&&function(t){function e(t){t.children&&2===t.children.length&&(t.children[0]._spouse=t.children[1],t.children[1]._spouse=t.children[0]),t.children&&t.children.forEach(t=>e(t))}e(t)}(f),function(t,e){let n=e?u:p;l&&(n=1);return n||0===n?(i(t,0),t):t;function i(t,e){e===n?t.children&&delete t.children:t.children&&t.children.forEach(t=>{i(t,e+1)})}}(f,s),y&&function(t,e,n){n?$(t,v):C(t,e,v)}(f,b,s),_&&_(f,s),d(f),f.descendants();function m(t,e){return t.parent==e.parent}function g(t){return t.data.rels.spouses&&t.data.rels.spouses.length>0}}}function S({t:t,svg:e,transition_time:i=2e3}){const r=e.__zoomObj?e:e.parentNode,a=r.__zoomObj;n.select(r).transition().duration(i||0).delay(i?100:0).call(a.transform,n.zoomIdentity.scale(t.k).translate(t.x,t.y))}function E({svg:t,svg_dim:e,tree_dim:n,with_transition:i,transition_time:r}){S({t:I(e,n),svg:t,transition_time:r})}function I(t,e){let n=Math.min(t.width/e.width,t.height/e.height);n>1&&(n=1);return{k:n,x:e.x_off+(t.width-e.width*n)/n/2,y:e.y_off+(t.height-e.height*n)/n/2}}function M({datum:t,svg:e,svg_dim:n,scale:i,transition_time:r}){const a=i||1;S({t:{k:a,x:(n.width/2-t.x*a)/a,y:(n.height/2-t.y)/a},svg:e,transition_time:r})}function A(t,e){const i=n.line().curve(n.curveMonotoneY),r=n.line().curve(n.curveBasis),a=e?t._d():t.d;return t.curve?!0===t.curve?r(a):void 0:i(a)}function F(t,e){const i=n.select(t).selectAll("div.card_cont_2fake").data(e,t=>t.data.id),r=i.exit(),a=i.enter().append("div").attr("class","card_cont_2fake").style("display","none").attr("data-id",()=>Math.random()),s=a.merge(i);r.each(function(t){t.unique_id=n.select(this).attr("data-id"),n.select(this).remove()}),a.each(function(t){t.unique_id=n.select(this).attr("data-id")}),s.each(function(t){t.unique_id=n.select(this).attr("data-id")})}function L(t){n.select(t()).append("div").attr("class","cards_view_fake").style("display","none")}function T(t){return n.select(t()).select("div.cards_view_fake").node()}var D=Object.freeze({__proto__:null,assignUniqueIdToTreeData:F,createHtmlSvg:function(t){const e=n.select(t).select("#f3Canvas").append("div").attr("id","htmlSvg").attr("style","position: absolute; width: 100%; height: 100%; z-index: 2; top: 0; left: 0");return e.append("div").attr("class","cards_view").style("transform-origin","0 0"),L(()=>e.node()),e.node()},getCardsViewFake:T,getUniqueId:function(t){return t.unique_id},onZoomSetup:function(t,e){return function(i){const r=i.transform;n.select(t()).style("transform",`translate(${r.x}px, ${r.y}px) scale(${r.k}) `),n.select(e()).style("transform",`translate(${r.x}px, ${r.y}px) scale(${r.k}) `)}},setupHtmlSvg:L,setupReactiveTreeData:function(t){let e=[];return function(n){const i=function(t,e){return e.length>0?e.filter(e=>!t.find(t=>t.data.id===e.data.id)):[]}(n,e);return e=[...n,...i],F(T(t),e),e}}});function R(t,e,n){const i=.4*n,r=Math.max(...t.data.map(t=>t.is_ancestry?t.depth:0));let a=e.depth*i;return 0===e.depth&&!e.spouse||e.is_ancestry||(a+=r*i,e.spouse&&(a+=i),a+=e.depth*i),a}function H(t,{d:e}){var n,i;return n=t.getTree().data,i=!1,n.forEach(t=>{t.data.hide_rels=i,a(t,i)}),t.updateMainId(e.data.id),t.updateTree({tree_position:t.state.tree_fit_on_change}),!0}function O(t,{d:e,cardEditForm:n}){const i=e.data;n({datum:i,postSubmit:e=>{i.to_add&&p(i,t.getData()),e&&e.delete&&(i.main&&t.updateMainId(null),_(i,t.getData())),t.updateTree()},store:t})}function P(t,{d:e}){e.data.hide_rels=!e.data.hide_rels,a(e,e.data.hide_rels),t.updateTree({tree_position:t.state.tree_fit_on_change})}function z(){return`\n    <g data-icon="user">\n      ${yt()}\n      <path d="M12,4A4,4 0 0,1 16,8A4,4 0 0,1 12,12A4,4 0 0,1 8,8A4,4 0 0,1 12,4M12,14C16.42,14 20,15.79 20,18V20H4V18C4,15.79 7.58,14 12,14Z" />\n    </g>\n  `}function j(){return`\n    <g data-icon="user-edit">\n      ${yt()}\n      <path d="M21.7,13.35L20.7,14.35L18.65,12.3L19.65,11.3C19.86,11.09 20.21,11.09 20.42,11.3L21.7,12.58C21.91,\n      12.79 21.91,13.14 21.7,13.35M12,18.94L18.06,12.88L20.11,14.93L14.06,21H12V18.94M12,14C7.58,14 4,15.79 4,\n      18V20H10V18.11L14,14.11C13.34,14.03 12.67,14 12,14M12,4A4,4 0 0,0 8,8A4,4 0 0,0 12,12A4,4 0 0,0 16,8A4,4 0 0,0 12,4Z" />\n    </g>\n  `}function q(){return`\n    <g data-icon="user-plus">\n      ${yt()}\n      <path d="M15,14C12.33,14 7,15.33 7,18V20H23V18C23,15.33 17.67,14 15,14M6,10V7H4V10H1V12H4V15H6V12H9V10M15,12A4,4 0 0,0 19,8A4,4 0 0,0 15,4A4,4 0 0,0 11,8A4,4 0 0,0 15,12Z" />\n    </g>\n  `}function U(){return`\n    <g data-icon="user-plus-close">\n      ${yt()}\n      <path d="M15,14C12.33,14 7,15.33 7,18V20H23V18C23,15.33 17.67,14 15,14M6,10V7H4V10H1V12H4V15H6V12H9V10M15,12A4,4 0 0,0 19,8A4,4 0 0,0 15,4A4,4 0 0,0 11,8A4,4 0 0,0 15,12Z" />\n      <line x1="3" y1="3" x2="24" y2="24" stroke="currentColor" stroke-width="2" />\n    </g>\n  `}function V(){return`\n    <g data-icon="plus">\n      ${yt()}\n      <path d="M19,13H13V19H11V13H5V11H11V5H13V11H19V13Z" />\n    </g>\n  `}function N(){return`\n    <g data-icon="pencil">\n      ${yt()}\n      <path d="M20.71,7.04C21.1,6.65 21.1,6 20.71,5.63L18.37,3.29C18,2.9 17.35,2.9 16.96,3.29L15.12,5.12L18.87,8.87M3,17.25V21H6.75L17.81,9.93L14.06,6.18L3,17.25Z" />\n    </g>\n  `}function B(){return`\n    <g data-icon="pencil-off">\n      ${yt()}\n      <path d="M18.66,2C18.4,2 18.16,2.09 17.97,2.28L16.13,4.13L19.88,7.88L21.72,6.03C22.11,5.64 22.11,5 21.72,4.63L19.38,2.28C19.18,2.09 18.91,2 18.66,2M3.28,4L2,5.28L8.5,11.75L4,16.25V20H7.75L12.25,15.5L18.72,22L20,20.72L13.5,14.25L9.75,10.5L3.28,4M15.06,5.19L11.03,9.22L14.78,12.97L18.81,8.94L15.06,5.19Z" />\n    </g>\n  `}function J(){return`\n    <g data-icon="trash">\n      ${yt()}\n      <path d="M6,19A2,2 0 0,0 8,21H16A2,2 0 0,0 18,19V7H6V19M8,9H16V19H8V9M15.5,4L14.5,3H9.5L8.5,4H5V6H19V4H15.5Z" />\n    </g>\n  `}function Z(){return`\n    <g data-icon="history-back">\n      ${yt()}\n      <path d="M20 13.5C20 17.09 17.09 20 13.5 20H6V18H13.5C16 18 18 16 18 13.5S16 9 13.5 9H7.83L10.91 12.09L9.5 13.5L4 8L9.5 2.5L10.92 3.91L7.83 7H13.5C17.09 7 20 9.91 20 13.5Z" />\n    </g>\n  `}function W(){return`\n    <g data-icon="history-forward">\n      ${yt()}\n      <path d="M10.5 18H18V20H10.5C6.91 20 4 17.09 4 13.5S6.91 7 10.5 7H16.17L13.08 3.91L14.5 2.5L20 8L14.5 13.5L13.09 12.09L16.17 9H10.5C8 9 6 11 6 13.5S8 18 10.5 18Z" />\n    </g>\n  `}function K(){return'\n    <g data-icon="person">\n      <path d="M256 288c79.5 0 144-64.5 144-144S335.5 0 256 0 112 \n        64.5 112 144s64.5 144 144 144zm128 32h-55.1c-22.2 10.2-46.9 16-72.9 16s-50.6-5.8-72.9-16H128C57.3 320 0 377.3 \n        0 448v16c0 26.5 21.5 48 48 48h416c26.5 0 48-21.5 48-48v-16c0-70.7-57.3-128-128-128z" />\n    </g>\n  '}function G(){return'\n    <g transform="translate(31,25)" data-icon="mini-tree">\n      <rect x="-31" y="-25" width="72" height="15" fill="rgba(0,0,0,0)"></rect>\n      <g>\n        <rect x="-31" y="-25" width="72" height="15" fill="rgba(0,0,0,0)"></rect>\n        <line y2="-17.5" stroke="#fff" />\n        <line x1="-20" x2="20" y1="-17.5" y2="-17.5" stroke="#fff" />\n        <rect x="-31" y="-25" width="25" height="15" rx="5" ry="5" class="card-male" />\n        <rect x="6" y="-25" width="25" height="15" rx="5" ry="5" class="card-female" />\n      </g>\n    </g>\n  '}function Y(){return`\n    <g data-icon="toggle-on">\n      ${yt()}\n      <circle class="f3-small-circle" r="4" cx="18" cy="12" />\n      <path d="M17,7H7A5,5 0 0,0 2,12A5,5 0 0,0 7,17H17A5,5 0 0,0 22,12A5,5 0 0,0 17,7M17,15A3,3 0 0,1 14,12A3,3 0 0,1 17,9A3,3 0 0,1 20,12A3,3 0 0,1 17,15Z" />\n    </g>\n  `}function Q(){return`\n    <g data-icon="toggle-off">\n      ${yt()}\n      <circle class="f3-small-circle" r="4" cx="6" cy="12" />\n      <path d="M17,7H7A5,5 0 0,0 2,12A5,5 0 0,0 7,17H17A5,5 0 0,0 22,12A5,5 0 0,0 17,7M7,15A3,3 0 0,1 4,12A3,3 0 0,1 7,9A3,3 0 0,1 10,12A3,3 0 0,1 7,15Z" />\n    </g>\n  `}function X(){return`\n    <g data-icon="chevron-down">\n      ${yt()}\n      <path d="M7.41,8.58L12,13.17L16.59,8.58L18,10L12,16L6,10L7.41,8.58Z" />\n    </g>\n  `}function tt(){return`\n    <g data-icon="chevron-up">\n      ${yt()}\n      <path d="M7.41,15.41L12,10.83L16.59,15.41L18,14L12,8L6,14L7.41,15.41Z" />\n    </g>\n  `}function et(){return`\n    <g data-icon="link-off">\n      ${yt()}\n      <path d="M17,7H13V8.9H17C18.71,8.9 20.1,10.29 20.1,12C20.1,13.43 19.12,14.63 17.79,15L19.25,16.44C20.88,15.61 22,13.95 \n      22,12A5,5 0 0,0 17,7M16,11H13.81L15.81,13H16V11M2,4.27L5.11,7.38C3.29,8.12 2,9.91 2,12A5,5 0 0,0 7,17H11V15.1H7C5.29,15.1 \n      3.9,13.71 3.9,12C3.9,10.41 5.11,9.1 6.66,8.93L8.73,11H8V13H10.73L13,15.27V17H14.73L18.74,21L20,19.74L3.27,3L2,4.27Z" />\n    </g>\n  `}function nt(){return`\n    <g data-icon="info">\n      ${yt()}\n      <path d="M13,9H11V7H13M13,17H11V11H13M12,2A10,10 0 0,0 2,12A10,10 0 0,0 12,22A10,10 0 0,0 22,12A10,10 0 0,0 12,2Z" />\n    </g>\n  `}function it(){return gt(q())}function rt(){return gt(U())}function at(){return gt(V())}function st(){return gt(N())}function ot(){return gt(B())}function dt(){return gt(Z())}function lt(){return gt(W())}function ct(){return gt('\n    <g data-icon="person">\n      <path d="M256 288c79.5 0 144-64.5 144-144S335.5 0 256 0 112 \n        64.5 112 144s64.5 144 144 144zm128 32h-55.1c-22.2 10.2-46.9 16-72.9 16s-50.6-5.8-72.9-16H128C57.3 320 0 377.3 \n        0 448v16c0 26.5 21.5 48 48 48h416c26.5 0 48-21.5 48-48v-16c0-70.7-57.3-128-128-128z" />\n    </g>\n  ',"0 0 512 512")}function ht(){return gt('\n    <g transform="translate(31,25)" data-icon="mini-tree">\n      <rect x="-31" y="-25" width="72" height="15" fill="rgba(0,0,0,0)"></rect>\n      <g>\n        <rect x="-31" y="-25" width="72" height="15" fill="rgba(0,0,0,0)"></rect>\n        <line y2="-17.5" stroke="#fff" />\n        <line x1="-20" x2="20" y1="-17.5" y2="-17.5" stroke="#fff" />\n        <rect x="-31" y="-25" width="25" height="15" rx="5" ry="5" class="card-male" />\n        <rect x="6" y="-25" width="25" height="15" rx="5" ry="5" class="card-female" />\n      </g>\n    </g>\n  ',"0 0 72 25")}function ut(){return gt(Y())}function pt(){return gt(Q())}function ft(){return gt(X())}function _t(){return gt(et())}function mt(){return gt(nt())}function gt(t,e="0 0 24 24"){const n=t.match(/data-icon="([^"]+)"/);return`\n    <svg xmlns="http://www.w3.org/2000/svg" viewBox="${e}" style="fill: currentColor" ${n?`data-icon="${n[1]}"`:""}>\n      ${t}\n    </svg>\n  `}function yt(){return'\n    <circle r="12" cx="12" cy="12" style="fill: rgba(0,0,0,0)" />\n  '}var vt=Object.freeze({__proto__:null,chevronDownIcon:X,chevronDownSvgIcon:ft,chevronUpIcon:tt,chevronUpSvgIcon:function(){return gt(tt())},historyBackIcon:Z,historyBackSvgIcon:dt,historyForwardIcon:W,historyForwardSvgIcon:lt,infoIcon:nt,infoSvgIcon:mt,linkOffIcon:et,linkOffSvgIcon:_t,miniTreeIcon:G,miniTreeSvgIcon:ht,pencilIcon:N,pencilOffIcon:B,pencilOffSvgIcon:ot,pencilSvgIcon:st,personIcon:K,personSvgIcon:ct,plusIcon:V,plusSvgIcon:at,toggleIconOff:Q,toggleIconOn:Y,toggleSvgIconOff:pt,toggleSvgIconOn:ut,trashIcon:J,trashSvgIcon:function(){return gt(J())},userEditIcon:j,userEditSvgIcon:function(){return gt(j())},userIcon:z,userPlusCloseIcon:U,userPlusCloseSvgIcon:rt,userPlusIcon:q,userPlusSvgIcon:it,userSvgIcon:function(){return gt(z())}});var bt=Object.freeze({__proto__:null,addNewPerson:v,addNewPersonAndHandleRels:function({datum:t,data_stash:e,rel_type:n,rel_datum:i}){v({data_stash:e,datum:t}),m({datum:t,data_stash:e,rel_type:n,rel_datum:i})},calculateTreeFit:I,cardChangeMain:H,cardEdit:O,cardShowHideRels:P,cardToMiddle:M,checkIfConnectedToFirstPerson:d,checkIfRelativesConnectedWithoutPerson:o,cleanupDataJson:function(t){return t.forEach(e=>e.to_add?f(e,t):e),t.forEach(t=>{delete t.main,delete t._tgdp,delete t._tgdp_sp,delete t.__tgdp_sp}),t.forEach(t=>{Object.keys(t).forEach(t=>{"_"===t[0]&&console.error("key starts with _",t)})}),t},createForm:function({datum:t,store:e,fields:n,postSubmit:i,addRelative:r,removeRelative:a,deletePerson:s,onCancel:o,editFirst:d,link_existing_rel_config:l,getKinshipInfo:u,onFormCreation:p}){const f={datum_id:t.id,fields:[],onSubmit:function(n){n.preventDefault();new FormData(n.target).forEach((e,n)=>t.data[n]=e),h(t,e.getData()),t.to_add&&delete t.to_add;t.unknown&&delete t.unknown;i()},getKinshipInfo:u,onFormCreation:p};t._new_rel_data||(f.onDelete=function(){s(),i({delete:!0})},f.addRelative=()=>r.activate(t),f.addRelativeCancel=()=>r.onCancel(),f.addRelativeActive=r.is_active,f.removeRelative=()=>a.activate(t),f.removeRelativeCancel=()=>a.onCancel(),f.removeRelativeActive=a.is_active,f.editable=!1),t._new_rel_data&&(f.title=t._new_rel_data.label,f.new_rel=!0,f.editable=!0,f.onCancel=o),(t._new_rel_data||t.to_add||t.unknown)&&l&&(f.linkExistingRelative=function(t,e,n){const i={label:n.label,options:c(t,e).map(t=>({value:t.id,label:n.linkRelLabel(t)})).sort((t,e)=>"string"==typeof t.label&&"string"==typeof e.label?t.label.localeCompare(e.label):t.label<e.label?-1:1),onSelect:m};return i}(t,e.getData(),l)),f.onDelete&&(f.can_delete=!0),d&&(f.editable=!0);const _=(t.rels.children||[]).some(t=>!e.getDatum(t)._new_rel_data);return f.gender_field={id:"gender",type:"switch",label:"Gender",initial_value:t.data.gender,disabled:["father","mother"].some(e=>e===t._new_rel_data?.rel_type)||_,options:[{value:"M",label:"Male"},{value:"F",label:"Female"}]},n.forEach(n=>{"rel_reference"===n.type?function(n){n.getRelLabel||console.error("getRelLabel is not set");"spouse"===n.rel_type&&(t.rels.spouses||[]).forEach(i=>{const r=e.getDatum(i),a=`${n.id}__ref__${i}`;f.fields.push({id:a,type:"rel_reference",label:n.label,rel_id:i,rel_label:n.getRelLabel(r),initial_value:t.data[a]})})}(n):"select"===n.type?function(e){if(!e.optionCreator&&!e.options)return console.error("optionCreator or options is not set for field",e);f.fields.push({id:e.id,type:e.type,label:e.label,initial_value:t.data[e.id],placeholder:e.placeholder,options:e.options||e.optionCreator(t)})}(n):f.fields.push({id:n.id,type:n.type,label:n.label,initial_value:t.data[n.id]})}),f;function m(t){const e=t.target.value;i({link_rel_id:e})}},createHistory:function(t,e,n){let i=[],r=-1;return{changed:function(){r<i.length-1&&(i=i.slice(0,r+1));const n=e();n.main_id=t.getMainId(),i.push(n),r++},back:function(){if(!s())return;r--,o(i[r])},forward:function(){if(!a())return;r++,o(i[r])},canForward:a,canBack:s};function a(){return r<i.length-1}function s(){return r>0}function o(e){const i=t.getMainId();(e=JSON.parse(JSON.stringify(e))).find(t=>t.id===i)||t.updateMainId(e.main_id),t.updateData(e),n()}},createHistoryControls:function(t,e){const i=n.select(t).append("div").attr("class","f3-history-controls");t.insertBefore(i.node(),t.firstChild);const r=i.append("button").attr("class","f3-back-button").on("click",()=>{e.back(),s()}),a=i.append("button").attr("class","f3-forward-button").on("click",()=>{e.forward(),s()});return r.html(dt()),a.html(lt()),{back_btn:r.node(),forward_btn:a.node(),updateButtons:s,destroy:function(){e=null,n.select(t).select(".f3-history-controls").remove()}};function s(){r.classed("disabled",!e.canBack()),a.classed("disabled",!e.canForward()),e.canBack()||e.canForward()?i.style("opacity",1).style("pointer-events","auto"):i.style("opacity",0).style("pointer-events","none")}},createNewPerson:g,createNewPersonWithGenderFromRel:y,createTreeDataWithMainNode:b,deletePerson:_,formInfoSetup:function(t,e){const n=document.createElement("div");return i(),n;function i(){const r=function(t){return` \n    <form id="familyForm" class="f3-form ${t.editable?"":"non-editable"}">\n      ${d()}\n      ${t.title?`<h3 class="f3-form-title">${t.title}</h3>`:""}\n      <div style="text-align: right; display: ${t.new_rel?"none":"block"}">\n        ${t.addRelative&&!t.no_edit?i():""}\n        ${t.no_edit?l():r()}\n      </div>\n\n      ${a()}\n\n      ${s()}\n      \n      <div class="f3-form-buttons">\n        <button type="button" class="f3-cancel-btn">Cancel</button>\n        <button type="submit">Submit</button>\n      </div>\n\n      ${t.linkExistingRelative?o():""}\n\n      <hr>\n\n      ${t.onDelete?e():""}\n\n      ${t.removeRelative?n():""}\n    </form>\n  `;function e(){return`\n      <div>\n        <button type="button" class="f3-delete-btn" ${t.can_delete?"":"disabled"}>\n          Delete\n        </button>\n      </div>\n    `}function n(){return`\n      <div>\n        <button type="button" class="f3-remove-relative-btn${t.removeRelativeActive?" active":""}">\n          ${t.removeRelativeActive?"Cancel Remove Relation":"Remove Relation"}\n        </button>\n      </div>\n    `}function i(){return`\n      <span class="f3-add-relative-btn">\n        ${t.addRelativeActive?rt():it()}\n      </span>\n    `}function r(){return`\n      <span class="f3-edit-btn">\n        ${t.editable?ot():st()}\n      </span>\n    `}function a(){return t.editable?`\n      <div class="f3-radio-group">\n        ${t.gender_field.options.map(e=>`\n          <label>\n            <input type="radio" name="${t.gender_field.id}" \n              value="${e.value}" \n              ${e.value===t.gender_field.initial_value?"checked":""}\n              ${t.gender_field.disabled?"disabled":""}\n            >\n            ${e.label}\n          </label>\n        `).join("")}\n      </div>\n    `:""}function s(){if(!t.editable)return n();let e="";return t.fields.forEach(t=>{"text"===t.type?e+=`\n        <div class="f3-form-field">\n          <label>${t.label}</label>\n          <input type="${t.type}" \n            name="${t.id}" \n            value="${t.initial_value||""}"\n            placeholder="${t.label}">\n        </div>`:"textarea"===t.type?e+=`\n        <div class="f3-form-field">\n          <label>${t.label}</label>\n          <textarea name="${t.id}" \n            placeholder="${t.label}">${t.initial_value||""}</textarea>\n        </div>`:"select"===t.type?e+=`\n        <div class="f3-form-field">\n          <label>${t.label}</label>\n          <select name="${t.id}" value="${t.initial_value||""}">\n            <option value="">${t.placeholder||`Select ${t.label}`}</option>\n            ${t.options.map(e=>`<option ${e.value===t.initial_value?"selected":""} value="${e.value}">${e.label}</option>`).join("")}\n          </select>\n        </div>`:"rel_reference"===t.type&&(e+=`\n        <div class="f3-form-field">\n          <label>${t.label} - <i>${t.rel_label}</i></label>\n          <input type="text" \n            name="${t.id}" \n            value="${t.initial_value||""}"\n            placeholder="${t.label}">\n        </div>`)}),e;function n(){let e="";return t.fields.forEach(t=>{if("rel_reference"===t.type){if(!t.initial_value)return;e+=`\n          <div class="f3-info-field">\n            <span class="f3-info-field-label">${t.label} - <i>${t.rel_label}</i></span>\n            <span class="f3-info-field-value">${t.initial_value||""}</span>\n          </div>`}else if("select"===t.type){if(!t.initial_value)return;e+=`\n          <div class="f3-info-field">\n            <span class="f3-info-field-label">${t.label}</span>\n            <span class="f3-info-field-value">${t.options.find(e=>e.value===t.initial_value)?.label||""}</span>\n          </div>`}else e+=`\n          <div class="f3-info-field">\n            <span class="f3-info-field-label">${t.label}</span>\n            <span class="f3-info-field-value">${t.initial_value||""}</span>\n          </div>`}),e}}function o(){return`\n      <div>\n        <hr>\n        <div class="f3-link-existing-relative">\n          <label>${t.linkExistingRelative.hasOwnProperty("title")?t.linkExistingRelative.title:"Profile already exists?"}</label>\n          <select>\n            <option value="">${t.linkExistingRelative.hasOwnProperty("select_placeholder")?t.linkExistingRelative.select_placeholder:"Select profile"}</option>\n            ${t.linkExistingRelative.options.map(t=>`<option value="${t.value}">${t.label}</option>`).join("")}\n          </select>\n        </div>\n      </div>\n    `}function d(){return'\n      <span class="f3-close-btn">\n        Ã—\n      </span>\n    '}function l(){return'<div style="height: 24px;"></div>'}}(t);return n.innerHTML=r,function(){const r=n.querySelector("form");r.addEventListener("submit",t.onSubmit);r.querySelector(".f3-cancel-btn").addEventListener("click",c);const a=r.querySelector(".f3-edit-btn");a&&a.addEventListener("click",h);const s=r.querySelector(".f3-delete-btn");s&&t.onDelete&&s.addEventListener("click",t.onDelete);const o=r.querySelector(".f3-add-relative-btn");o&&t.addRelative&&o.addEventListener("click",()=>{t.addRelativeActive?t.addRelativeCancel():t.addRelative(),t.addRelativeActive=!t.addRelativeActive,i()});const d=r.querySelector(".f3-remove-relative-btn");d&&t.removeRelative&&d.addEventListener("click",()=>{t.removeRelativeActive?t.removeRelativeCancel():t.removeRelative(),t.removeRelativeActive=!t.removeRelativeActive,i()});r.querySelector(".f3-close-btn").addEventListener("click",e);const l=r.querySelector(".f3-link-existing-relative select");l&&l.addEventListener("change",t.linkExistingRelative.onSelect);t.onFormCreation&&t.onFormCreation({cont:n,form_creator:t});if(t.getKinshipInfo){const e=t.getKinshipInfo();e&&n.appendChild(e)}function c(){t.editable=!1,t.onCancel&&t.onCancel(),i()}function h(){t.editable=!t.editable,i()}}(),n}},getCurrentZoom:function(t){const e=t.__zoomObj?t:t.parentNode;return n.zoomTransform(e)},handleRelsOfNewDatum:m,isAllRelativeDisplayed:w,manualZoom:x,moveToAddToAdded:p,onDeleteSyncRelReference:u,removeToAdd:f,removeToAddFromData:function(t){return t.forEach(e=>e.to_add?f(e,t):e),t},syncRelReference:h,treeFit:E,zoomTo:function(t,e){const i=t.__zoomObj?t:t.parentNode;x({amount:e/n.zoomTransform(i).k,svg:t})}});function xt({d:t,card_dim:e,card_display:n}){return{template:`\n    <g class="card-body">\n      <rect width="${e.w}" height="${e.h}" class="card-body-rect" />\n      ${wt({d:t,card_dim:e,card_display:n}).template}\n    </g>\n  `}}function wt({d:t,card_dim:e,card_display:n}){return{template:`\n    <g>\n      <g class="card-text" clip-path="url(#card_text_clip)">\n        <g transform="translate(${e.text_x}, ${e.text_y})">\n          <text>\n            ${Array.isArray(n)?n.map(e=>`<tspan x="0" dy="14">${e(t.data)}</tspan>`).join("\n"):n(t.data)}\n          </text>\n        </g>\n      </g>\n      <rect width="${e.w-10}" height="${e.h}" style="mask: url(#fade)" class="text-overflow-mask" /> \n    </g>\n  `}}function Ct({d:t,card_dim:e,is_new:n}){return{template:`\n    <rect width="${e.w}" height="${e.h}" rx="4" ry="4" class="card-outline ${t.data.main&&!n?"card-main-outline":""} ${n?"card-new-outline":""}" />\n  `}}function $t({x:t,y:e,rt:n,closed:i}){return{template:`\n    <g style="\n          transform: translate(-12.2px, -.5px);\n          cursor: pointer;\n        " \n        fill="currentColor" class="card_break_link${i?" closed":""}"\n      >\n      <g style="transform: translate(${t}px,${e}px)scale(.02)rotate(${n+"deg"})">\n        <rect width="1000" height="700" y="150" style="opacity: 0" />\n        <g class="link_upper">\n          <g>\n            <path d="M616.3,426.4c19,4.5,38.1-7.4,42.6-26.4c4.4-19-7.4-38-26.5-42.5L522.5,332c-18,11.1-53.9,33.4-53.9,33.4l80.4,18.6c-7.8,4.9-19.5,12.1-31.3,19.4L616.3,426.4L616.3,426.4z"/>\n            <path d="M727.4,244.2c-50.2-11.6-100.3,3.3-135.7,35.4c28.6,22.6,64.5,30.2,116.4,51.3l141,32.6c23.9,5.6,56.6,47.2,51.1,71l-4.1,17c-5.6,23.7-47.3,56.4-71.2,51l-143.4-33.2c-66.8-8.6-104.1-16.6-132.9-7.5c17.4,44.9,55.9,80.8,106.5,92.4L800.9,588c81.3,18.8,162.3-31.5,181.2-112.4l4-17c18.8-81.1-31.7-161.8-112.9-180.6L727.4,244.2z"/>\n          </g>\n        </g>\n        <g class="link_lower">\n          <path d="M421.2,384.9l-128,127.6c-13.9,13.8-13.9,36.2,0,50s36.3,13.8,50.2,0.1l136.2-135.8v-36.7l-58.4,58.1V384.9L421.2,384.9z"/>\n          <path d="M204.6,742.8c-17.4,17.3-63.3,17.2-80.6,0.1l-12.3-12.3c-17.3-17.3,0.6-81.2,17.9-98.5l100.2-99.9c12.5-14.9,45.8-40.8,66.1-103.7c-47.7-9.4-98.9,4.2-135.8,40.9L54.2,575c-58.9,58.8-58.9,154,0,212.8L66.6,800c58.9,58.8,154.5,58.8,213.4,0l105.8-105.6c38.4-38.3,51.3-91.9,39.7-141c-44,22.7-89,62.3-116,84.8L204.6,742.8z"/>\n        </g>\n        <g class="link_particles">\n          <path d="M351.9,248.4l-26.5,63.4l80.6,30.1L351.9,248.4z"/>\n          <path d="M529.3,208l-43,26.6l35.4,52.3L529.3,208z"/>\n          <path d="M426.6,158.8l-44-2.9l61.7,134.6L426.6,158.8z"/>\n        </g>\n      </g>\n    </g>\n  `}}function kt(t,e,n){const i=document.createElementNS("http://www.w3.org/2000/svg","g");i.innerHTML=t,n?e.insertBefore(i,e.firstChild):e.appendChild(i)}const St={miniTree:function(t,e){if(t.data.to_add)return;const i=e.card_dim;if(t.all_rels_displayed)return;const r=n.create("svg:g").html(function({d:t,card_dim:e}){return{template:`\n    <g class="card_family_tree" style="cursor: pointer">\n      <rect x="-31" y="-25" width="72" height="15" fill="rgba(0,0,0,0)"></rect>\n      <g transform="translate(${.8*e.w},6)scale(.9)">\n        <rect x="-31" y="-25" width="72" height="15" fill="rgba(0,0,0,0)"></rect>\n        <line y2="-17.5" stroke="#fff" />\n        <line x1="-20" x2="20" y1="-17.5" y2="-17.5" stroke="#fff" />\n        <rect x="-31" y="-25" width="25" height="15" rx="5" ry="5" class="card-male" />\n        <rect x="6" y="-25" width="25" height="15" rx="5" ry="5" class="card-female" />\n      </g>\n    </g>\n  `}}({d:t,card_dim:i}).template);return r.on("click",function(n){n.stopPropagation(),e.onMiniTreeClick?e.onMiniTreeClick.call(this,n,t):H(e.store,{d:t})}),r.node()},lineBreak:function(t,e){if(t.data.to_add)return;const i=e.card_dim,r=n.create("svg:g").html(function({d:t,card_dim:e}){let n="",i=t.data.rels,r=t.data._rels||{},a=t.data.hide_rels,s=t=>t.father||t.mother,o=t=>t.children&&t.children.length>0;if((t.is_ancestry||t.data.main)&&(s(i)||s(r))&&(n+=$t({x:e.w/2,y:0,rt:-45,closed:a}).template),!t.is_ancestry&&t.added){const s=t.spouse,d=s.data.rels,l=s.data._rels||{};(o(i)||o(r))&&(o(d)||o(l))&&(n+=$t({x:t.sx-t.x+e.w/2+24.4,y:(t.x!==t.sx?e.h/2:e.h)+1,rt:135,closed:a}).template)}return{template:n}}({d:t,card_dim:i}).template);return r.on("click",n=>{n.stopPropagation(),P(e.store,{d:t})}),r.node()},cardBody:function(t,e){const i=e.cardEditForm?"ADD":"UNKNOWN",r=e.card_dim;let a;t.data.to_add?(a=n.create("svg:g").html(function({d:t,card_dim:e,card_add:n,label:i}){return{template:`\n    <g class="card-body ${n?"card_add":"card-unknown"}">\n      <rect class="card-body-rect" width="${e.w}" height="${e.h}" fill="rgb(59, 85, 96)" />\n      <text transform="translate(${e.w/2}, ${e.h/2})" text-anchor="middle" fill="#fff">\n        <tspan font-size="18" dy="8">${i}</tspan>\n      </text>\n    </g>\n  `}}({d:t,card_dim:r,card_add:e.cardEditForm,label:i}).template),a.on("click",n=>{n.stopPropagation(),O(e.store,{d:t,cardEditForm:e.cardEditForm})})):(a=n.create("svg:g").html(xt({d:t,card_dim:r,card_display:e.card_display}).template),a.on("click",function(n){n.stopPropagation(),e.onCardClick?e.onCardClick.call(this,n,t):H(e.store,{d:t})}));return a.node()},cardImage:function(t,e){if(t.data.to_add)return;const i=e.card_dim;return n.create("svg:g").html(function({d:t,image:e,card_dim:n,maleIcon:i,femaleIcon:r}){return{template:`\n    <g style="transform: translate(${n.img_x}px,${n.img_y}px);" class="card_image" clip-path="url(#card_image_clip)">\n      ${e?`<image href="${e}" height="${n.img_h}" width="${n.img_w}" preserveAspectRatio="xMidYMin slice" />`:(t.data.data.gender,t.data.data.gender,`\n      <g class="genderless-icon">\n        <rect height="${n.img_h}" width="${n.img_w}" fill="rgb(59, 85, 96)" />\n        <g transform="scale(${.001616*n.img_w})">\n         <path transform="translate(50,40)" fill="lightgrey" d="M256 288c79.5 0 144-64.5 144-144S335.5 0 256 0 112 \n            64.5 112 144s64.5 144 144 144zm128 32h-55.1c-22.2 10.2-46.9 16-72.9 16s-50.6-5.8-72.9-16H128C57.3 320 0 377.3 \n            0 448v16c0 26.5 21.5 48 48 48h416c26.5 0 48-21.5 48-48v-16c0-70.7-57.3-128-128-128z" />\n        </g>\n      </g>\n    `)}      \n    </g>\n  `}}({d:t,image:t.data.data.avatar||null,card_dim:i,maleIcon:null,femaleIcon:null}).template).node()},cardEdit:function(t,e){if(t.data.to_add)return;const i=e.card_dim,r=n.create("svg:g").html(function({d:t,card_dim:e,x:n,y:i}){return{template:`\n    <g transform="translate(${n||e.w-20},${i||e.h-20})scale(.6)" style="cursor: pointer" class="card_edit pencil_icon">\n      <circle fill="rgba(0,0,0,0)" r="17" cx="8.5" cy="8.5" />\n      <path fill="currentColor" transform="translate(-1.5, -1.5)"\n         d="M19.082,2.123L17.749,0.79c-1.052-1.052-2.766-1.054-3.819,0L1.925,12.794c-0.06,0.06-0.104,0.135-0.127,0.216\n          l-1.778,6.224c-0.05,0.175-0.001,0.363,0.127,0.491c0.095,0.095,0.223,0.146,0.354,0.146c0.046,0,0.092-0.006,0.137-0.02\n          l6.224-1.778c0.082-0.023,0.156-0.066,0.216-0.127L19.082,5.942C20.134,4.89,20.134,3.176,19.082,2.123z M3.076,13.057l9.428-9.428\n          l3.738,3.739l-9.428,9.428L3.076,13.057z M2.566,13.961l3.345,3.344l-4.683,1.339L2.566,13.961z M18.375,5.235L16.95,6.66\n          l-3.738-3.739l1.425-1.425c0.664-0.663,1.741-0.664,2.405,0l1.333,1.333C19.038,3.493,19.038,4.572,18.375,5.235z"/>\n    </g>\n  `}}({card_dim:i,x:i.w-46,y:i.h-20}).template);return r.on("click",n=>{n.stopPropagation(),O(e.store,{d:t,cardEditForm:e.cardEditForm})}),r.node()},cardAdd:function(t,e){if(t.data.to_add)return;const i=e.card_dim,r=n.create("svg:g").html(function({d:t,card_dim:e,x:n,y:i}){return{template:`\n    <g class="card_add_relative">\n      <g transform="translate(${n||e.w/2},${i||e.h})scale(.13)">\n        <circle r="80" cx="40" cy="40" fill="rgba(0,0,0,0)" />\n        <g transform="translate(-10, -8)">\n          <line\n            x1="10" x2="90" y1="50" y2="50"\n            stroke="currentColor" stroke-width="15" stroke-linecap="round"\n          />\n          <line\n            x1="50" x2="50" y1="10" y2="90"\n            stroke="currentColor" stroke-width="15" stroke-linecap="round"\n          />\n        </g>\n      </g>\n    </g>\n  `}}({card_dim:i,x:i.w-26,y:i.h-20}).template);return r.on("click",n=>{n.stopPropagation(),e.addRelative({d:t})}),r.node()}};function Et(t,e,n){t&&(n?e.insertBefore(t,e.firstChild):e.appendChild(t))}function It(t,e){function n(t,e,n){const{w:i,h:r}=t,a=e,s=n||[],o=t=>s.includes(t);return`${o("lx")?"M0,0":`M0,${a} Q 0,0 5,0`} ${o("rx")?`H${i}`:`H${i-a} Q ${i},0 ${i},5`} ${o("ry")?`V${r}`:`V${r-a} Q ${i},${r} ${i-a},${r}`} ${o("ly")?"H0":`H${a} Q 0,${r} 0,${r-a}`} z`}t.querySelector("defs#f3CardDef")||t.insertAdjacentHTML("afterbegin",`\n      <defs id="f3CardDef">\n        <linearGradient id="fadeGrad">\n          <stop offset="0.9" stop-color="white" stop-opacity="0"/>\n          <stop offset=".91" stop-color="white" stop-opacity=".5"/>\n          <stop offset="1" stop-color="white" stop-opacity="1"/>\n        </linearGradient>\n        <mask id="fade" maskContentUnits="objectBoundingBox"><rect width="1" height="1" fill="url(#fadeGrad)"/></mask>\n        <clipPath id="card_clip"><path d="${n({w:e.w,h:e.h},5)}"></clipPath>\n        <clipPath id="card_text_clip"><rect width="${e.w-10}" height="${e.h}"></rect></clipPath>\n        <clipPath id="card_image_clip"><path d="M0,0 Q 0,0 0,0 H${e.img_w} V${e.img_h} H0 Q 0,${e.img_h} 0,${e.img_h} z"></clipPath>\n        <clipPath id="card_image_clip_curved"><path d="${n({w:e.img_w,h:e.img_h},5,["rx","ry"])}"></clipPath>\n      </defs>\n    `)}function Mt(t,e){this.cont=t,this.popup_cont=null,this.active=!1,this.onClose=e,this.init()}Mt.prototype.init=function(){this.popup_cont=n.select(this.cont).append("div").attr("class","f3-popup").node(),this.create()},Mt.prototype.create=function(){const t=n.select(this.popup_cont);t.html('\n    <div class="f3-popup-content">\n      <span class="f3-popup-close">&times;</span>\n      <div class="f3-popup-content-inner"></div>\n    </div>\n  '),t.select(".f3-popup-close").on("click",()=>{this.close()}),t.on("click",e=>{e.target==t.node()&&this.close()})},Mt.prototype.activate=function(t){t&&n.select(this.popup_cont).select(".f3-popup-content-inner").node().appendChild(t),this.open()},Mt.prototype.open=function(){this.active=!0},Mt.prototype.close=function(){this.popup_cont.remove(),this.active=!1,this.onClose&&this.onClose()};var At=Object.freeze({__proto__:null,Card:function(t){return It((t=function(t){const e={img:!0,mini_tree:!0,link_break:!1,card_dim:{w:220,h:70,text_x:75,text_y:15,img_w:60,img_h:60,img_x:5,img_y:5}};t||(t={});for(const n in e)void 0===t[n]&&(t[n]=e[n]);return t}(t)).svg,t.card_dim),function(e){const i="M"===e.data.data.gender?"card-male":"F"===e.data.data.gender?"card-female":"card-genderless",r=t.card_dim,a=n.create("svg:g").attr("class",`card ${i}`).attr("transform",`translate(${[-r.w/2,-r.h/2]})`);a.append("g").attr("class","card-inner").attr("clip-path","url(#card_clip)"),this.innerHTML="",this.appendChild(a.node()),kt(Ct({d:e,card_dim:r,is_new:e.data.to_add}).template,a.node(),!0),Et(St.cardBody(e,t),this.querySelector(".card-inner")),t.img&&Et(St.cardImage(e,t),this.querySelector(".card")),t.mini_tree&&Et(St.miniTree(e,t),this.querySelector(".card"),!0),t.link_break&&Et(St.lineBreak(e,t),this.querySelector(".card")),t.cardEditForm&&(Et(St.cardEdit(e,t),this.querySelector(".card-inner")),Et(St.cardAdd(e,t),this.querySelector(".card-inner"))),t.onCardUpdates&&t.onCardUpdates.map(t=>t.call(this,e)),t.onCardUpdate&&t.onCardUpdate.call(this,e)}},CardHtml:function(t){const e="default"===t.style?a:"imageCircleRect"===t.style?function(e){return e.data.data[t.cardImageField]?s(e):o(e)}:"imageCircle"===t.style?s:"imageRect"===t.style?function(t){return i(t)}:"rect"===t.style?o:a;return function(i){if(this.innerHTML=`\n    <div class="card ${function(t){const e=[];"M"===t.data.data.gender?e.push("card-male"):"F"===t.data.data.gender?e.push("card-female"):e.push("card-genderless");e.push(`card-depth-${t.is_ancestry?-t.depth:t.depth}`),t.data.main&&e.push("card-main");t.data._new_rel_data&&e.push("card-new-rel");t.data.to_add&&e.push("card-to-add");t.data.unknown&&e.push("card-unknown");return e}(i).join(" ")}" data-id="${i.tid}" style="transform: translate(-50%, -50%); pointer-events: auto;">\n      ${t.mini_tree?function(e){return t.mini_tree?e.data.to_add||e.data._new_rel_data||e.all_rels_displayed?"":`<div class="mini-tree">${ht()}</div>`:""}(i):""}\n      ${t.cardInnerHtmlCreator&&!i.data._new_rel_data?t.cardInnerHtmlCreator(i):e(i)}\n    </div>\n    `,this.querySelector(".card").addEventListener("click",e=>t.onCardClick(e,i)),t.onCardUpdate&&t.onCardUpdate.call(this,i),t.onCardMouseenter&&n.select(this).select(".card").on("mouseenter",e=>t.onCardMouseenter(e,i)),t.onCardMouseleave&&n.select(this).select(".card").on("mouseleave",e=>t.onCardMouseleave(e,i)),i.duplicate&&function(t,e){n.select(t).on("mouseenter",i=>{n.select(t.closest(".cards_view")).selectAll(".card_cont").select(".card").classed("f3-card-duplicate-hover",t=>t.data.id===e.data.id)}),n.select(t).on("mouseleave",e=>{n.select(t.closest(".cards_view")).selectAll(".card_cont").select(".card").classed("f3-card-duplicate-hover",!1)})}(this,i),t.duplicate_branch_toggle&&function(t,e,i,r){if(!e.hasOwnProperty("_toggle"))return;const a=t.querySelector(".card"),s=a.querySelector(".card-inner"),o=t.querySelector(".card").offsetWidth;let d,l;t.querySelector(".card").offsetHeight;const c={};if(e.spouse){const t=e.spouse,n=t.data.main?"main":t.parent.data.id;if(d=t.data._tgdp_sp[n][e.data.id]<0,c.top=60,c.left=e.sx-e.x-30+o/2,i&&(c.top=e.sy-e.x+4,c.left=o/2+4,Math.abs(e.sx-e.y)<10&&(c.left=o-4)),l=t._toggle_id_sp?t._toggle_id_sp[e.data.id]:-1,-1===l)return}else{const t=e.data.main?"main":e.parent.data.id;d=e.data._tgdp[t]<0,c.top=-65,c.left=o/2-30,i&&(c.top=5,c.left=-55),l=e._toggle_id}if(s.style.zIndex=1,n.select(a).append("div").attr("class","f3-toggle-div").attr("style","cursor: pointer; width: 60px; height: 60px;position: absolute; z-index: -1;").style("top",c.top+"px").style("left",c.left+"px").on("click",t=>{if(t.stopPropagation(),e.spouse){const t=e.spouse,n=t.data.main?"main":t.parent.data.id;t.data._tgdp_sp[n].hasOwnProperty(e.data.id)||console.error("no toggle",e,t);let i=t.data._tgdp_sp[n][e.data.id];i=i<0?(new Date).getTime():-(new Date).getTime(),t.data._tgdp_sp[n][e.data.id]=i}else{const t=e.data.main?"main":e.parent.data.id;let n=e.data._tgdp[t];n=n<0?(new Date).getTime():-(new Date).getTime(),e.data._tgdp[t]=n}r()}).append("div").html(d?pt():ut()).select("svg").classed("f3-toggle-icon",!0).style("color",d?"#585656":"#61bf52").style("padding","0"),n.select(a).select(".f3-toggle-icon .f3-small-circle").style("fill","#fff"),n.select(a).select(".f3-toggle-icon").append("text").attr("transform",d?"translate(10.6, 14.5)":"translate(4.1, 14.5)").attr("fill","#fff").attr("font-size","7px").text("C"+l),d){let t;t=e.is_ancestry?i?"translate(5, -30)rotate(-90)":"translate(0, -10)":i?"translate(11, -22)rotate(90)":"translate(-7, -32)rotate(180)",n.select(a).select(".f3-toggle-div").insert("div").html(ht()).select("svg").attr("style","position: absolute; z-index: -1;top: 0;left: 0;border-radius: 0;").style("width","66px").style("height","112px").attr("transform",t).attr("viewBox","0 0 72 125").select("line").attr("y1",e.is_ancestry?"62":"92")}}(this,i,t.store.state.is_horizontal,t.store.updateTree),location.origin.includes("localhost")&&(i.__node=this.querySelector(".card"),i.__label=i.data.data["first name"],i.data.to_add)){const t=i.spouse||i._spouse||null;t&&n.select(this).select(".card").attr("data-to-add",t.data.data["first name"])}};function i(e){return`\n    <div class="card-inner card-image-rect" ${d()}>\n      ${e.data.data[t.cardImageField]?`<img src="${e.data.data[t.cardImageField]}" ${l()}>`:c(e)}\n      <div class="card-label">${r(e)}</div>\n      ${e.duplicate?h(e):""}\n    </div>\n    `}function r(e){return e.data._new_rel_data?function(t){const e=[];e.push(`data-rel-type="${t.data._new_rel_data.rel_type}"`),["son","daughter"].includes(t.data._new_rel_data.rel_type)&&e.push(`data-other-parent-id="${t.data._new_rel_data.other_parent_id}"`);return`<div ${e.join(" ")}>${t.data._new_rel_data.label}</div>`}(e):e.data.to_add?`<div>${t.empty_card_label||"ADD"}</div>`:e.data.unknown?`<div>${t.unknown_card_label||"UNKNOWN"}</div>`:`\n      ${t.card_display.map(t=>`<div>${t(e.data)}</div>`).join("")}\n    `}function a(t){return i(t)}function s(e){return function(e){return`\n    <div class="card-inner card-image-circle" ${d()}>\n      ${e.data.data[t.cardImageField]?`<img src="${e.data.data[t.cardImageField]}" ${l()}>`:c(e)}\n      <div class="card-label">${r(e)}</div>\n      ${e.duplicate?h(e):""}\n    </div>\n    `}(e)}function o(t){return function(t){return`\n    <div class="card-inner card-rect" ${d()}>\n      ${r(t)}\n      ${t.duplicate?h(t):""}\n    </div>\n    `}(t)}function d(){let e='style="';return t.card_dim.w||t.card_dim.h?(e+=`width: ${t.card_dim.w}px; min-height: ${t.card_dim.h}px;`,t.card_dim.height_auto?e+="height: auto;":e+=`height: ${t.card_dim.h}px;`,e+='"',e):""}function l(){let e='style="position: relative;';return t.card_dim.img_w||t.card_dim.img_h||t.card_dim.img_x||t.card_dim.img_y?(e+=`width: ${t.card_dim.img_w}px; height: ${t.card_dim.img_h}px;`,e+=`left: ${t.card_dim.img_x}px; top: ${t.card_dim.img_y}px;`,e+='"',e):""}function c(e){return e.data._new_rel_data?`<div class="person-icon" ${l()}>${at()}</div>`:`<div class="person-icon" ${l()}>${t.defaultPersonIcon?t.defaultPersonIcon(e):ct()}</div>`}function h(t){return`<div class="f3-card-duplicate-tag">x${t.duplicate}</div>`}},CardSvg:function(t){return It((t=function(t){const e={img:!0,mini_tree:!0,link_break:!1,card_dim:{w:220,h:70,text_x:75,text_y:15,img_w:60,img_h:60,img_x:5,img_y:5}};t||(t={});for(const n in e)void 0===t[n]&&(t[n]=e[n]);return t}(t)).svg,t.card_dim),function(e){const i="M"===e.data.data.gender?"card-male":"F"===e.data.data.gender?"card-female":"card-genderless",r=t.card_dim,a=n.create("svg:g").attr("class",`card ${i}`).attr("transform",`translate(${[-r.w/2,-r.h/2]})`);a.append("g").attr("class","card-inner").attr("clip-path","url(#card_clip)"),this.innerHTML="",this.appendChild(a.node()),a.on("click",function(n){n.stopPropagation(),t.onCardClick.call(this,n,e)}),e.data._new_rel_data?(kt(Ct({d:e,card_dim:r,is_new:e.data.to_add}).template,a.node(),!0),kt(function({d:t,card_dim:e,label:n}){return{template:`\n    <g class="card-body">\n      <rect class="card-body-rect" width="${e.w}" height="${e.h}" />\n      <text transform="translate(${e.img_w+5}, ${e.h/2})">\n        <tspan font-size="18" dy="8" pointer-events="none">${n}</tspan>\n      </text>\n    </g>\n  `}}({d:e,card_dim:r,label:e.data._new_rel_data.label}).template,this.querySelector(".card-inner"),!0),n.select(this.querySelector(".card-inner")).append("g").attr("class","card-edit-icon").attr("fill","currentColor").attr("transform",`translate(-1,2)scale(${r.img_h/22})`).html(V())):(kt(Ct({d:e,card_dim:r,is_new:e.data.to_add}).template,a.node(),!0),kt(xt({d:e,card_dim:r,card_display:t.card_display}).template,this.querySelector(".card-inner")),t.img&&Et(St.cardImage(e,t),this.querySelector(".card")),t.mini_tree&&Et(St.miniTree(e,t),this.querySelector(".card"),!0),t.link_break&&Et(St.lineBreak(e,t),this.querySelector(".card"))),t.onCardUpdate&&t.onCardUpdate.call(this,e)}},appendElement:Et,infoPopup:function(...t){return new Mt(...t)}});function Ft(t,e,n){return this.store=t,this.onActivate=e,this.cancelCallback=n,this.datum=null,this.onChange=null,this.onCancel=null,this.is_active=!1,this.addRelLabels=this.addRelLabelsDefault(),this}Ft.prototype.activate=function(t){this.is_active&&this.onCancel(),this.onActivate(),this.is_active=!0,this.store.state.one_level_rels=!0;const e=this.store;this.datum=t;let n=this.datum.data.gender;!function(t,e,n){if(!t.rels.father){const i=g({data:{gender:"M"},rels:{children:[t.id]}});i._new_rel_data={rel_type:"father",label:n.father,rel_id:t.id},t.rels.father=i.id,e.push(i)}if(!t.rels.mother){const i=g({data:{gender:"F"},rels:{children:[t.id]}});i._new_rel_data={rel_type:"mother",label:n.mother,rel_id:t.id},t.rels.mother=i.id,e.push(i)}const i=e.find(e=>e.id===t.rels.mother),r=e.find(e=>e.id===t.rels.father);i.rels.spouses||(i.rels.spouses=[]);r.rels.spouses||(r.rels.spouses=[]);i.rels.spouses.includes(r.id)||i.rels.spouses.push(r.id);r.rels.spouses.includes(i.id)||r.rels.spouses.push(i.id);i.rels.children||(i.rels.children=[]);r.rels.children||(r.rels.children=[]);i.rels.children.includes(t.id)||i.rels.children.push(t.id);r.rels.children.includes(t.id)||r.rels.children.push(t.id);t.rels.spouses||(t.rels.spouses=[]);if(t.rels.children){let i;t.rels.children.forEach(r=>{const a=e.find(t=>t.id===r);a.rels.mother||(i||(i=g({data:{gender:"F"},rels:{spouses:[t.id],children:[]}})),i._new_rel_data={rel_type:"spouse",label:n.spouse,rel_id:t.id},i.rels.children.push(a.id),t.rels.spouses.push(i.id),a.rels.mother=i.id,e.push(i)),a.rels.father||(i||(i=g({data:{gender:"M"},rels:{spouses:[t.id],children:[]}})),i._new_rel_data={rel_type:"spouse",label:n.spouse,rel_id:t.id},i.rels.children.push(a.id),t.rels.spouses.push(i.id),a.rels.father=i.id,e.push(i))})}const a="M"===t.data.gender?"F":"M",s=g({data:{gender:a},rels:{spouses:[t.id]}});s._new_rel_data={rel_type:"spouse",label:n.spouse,rel_id:t.id},t.rels.spouses.push(s.id),e.push(s),t.rels.children||(t.rels.children=[]);t.rels.spouses.forEach(i=>{const r=e.find(t=>t.id===i),a="M"===t.data.gender?r.id:t.id,s="F"===t.data.gender?r.id:t.id;r.rels.children||(r.rels.children=[]);const o=g({data:{gender:"M"},rels:{father:s,mother:a}});o._new_rel_data={rel_type:"son",label:n.son,other_parent_id:r.id,rel_id:t.id},r.rels.children.push(o.id),t.rels.children.push(o.id),e.push(o);const d=g({data:{gender:"F"},rels:{mother:a,father:s}});d._new_rel_data={rel_type:"daughter",label:n.daughter,other_parent_id:r.id,rel_id:t.id},r.rels.children.push(d.id),t.rels.children.push(d.id),e.push(d)})}(t,this.getStoreData(),this.addRelLabels),e.updateTree({}),this.onChange=function(i,r){i?._new_rel_data?r?.link_rel_id?l(i,r.link_rel_id,e.getData()):delete i._new_rel_data:i.id===t.id?i.data.gender!==n&&function(){n=i.data.gender;e.getData().forEach(t=>{const e=t._new_rel_data;e&&("spouse"===e.rel_type&&(t.data.gender="M"===t.data.gender?"F":"M"),["son","daughter"].includes(e.rel_type)&&([t.rels.father,t.rels.mother]=[t.rels.mother,t.rels.father]))})}():console.error("Something went wrong")}.bind(this),this.onCancel=function(){if(!this.is_active)return;this.is_active=!1,this.store.state.one_level_rels=!1,this.cleanUp(),this.cancelCallback(this.datum),this.datum=null,this.onChange=null,this.onCancel=null}.bind(this)},Ft.prototype.setAddRelLabels=function(t){if("object"==typeof t){for(let e in t)this.addRelLabels[e]=t[e];return this}console.error("add_rel_labels must be an object")},Ft.prototype.addRelLabelsDefault=function(){return{father:"Add Father",mother:"Add Mother",spouse:"Add Spouse",son:"Add Son",daughter:"Add Daughter"}},Ft.prototype.getStoreData=function(){return this.store.getData()},Ft.prototype.cleanUp=function(t){t||(t=this.store.getData());for(let e=t.length-1;e>=0;e--){const n=t[e];n._new_rel_data&&(t.forEach(t=>{t.rels.father===n.id&&delete t.rels.father,t.rels.mother===n.id&&delete t.rels.mother,(t.rels.children||[]).includes(n.id)&&t.rels.children.splice(t.rels.children.indexOf(n.id),1),(t.rels.spouses||[]).includes(n.id)&&t.rels.spouses.splice(t.rels.spouses.indexOf(n.id),1)}),t.splice(e,1))}return t};function Lt(t,e,n,i){return this.store=t,this.onActivate=e,this.cancelCallback=n,this.modal=i,this.datum=null,this.onChange=null,this.onCancel=null,this.is_active=!1,this}function Tt(t){this.cont=t,this.modal_cont=null,this.active=!1,this.onClose=null,this.init()}function Dt(t,e,n={}){const i=e.find(e=>e.id===t),r={};return function t(n,i,a,s){if(!n)return;r[n]&&r[n]!==i&&console.error("kinship mismatch, kinship 1: ",r[n],"kinship 2: ",i);if(r[n])return;i&&(r[n]=i);const o=e.find(t=>t.id===n),d=o.rels;if("self"===i)t(d.father,"parent",a-1,n),t(d.mother,"parent",a-1,n),(d.spouses||[]).forEach(e=>t(e,"spouse",a)),(d.children||[]).forEach(e=>t(e,"child",a+1));else if("parent"===i)t(d.father,"grandparent",a-1,n),t(d.mother,"grandparent",a-1,n),(d.children||[]).forEach(e=>{s&&s===e||t(e,"sibling",a+1)});else if("spouse"===i);else if("child"===i)(d.children||[]).forEach(e=>t(e,"grandchild",a+1));else if("sibling"===i)(d.children||[]).forEach(e=>t(e,"nephew",a+1));else if("grandparent"===i)s||console.error(`${i} should have prev_rel_id`),t(d.father,"great-grandparent",a-1,n),t(d.mother,"great-grandparent",a-1,n),(d.children||[]).forEach(e=>{s&&s===e||t(e,"uncle",a+1)});else if(i.includes("grandchild"))(d.children||[]).forEach(e=>t(e,zt(i,a+1),a+1));else if(i.includes("great-grandparent"))s||console.error(`${i} should have prev_rel_id`),t(d.father,zt(i,a-1),a-1,n),t(d.mother,zt(i,a-1),a-1,n),(d.children||[]).forEach(e=>{if(s&&s===e)return;const n=Pt(a+1);0===n?t(e,"granduncle",a+1):n>0?t(e,zt("granduncle",a+1),a+1):console.error(`${i} should have great_count > -1`)});else if("nephew"===i)(d.children||[]).forEach(e=>t(e,"grandnephew",a+1));else if(i.includes("grandnephew"))(d.children||[]).forEach(e=>t(e,zt(i,a+1),a+1));else if("uncle"===i)(d.children||[]).forEach(e=>t(e,"1st Cousin",a+1));else if("granduncle"===i)(d.children||[]).forEach(e=>t(e,"1st Cousin 1x removed",a+1));else if(i.includes("great-granduncle")){const e=a+1,n=Math.abs(e);(d.children||[]).forEach(i=>t(i,`1st Cousin ${n}x removed`,e))}else i.slice(4).startsWith("Cousin")?(d.children||[]).forEach(e=>{const n=a+1,r=Math.abs(n),s=+i[0];0===n?t(e,`${Ot(s+1)} Cousin`,n):n<0?t(e,`${Ot(s+1)} Cousin ${r}x removed`,n):n>0&&t(e,`${Ot(s)} Cousin ${r}x removed`,n)}):console.error(`${i} not found`)}(i.id,"self",0),function(t){const n=[];Object.keys(t).forEach(r=>{const a=t[r];if(a.includes("child"))return;if("spouse"===a)return;const s=Rt(i.id,r,e);if(!s)return console.error(`${e.find(t=>t.id===r).data} not found in main_ancestry`);s.is_half_kin&&n.push(r)}),n.forEach(e=>{t[e]=`Half ${t[e]}`})}(r),n.show_in_law&&function(t,e){Object.keys(t).forEach(n=>{const i=t[n],r=e.find(t=>t.id===n);if("spouse"===i){const e=[];r.rels.mother&&(a(r.rels.mother).rels.children||[]).forEach(t=>e.push(t)),r.rels.father&&(a(r.rels.father).rels.children||[]).forEach(t=>e.push(t)),e.forEach(e=>{t[e]||(t[e]="sibling-in-law")})}"child"===i&&(r.rels.spouses||[]).forEach(e=>{t[e]||(t[e]="child-in-law")}),"uncle"===i&&(r.rels.spouses||[]).forEach(e=>{t[e]||(t[e]="uncle-in-law")}),i.includes("Cousin")&&(r.rels.spouses||[]).forEach(e=>{t[e]||(t[e]=`${i} in-law`)})})}(r,e),function(t){Object.keys(t).forEach(n=>{const i=t[n],r=e.find(t=>t.id===n).data.gender;if(i.includes("parent")){const e="M"===r?"father":"F"===r?"mother":"parent";t[n]=t[n].replace("parent",e)}else if(i.includes("sibling")){const e="M"===r?"brother":"F"===r?"sister":"sibling";t[n]=t[n].replace("sibling",e)}else if(i.includes("child")){const e="M"===r?"son":"F"===r?"daughter":"child";t[n]=t[n].replace("child",e)}else if(i.includes("uncle")){const e="M"===r?"uncle":"F"===r?"aunt":"aunt/uncle";t[n]=t[n].replace("uncle",e)}else if(i.includes("nephew")){const e="M"===r?"nephew":"F"===r?"niece":"neice/nephew";t[n]=t[n].replace("nephew",e)}})}(r),r;function a(t){return e.find(e=>e.id===t)}}function Rt(t,e,n){const i=function(t){const e=[];return function t(i){const r=n.find(t=>t.id===i),a=r.rels;e.push(o(a)),a.father&&t(a.father);a.mother&&t(a.mother)}(t),e}(t);let r,a,s;return function(t){const e=n.find(e=>e.id===t);i.find(t=>t[0]===e.id||t[1]===e.id)&&(a=!0,r=t,s=!1)}(e),function(e){(n.find(e=>e.id===t).rels.spouses||[]).includes(e)&&(r=[t,e])}(e),function e(d){if(r)return;if(d===t)return a=!0,r=d,void(s=!1);const l=n.find(t=>t.id===d),c=l.rels,h=o(c),u=i.find(t=>t[0]&&h[0]&&t[0]===h[0]||t[1]&&h[1]&&t[1]===h[1]);if(u)return r=h.filter((t,e)=>t===u[e]),f=u,void(s=(p=h)[0]!==f[0]||p[1]!==f[1]);var p,f;c.father&&e(c.father);c.mother&&e(c.mother)}(e),r?{found:r,is_ancestor:a,is_half_kin:s}:null;function o(t){return[t.father,t.mother]}}function Ht(t,e,i,r){let a;const s=r[e].toLowerCase();if(s.includes("in-law")){a=e;const n=i.find(t=>t.id===a);e=s.includes("sister")||s.includes("brother")?t:n.rels.spouses.find(t=>r[t]&&!r[t].includes("in-law"))}const o=Rt(t,e,i);if(!o)return console.error(`${e} not found in main_ancestry`);const d=o.is_ancestor?o.found:o.found[0],l=i.find(t=>t.id===d),c=n.hierarchy(l,function(t){return[...t.rels.children||[]].map(t=>i.find(e=>e.id===t))}),h=c.descendants().map(t=>t.data.id),u=_(t,h),p=_(e,h);!function t(e){e.children=(e.children||[]).filter(t=>!!u.includes(t.data.id)||!!p.includes(t.data.id)),e.children.forEach(e=>t(e)),0===e.children.length&&delete e.children}(c);const f=c.descendants().map(t=>{const e={id:t.data.id,data:JSON.parse(JSON.stringify(t.data.data)),kinship:r[t.data.id],rels:{}};return t.children&&t.children.length>0&&(e.rels.children=t.children.map(t=>t.data.id)),e});return f.length>0&&!o.is_ancestor&&!o.is_half_kin&&function(t){const e=t[0],n=d===o.found[0]?o.found[1]:o.found[0];e.rels.spouses=[n];const a=i.find(t=>t.id===n),s={id:a.id,data:JSON.parse(JSON.stringify(a.data)),kinship:r[a.id],rels:{spouses:[e.id],children:e.rels.children}};t.push(s),(e.rels.children||[]).forEach(e=>{const n=i.find(t=>t.id===e),r=t.find(t=>t.id===e);r.rels.father=n.rels.father,r.rels.mother=n.rels.mother})}(f),a&&function(t){s.includes("sister")||s.includes("brother")?function(t){const n=t.find(t=>t.id===e),i=m(a);t.push({id:a,data:JSON.parse(JSON.stringify(i.data)),kinship:r[a],rels:{spouses:[],children:[]}});const s=[];i.rels.mother&&(m(i.rels.mother).rels.children||[]).forEach(t=>s.push(t));i.rels.father&&(m(i.rels.father).rels.children||[]).forEach(t=>s.push(t));const o=m(e).rels.spouses.find(t=>s.includes(t));n.rels.spouses=[o];const d=m(o),l={id:d.id,data:JSON.parse(JSON.stringify(d.data)),kinship:r[d.id],rels:{spouses:[n.id],children:[]}};if(t.push(l),i.rels.father){const e=m(i.rels.father),n={id:e.id,data:JSON.parse(JSON.stringify(e.data)),kinship:"Father-in-law",rels:{spouses:[],children:[o,a]}};i.rels.mother&&n.rels.spouses.push(i.rels.mother),t.unshift(n)}if(i.rels.mother){const e=m(i.rels.mother),n={id:e.id,data:JSON.parse(JSON.stringify(e.data)),kinship:"Mother-in-law",rels:{spouses:[],children:[o,a]}};i.rels.father&&n.rels.spouses.push(i.rels.father),t.unshift(n)}}(t):function(t){const n=t.find(t=>t.id===e),s=a;n.rels.spouses=[s];const o=i.find(t=>t.id===s),d={id:o.id,data:JSON.parse(JSON.stringify(o.data)),kinship:r[o.id],rels:{spouses:[n.id],children:[]}};t.push(d)}(t)}(f),f;function _(t,e){const n=[t];return function t(r){const a=i.find(t=>t.id===r),s=a.rels;e.includes(s.mother)&&(n.push(s.mother),t(s.mother));e.includes(s.father)&&(n.push(s.father),t(s.father))}(t),n}function m(t){return i.find(e=>e.id===t)}}function Ot(t){const e=["st","nd","rd"];return e[t-1]?t+e[t-1]:t+"th"}function Pt(t){return Math.abs(t)-2}function zt(t,e){const n=Pt(e);return t.includes("great-")&&(t=t.split("great-")[1]),1===n?`great-${t}`:n>1?`${n}x-great-${t}`:(console.error(`${t} should have great_count > 1`),t)}function jt(t,e,i){const{self_id:r,getLabel:a,title:s}=t,o=Dt(r,i,t),d=o[e];if(!d)return;let l=d;l="self"===d?"You":qt(l);const c=`\n    <div class="f3-kinship-info">\n      <div class="f3-info-field">\n        <span class="f3-info-field-label">${s}</span>\n        <span class="f3-info-field-value">\n          <span>${l}</span>\n          <span class="f3-kinship-info-icon">${mt()}</span>\n        </span>\n      </div>\n    </div>\n  `,h=n.create("div").html(c).select("div").node();let u;return n.select(h).select(".f3-kinship-info-icon").on("click",t=>function(t,s){const d=250,l=400;let c=t.clientX-d-10,h=t.clientY-l-10;c+d>window.innerWidth&&(c=window.innerWidth-d-10);h<0&&(h=10);if(u&&u.active)return u.close(),void(u=null);u=Xt.elements.infoPopup(s),n.select(u.popup_cont).style("width",`${d}px`).style("height",`${l}px`).style("left",`${c}px`).style("top",`${h}px`);const p=u.popup_cont.querySelector(".f3-popup-content-inner");u.activate(),function(t,e,i,r,a,s){n.select(a).select("#SmallChart").node()||n.select(a).append("div").attr("id","SmallChart").attr("class","f3");const o=n.select("#SmallChart");o.selectAll("*").remove();const d=Ht(t,e,i,r);let l=!0;const c=o.append("div");function h(t){const i=Xt.createChart("#SmallChart",t).setTransitionTime(500).setCardXSpacing(170).setCardYSpacing(70).setSingleParentEmptyCard(!1);function r(t){let n="self"===t.data.kinship?"You":t.data.kinship;return n=qt(n),l||(n=s(t.data)),`\n        <div class="card-inner card-rect ${i()}">\n          <div class="card-label">${n}</div>\n        </div>\n      `;function i(){return"self"===t.data.kinship?"card-kinship-self"+(l?"":" f3-real-label"):t.data.id===e?"card-kinship-rel":"card-kinship-default"}}function a(){c.classed("f3-kinship-labels-toggle",!0),c.append("label").text("Kinship labels").append("input").attr("type","checkbox").attr("checked",!0).on("change",t=>{l=!l,i.updateTree({initial:!1,tree_position:"inherit"})})}function o(t){const e=i.cont.querySelector("svg.main_svg");Xt.handlers.getCurrentZoom(e).k>t&&Xt.handlers.zoomTo(e,t)}i.setCard(Xt.CardHtml).setStyle("rect").setCardInnerHtmlCreator(t=>r(t)).setOnCardUpdate(function(t){n.select(this).select(".card").classed("card-main",!1)}).onCardClick=(t,e)=>{},i.updateTree({initial:!0}),setTimeout(()=>o(.65),100),a()}h(d)}(r,e,i,o,p,a)}(t,h)),h}function qt(t){return(t=t[0].toUpperCase()+t.slice(1)).includes("great-")&&(t=t.replace("great-","Great-")),t}function Ut(t,e){return this.cont=t,this.store=e,this.fields=[{type:"text",label:"first name",id:"first name"},{type:"text",label:"last name",id:"last name"},{type:"text",label:"birthday",id:"birthday"},{type:"text",label:"avatar",id:"avatar"}],this.form_cont=null,this.is_fixed=!0,this.history=null,this.no_edit=!1,this.onChange=null,this.editFirst=!1,this.postSubmit=null,this.link_existing_rel_config=null,this.onFormCreation=null,this.kinship_info_config=null,this.init(),this}function Vt(t,e){this.cont=t,this.autocomplete_cont=null,this.options=[],this.onSelect=e,this.init()}function Nt(...t){return new Bt(...t)}function Bt(t,e){return this.cont=null,this.store=null,this.svg=null,this.getCard=null,this.node_separation=250,this.level_separation=150,this.is_horizontal=!1,this.single_parent_empty_card=!0,this.transition_time=2e3,this.linkSpouseText=!1,this.personSearch=null,this.is_card_html=!1,this.beforeUpdate=null,this.afterUpdate=null,this.init(t,e),this}function Jt(t){const e=[];return Array.isArray(t)?t.forEach(t=>{"function"==typeof t?e.push(t):"string"==typeof t?e.push(e=>e.data[t]):Array.isArray(t)&&e.push(e=>t.map(t=>e.data[t]).join(" "))}):"function"==typeof t?e.push(t):"string"==typeof t&&e.push(e=>e.data[t]),e}function Zt(...t){return new Wt(...t)}function Wt(t,e){return this.cont=t,this.store=e,this.svg=null,this.getCard=null,this.card_dim={w:220,h:70,text_x:75,text_y:15,img_w:60,img_h:60,img_x:5,img_y:5},this.card_display=[t=>`${t.data["first name"]} ${t.data["last name"]}`],this.mini_tree=!0,this.link_break=!1,this.onCardClick=this.onCardClickDefault.bind(this),this.onCardUpdate=null,this.init(),this}function Kt(...t){return new Gt(...t)}function Gt(t,e){return this.cont=t,this.store=e,this.getCard=null,this.card_display=[t=>`${t.data["first name"]} ${t.data["last name"]}`],this.cardImageField="avatar",this.onCardClick=this.onCardClickDefault,this.style="default",this.mini_tree=!1,this.onCardUpdate=null,this.card_dim={},this.cardInnerHtmlCreator=null,this.init(),this}function Yt(t){return t&&t.__esModule&&Object.prototype.hasOwnProperty.call(t,"default")?t.default:t}Lt.prototype.activate=function(t){this.is_active&&this.onCancel(),this.onActivate(),this.is_active=!0,this.store.state.one_level_rels=!0;const e=this.store;this.datum=t,e.updateTree({}),this.onChange=function(i,r){const a=function(e){if(e.is_ancestry){if(t.rels.father===e.data.id)return"father";if(t.rels.mother===e.data.id)return"mother"}else if(e.spouse){if(t.rels.spouses.includes(e.data.id))return"spouse"}else if(t.rels.children.includes(e.data.id))return"children";return null}(i),s=t.rels;"father"===a?function(){const n=e.getDatum(s.father);n.rels.children=n.rels.children.filter(e=>e!==t.id),s.father=null,r()}.call(this):"mother"===a?function(){const n=e.getDatum(s.mother);n.rels.children=n.rels.children.filter(e=>e!==t.id),s.mother=null,r()}.call(this):"spouse"===a?function(){const a=i.data;o()?d.call(this):l.call(this,!0);function o(){return(a.rels.children||[]).some(t=>{const n=e.getDatum(t);return n.rels.father===a.id||n.rels.mother===a.id})}function d(){const e="M"===t.data.gender?"f3-male-bg":"F"===t.data.gender?"f3-female-bg":null,i="M"===a.data.gender?"f3-male-bg":"F"===a.data.gender?"f3-female-bg":null,r=n.create("div").html(`\n          <p>You are removing a spouse relationship. Since there are shared children, please choose which parent should keep them in the family tree.</p>\n          <div class="f3-modal-options">\n            <button data-option="assign-to-current" class="f3-btn ${e}">Keep children with current person</button>\n            <button data-option="assign-to-spouse" class="f3-btn ${i}">Keep children with spouse</button>\n          </div>\n        `);r.selectAll('[data-option="assign-to-current"]').on("click",()=>{l(!0),this.modal.close()}),r.selectAll('[data-option="assign-to-spouse"]').on("click",()=>{l(!1),this.modal.close()}),this.modal.activate(r.node())}function l(n){i.data.rels.spouses=i.data.rels.spouses.filter(e=>e!==t.id),s.spouses=s.spouses.filter(t=>t!==i.data.id);const a=n?t:i.data,o=n?i.data:t;(s.children||[]).forEach(t=>{const n=e.getDatum(t);n.rels.father===o.id&&(n.rels.father=null),n.rels.mother===o.id&&(n.rels.mother=null)}),o.rels.children&&(o.rels.children=o.rels.children.filter(t=>!(a.rels.children||[]).includes(t))),r()}}.call(this):"children"===a&&function(){s.children=s.children.filter(t=>t!==i.data.id);const e=i.data.rels.father===t.id?"father":"mother";i.data.rels[e]=null,r()}.call(this)}.bind(this),this.onCancel=function(){if(!this.is_active)return;this.is_active=!1,this.store.state.one_level_rels=!1,this.cancelCallback(this.datum),this.datum=null,this.onChange=null,this.onCancel=null}.bind(this)},Tt.prototype.init=function(){this.modal_cont=n.select(this.cont).append("div").attr("class","f3-modal").node(),n.select(this.modal_cont).style("display","none"),this.create()},Tt.prototype.create=function(){const t=n.select(this.modal_cont);t.html('\n    <div class="f3-modal-content">\n      <span class="f3-modal-close">&times;</span>\n      <div class="f3-modal-content-inner"></div>\n      <div class="f3-modal-content-bottom"></div>\n    </div>\n  '),t.select(".f3-modal-close").on("click",()=>{this.close()}),t.on("click",e=>{e.target==t.node()&&this.close()})},Tt.prototype.activate=function(t,{boolean:e,onAccept:i,onCancel:r}={}){this.reset(),"string"==typeof t?n.select(this.modal_cont).select(".f3-modal-content-inner").html(t):n.select(this.modal_cont).select(".f3-modal-content-inner").node().appendChild(t),e&&(n.select(this.modal_cont).select(".f3-modal-content-bottom").html('\n      <button class="f3-modal-accept f3-btn">Accept</button>\n      <button class="f3-modal-cancel f3-btn">Cancel</button>\n    '),n.select(this.modal_cont).select(".f3-modal-accept").on("click",()=>{i(),this.reset(),this.close()}),n.select(this.modal_cont).select(".f3-modal-cancel").on("click",()=>{this.close()}),this.onClose=r),this.open()},Tt.prototype.reset=function(){this.onClose=null,n.select(this.modal_cont).select(".f3-modal-content-inner").html(""),n.select(this.modal_cont).select(".f3-modal-content-bottom").html("")},Tt.prototype.open=function(){this.modal_cont.style.display="block",this.active=!0},Tt.prototype.close=function(){this.modal_cont.style.display="none",this.active=!1,this.onClose&&this.onClose()},Ut.prototype.init=function(){this.form_cont=n.select(this.cont).append("div").classed("f3-form-cont",!0).node(),this.modal=this.setupModal(),this.addRelativeInstance=this.setupAddRelative(),this.removeRelativeInstance=this.setupRemoveRelative(),this.createHistory()},Ut.prototype.open=function(t){t.data.data&&"object"==typeof t.data.data&&(t=t.data);const e=this.store.getTreeDatum(t.id);this.addRelativeInstance.is_active?function(){t._new_rel_data?this.cardEditForm(t):(this.addRelativeInstance.onCancel(),this.cardEditForm(t),this.store.updateMainId(t.id),this.store.updateTree({}))}.call(this,t):this.removeRelativeInstance.is_active?function(){if(t.id===this.removeRelativeInstance.datum.id)this.removeRelativeInstance.onCancel(),this.cardEditForm(t);else{function n(){this.removeRelativeInstance.onCancel(),this.updateHistory(),this.store.updateTree({})}this.removeRelativeInstance.onChange(e,n.bind(this))}}.call(this,e):this.cardEditForm(t)},Ut.prototype.openWithoutRelCancel=function(t){this.cardEditForm(t)},Ut.prototype.cardEditForm=function(t){const e={},n=t?._new_rel_data;n?e.onCancel=()=>this.addRelativeInstance.onCancel():(e.addRelative=this.addRelativeInstance,e.removeRelative=this.removeRelativeInstance,e.deletePerson=()=>{_(t,this.store.getData()),this.openFormWithId(this.store.getLastAvailableMainDatum().id),this.store.updateTree({})});const i=Xt.handlers.createForm({store:this.store,datum:t,postSubmit:function(e){if(this.addRelativeInstance.is_active){this.addRelativeInstance.onChange(t,e),this.postSubmit&&this.postSubmit(t,this.store.getData());const n=this.addRelativeInstance.datum;this.store.updateMainId(n.id),this.openWithoutRelCancel(n)}else(t.to_add||t.unknown)&&e?.link_rel_id?(l(t,e.link_rel_id,this.store.getData()),this.store.updateMainId(e.link_rel_id),this.openFormWithId(e.link_rel_id)):e?.delete||(this.postSubmit&&this.postSubmit(t,this.store.getData()),this.openFormWithId(t.id));this.is_fixed||this.closeForm();this.store.updateTree({}),this.updateHistory()}.bind(this),fields:this.fields,addRelative:null,onCancel:()=>{},editFirst:this.editFirst,link_existing_rel_config:this.link_existing_rel_config,getKinshipInfo:this.kinship_info_config?()=>jt(this.kinship_info_config,t.id,this.store.getData()):null,onFormCreation:this.onFormCreation,...e});i.no_edit=this.no_edit,this.no_edit&&(i.editable=!1);const r=Xt.handlers.formInfoSetup(i,this.closeForm.bind(this));this.form_cont.innerHTML="",this.form_cont.appendChild(r),this.openForm()},Ut.prototype.openForm=function(){n.select(this.form_cont).classed("opened",!0)},Ut.prototype.closeForm=function(){n.select(this.form_cont).classed("opened",!1).html(""),this.store.updateTree({})},Ut.prototype.fixed=function(){return this.is_fixed=!0,n.select(this.form_cont).style("position","relative"),this},Ut.prototype.absolute=function(){return this.is_fixed=!1,n.select(this.form_cont).style("position","absolute"),this},Ut.prototype.setCardClickOpen=function(t){return t.setOnCardClick((e,n)=>{this.isAddingRelative()||this.isRemovingRelative()?this.open(n.data):(this.open(n.data),t.onCardClickDefault(e,n))}),this},Ut.prototype.openFormWithId=function(t){if(t){const e=this.store.getDatum(t);this.openWithoutRelCancel(e)}else{const t=this.store.getMainDatum();this.openWithoutRelCancel(t)}},Ut.prototype.createHistory=function(){return this.history=Xt.handlers.createHistory(this.store,this.getStoreDataCopy.bind(this),function(){this.addRelativeInstance.is_active&&this.addRelativeInstance.onCancel();this.removeRelativeInstance.is_active&&this.removeRelativeInstance.onCancel();this.store.updateTree({initial:!1}),this.history.controls.updateButtons(),this.openFormWithId(this.store.getMainDatum()?.id),this.onChange&&this.onChange()}.bind(this)),this.history.controls=Xt.handlers.createHistoryControls(this.cont.querySelector(".f3-nav-cont"),this.history),this.history.changed(),this.history.controls.updateButtons(),this},Ut.prototype.setNoEdit=function(){return this.no_edit=!0,this},Ut.prototype.setEdit=function(){return this.no_edit=!1,this},Ut.prototype.setFields=function(t){const e=[];if(!Array.isArray(t))return console.error("fields must be an array"),this;for(const n of t)"string"==typeof n?e.push({type:"text",label:n,id:n}):"object"==typeof n?n.id?e.push(n):console.error("fields must be an array of objects with id property"):console.error("fields must be an array of strings or objects");return this.fields=e,this},Ut.prototype.setOnChange=function(t){return this.onChange=t,this},Ut.prototype.addRelative=function(t){return t||(t=this.store.getMainDatum()),this.addRelativeInstance.activate(t),this},Ut.prototype.setupAddRelative=function(){return((...t)=>new Ft(...t))(this.store,function(){this.removeRelativeInstance.is_active&&this.removeRelativeInstance.onCancel()}.bind(this),function(t){this.store.updateMainId(t.id),this.store.updateTree({}),this.openFormWithId(t.id)}.bind(this))},Ut.prototype.setupRemoveRelative=function(){return((...t)=>new Lt(...t))(this.store,function(){this.addRelativeInstance.is_active&&this.addRelativeInstance.onCancel();t(this.cont,!0)}.bind(this),function(e){t(this.cont,!1),this.store.updateMainId(e.id),this.store.updateTree({}),this.openFormWithId(e.id)}.bind(this),this.modal);function t(t,e){n.select(t).select("#f3Canvas").classed("f3-remove-relative-active",e)}},Ut.prototype.setupModal=function(){return function(...t){return new Tt(...t)}(this.cont)},Ut.prototype.setEditFirst=function(t){return this.editFirst=t,this},Ut.prototype.isAddingRelative=function(){return this.addRelativeInstance.is_active},Ut.prototype.isRemovingRelative=function(){return this.removeRelativeInstance.is_active},Ut.prototype.setAddRelLabels=function(t){return this.addRelativeInstance.setAddRelLabels(t),this},Ut.prototype.setLinkExistingRelConfig=function(t){return this.link_existing_rel_config=t,this},Ut.prototype.setOnFormCreation=function(t){return this.onFormCreation=t,this},Ut.prototype.setKinshipInfo=function(t){return this.kinship_info_config=t,this},Ut.prototype.getStoreDataCopy=function(){let t=JSON.parse(JSON.stringify(this.store.getData()));return this.addRelativeInstance.is_active&&(t=this.addRelativeInstance.cleanUp(t)),t=Xt.handlers.cleanupDataJson(t),t},Ut.prototype.getDataJson=function(){return JSON.stringify(this.getStoreDataCopy(),null,2)},Ut.prototype.updateHistory=function(){this.history&&(this.history.changed(),this.history.controls.updateButtons()),this.onChange&&this.onChange()},Ut.prototype.setPostSubmit=function(t){return this.postSubmit=t,this},Ut.prototype.destroy=function(){return this.history.controls.destroy(),this.history=null,n.select(this.cont).select(".f3-form-cont").remove(),this.addRelativeInstance.onCancel&&this.addRelativeInstance.onCancel(),this.store.updateTree({}),this},Vt.prototype.init=function(){this.autocomplete_cont=n.select(this.cont).append("div").attr("class","f3-autocomplete-cont").node(),n.select(this.autocomplete_cont),this.create()},Vt.prototype.create=function(){const t=this;n.select(this.autocomplete_cont).html(`\n    <div class="f3-autocomplete">\n      <div class="f3-autocomplete-input-cont">\n        <input type="text" placeholder="Search">\n        <span class="f3-autocomplete-toggle">${ft()}</span>\n      </div>\n      <div class="f3-autocomplete-items" tabindex="0"></div>\n    </div>\n  `);const e=n.select(this.autocomplete_cont).select(".f3-autocomplete"),i=e.select("input"),r=e.select(".f3-autocomplete-items");function a(){e.classed("active",!0);const n=i.property("value"),r=t.options.filter(t=>t.label.toLowerCase().includes(n.toLowerCase()));r.forEach(function(t){const e=t.label.toLowerCase().indexOf(n.toLowerCase());t.label_html=-1!==e?t.label.substring(0,e)+"<strong>"+t.label.substring(e,e+n.length)+"</strong>"+t.label.substring(e+n.length):t.label}),r.sort(function(t,e){return t.label<e.label?-1:t.label>e.label?1:0}),o(r)}function s(){e.classed("active",!1),o([])}function o(e){r.selectAll("div.f3-autocomplete-item").data(e,t=>t?.value).join("div").attr("class","f3-autocomplete-item").on("click",(e,n)=>{t.onSelect(n.value)}).html(t=>t.optionHtml?t.optionHtml(t):function(t){return`<div class="${t.class?t.class:""}">${t.label_html}</div>`}(t))}e.on("focusout",()=>{setTimeout(()=>{e.node().contains(document.activeElement)||s()},200)}),i.on("focus",()=>{t.options=t.getOptions(),a()}).on("input",a).on("keydown",function(e){const i=r.selectAll("div.f3-autocomplete-item").nodes(),a=i.findIndex(t=>n.select(t).classed("f3-selected"));if("ArrowDown"===e.key){e.preventDefault();s(i,a<i.length-1?a+1:0)}else if("ArrowUp"===e.key){e.preventDefault();s(i,a>0?a-1:i.length-1)}else if("Enter"===e.key&&-1!==a){e.preventDefault();const r=n.select(i[a]).datum();r&&t.onSelect(r.value)}function s(t,e){t.forEach(t=>n.select(t).classed("f3-selected",!1)),t[e]&&(n.select(t[e]).classed("f3-selected",!0),t[e].scrollIntoView({block:"nearest"}))}}),r.on("wheel",t=>t.stopPropagation()),e.select(".f3-autocomplete-toggle").on("click",t=>{t.stopPropagation();const n=e.classed("active");e.classed("active",!n),n?s():(i.node().focus(),a())})},Vt.prototype.setOptionsGetter=function(t){return this.getOptions=t,this},Vt.prototype.setOptionsGetterPerson=function(t,e){return this.getOptions=()=>{const i=[];return t().forEach(t=>{t.to_add||t.unknown||t._new_rel_data||i.find(e=>e.value===t.id)||i.push({label:e(t),value:t.id,optionHtml:n(t)})}),i},this;function n(e){const n=!d(e,t());return t=>`\n      <div>\n        <span style="float: left; width: 10px; height: 10px; margin-right: 10px;" class="f3-${function(t){return"M"===t.data.gender?"male":"F"===t.data.gender?"female":"genderless"}(e)}-color">${ct()}</span>\n        <span>${t.label_html}</span>\n        ${n?`<span style="float: right; width: 10px; height: 10px; margin-left: 5px;" title="This profile is not connected to the main profile">${_t()}</span>`:""}\n      </div>\n    `}},Vt.prototype.destroy=function(){this.autocomplete_cont.remove()},Bt.prototype.init=function(t,e){this.cont=t=function(t){"string"==typeof t&&(t=document.querySelector(t));return t}(t);this.svg=Xt.createSvg(t,{onZoom:Xt.htmlHandlers.onZoomSetup(()=>t.querySelector("svg .view"),()=>t.querySelector("#htmlSvg .cards_view"))}),Xt.htmlHandlers.createHtmlSvg(t),function(t){n.select(t).append("div").attr("class","f3-nav-cont")}(this.cont),this.store=Xt.createStore({data:e,node_separation:this.node_separation,level_separation:this.level_separation,single_parent_empty_card:this.single_parent_empty_card,is_horizontal:this.is_horizontal}),this.store.setOnUpdate(e=>{this.beforeUpdate&&this.beforeUpdate(e),e=Object.assign({transition_time:this.transition_time},e||{}),this.is_card_html&&(e=Object.assign({},e||{},{cardHtml:t.querySelector("#htmlSvg")})),Xt.view(this.store.getTree(),this.svg,this.getCard(),e||{}),this.linkSpouseText&&function(t,e,i={}){const r=[];e.data.forEach(t=>{t._spouse&&"F"===t.data.data.gender&&r.push({nodes:[t,t._spouse],id:`${t.data.id}--${t._spouse.data.id}`}),t.spouses&&t.spouses.forEach(e=>r.push({nodes:[e,t],id:`${e.data.id}--${t.data.id}`}))});const a=n.select(t).select(".links_view").selectAll("g.link-text").data(r,t=>t.id),s=a.exit(),o=a.enter().append("g").attr("class","link-text"),d=o.merge(a),l=(t,e)=>t.spouse&&"F"===t.data.data.gender?t.x-i.node_separation/2:e.spouse&&"M"===e.data.data.gender?e.x+i.node_separation/2:Math.min(t.x,e.x)+i.node_separation/2;s.each(function(t){const e=n.select(this);e.transition("text").duration(100).style("opacity",0).on("end",()=>e.remove())}),o.each(function(t){const[e,i]=t.nodes,r=n.select(this);r.attr("transform",`translate(${l(e,i)}, ${e.y-3})`).style("opacity",0),r.append("text").style("font-size","12px").style("fill","#fff").style("text-anchor","middle")}),d.each(function(t){const[r,a]=t.nodes,s=n.select(this),o=i.initial?R(e,r,i.transition_time):0;s.select("text").text(i.linkSpouseText(r,a)),s.transition("text").duration(i.transition_time).delay(o).attr("transform",`translate(${l(r,a)}, ${r.y-3})`),s.transition("text-op").duration(100).delay(o+i.transition_time).style("opacity",1)})}(this.svg,this.store.getTree(),Object.assign({},e||{},{linkSpouseText:this.linkSpouseText,node_separation:this.node_separation})),this.afterUpdate&&this.afterUpdate(e)})},Bt.prototype.updateTree=function(t={initial:!1}){return this.store.updateTree(t),this},Bt.prototype.updateData=function(t){return this.store.updateData(t),this},Bt.prototype.setCardYSpacing=function(t){return"number"!=typeof t?(console.error("card_y_spacing must be a number"),this):(this.level_separation=t,this.store.state.level_separation=t,this)},Bt.prototype.setCardXSpacing=function(t){return"number"!=typeof t?(console.error("card_x_spacing must be a number"),this):(this.node_separation=t,this.store.state.node_separation=t,this)},Bt.prototype.setOrientationVertical=function(){return this.is_horizontal=!1,this.store.state.is_horizontal=!1,this},Bt.prototype.setOrientationHorizontal=function(){return this.is_horizontal=!0,this.store.state.is_horizontal=!0,this},Bt.prototype.setShowSiblingsOfMain=function(t){return this.store.state.show_siblings_of_main=t,this},Bt.prototype.setModifyTreeHierarchy=function(t){return this.store.state.modifyTreeHierarchy=t,this},Bt.prototype.setPrivateCardsConfig=function(t){return this.store.state.private_cards_config=t,this},Bt.prototype.setLinkSpouseText=function(t){return this.linkSpouseText=t,this},Bt.prototype.setSingleParentEmptyCard=function(t,{label:e="Unknown"}={}){return this.single_parent_empty_card=t,this.store.state.single_parent_empty_card=t,this.store.state.single_parent_empty_card_label=e,this.editTreeInstance&&this.editTreeInstance.addRelativeInstance.is_active&&this.editTreeInstance.addRelativeInstance.onCancel(),Xt.handlers.removeToAddFromData(this.store.getData()||[]),this},Bt.prototype.setCard=function(t){this.is_card_html=t.is_html,this.is_card_html?(this.svg.querySelector(".cards_view").innerHTML="",this.cont.querySelector("#htmlSvg").style.display="block"):(this.cont.querySelector("#htmlSvg .cards_view").innerHTML="",this.cont.querySelector("#htmlSvg").style.display="none");const e=t(this.cont,this.store);return this.getCard=()=>e.getCard(),e},Bt.prototype.setTransitionTime=function(t){return this.transition_time=t,this},Bt.prototype.setSortChildrenFunction=function(t){return this.store.state.sortChildrenFunction=t,this},Bt.prototype.setSortSpousesFunction=function(t){return this.store.state.sortSpousesFunction=t,this},Bt.prototype.setAncestryDepth=function(t){return this.store.state.ancestry_depth=t,this},Bt.prototype.setProgenyDepth=function(t){return this.store.state.progeny_depth=t,this},Bt.prototype.getMaxDepth=function(t){return function(t,e){const i=e.find(e=>e.id===t),r=n.hierarchy(i,function(t){return[t.rels.father,t.rels.mother].filter(t=>t).map(t=>e.find(e=>e.id===t)).filter(t=>t&&!t._new_rel_data&&!t.to_add)}),a=n.hierarchy(i,function(t){return[...t.rels.children||[]].map(t=>e.find(e=>e.id===t)).filter(t=>t&&!t._new_rel_data&&!t.to_add)});return{ancestry:r.height,progeny:a.height}}(t,this.store.getData())},Bt.prototype.calculateKinships=function(t,e){return Dt(t,this.store.getData(),e)},Bt.prototype.getKinshipsDataStash=function(t,e){return Ht(t,e,this.store.getData(),this.calculateKinships(t))},Bt.prototype.setDuplicateBranchToggle=function(t){return this.store.state.duplicate_branch_toggle=t,this},Bt.prototype.editTree=function(){return this.editTreeInstance=function(...t){return new Ut(...t)}(this.cont,this.store)},Bt.prototype.updateMain=function(t){return this.store.updateMainId(t.data.id),this.store.updateTree({}),this},Bt.prototype.updateMainId=function(t){return this.store.updateMainId(t),this},Bt.prototype.getMainDatum=function(){return this.store.getMainDatum()},Bt.prototype.updateData=function(t){this.store.updateData(t)},Bt.prototype.setBeforeUpdate=function(t){return this.beforeUpdate=t,this},Bt.prototype.setAfterUpdate=function(t){return this.afterUpdate=t,this},Bt.prototype.setPersonDropdown=function(t,e=this.cont.querySelector(".f3-nav-cont")){return this.personSearch=function(...t){return new Vt(...t)}(e,function(t){this.editTreeInstance&&this.editTreeInstance.open(this.store.getDatum(t));this.updateMainId(t),this.updateTree({initial:!1})}.bind(this)),this.personSearch.setOptionsGetterPerson(this.store.getData,t),this},Bt.prototype.unSetPersonSearch=function(){return this.personSearch.destroy(),this.personSearch=null,this},Zt.is_html=!1,Wt.prototype.init=function(){this.svg=this.cont.querySelector("svg.main_svg"),this.getCard=()=>Xt.elements.CardSvg({store:this.store,svg:this.svg,card_dim:this.card_dim,card_display:this.card_display,mini_tree:this.mini_tree,link_break:this.link_break,onCardClick:this.onCardClick,onCardUpdate:this.onCardUpdate})},Wt.prototype.setCardDisplay=function(t){return this.card_display=Jt(t),this},Wt.prototype.setCardDim=function(t){if("object"!=typeof t)return console.error("card_dim must be an object"),this;for(let e in t){const n=t[e];if("number"!=typeof n&&"boolean"!=typeof n)return console.error(`card_dim.${e} must be a number or boolean`),this;"width"===e&&(e="w"),"height"===e&&(e="h"),"img_width"===e&&(e="img_w"),"img_height"===e&&(e="img_h"),"img_x"===e&&(e="img_x"),"img_y"===e&&(e="img_y"),this.card_dim[e]=n}return function(t,e){t.querySelector("defs#f3CardDef")&&t.querySelector("defs#f3CardDef").remove(),It(t,e)}(this.svg,this.card_dim),this},Wt.prototype.setOnCardUpdate=function(t){return this.onCardUpdate=t,this},Wt.prototype.setMiniTree=function(t){return this.mini_tree=t,this},Wt.prototype.setLinkBreak=function(t){return this.link_break=t,this},Wt.prototype.onCardClickDefault=function(t,e){this.store.updateMainId(e.data.id),this.store.updateTree({})},Wt.prototype.setOnCardClick=function(t){return this.onCardClick=t,this},Kt.is_html=!0,Gt.prototype.is_html=!0,Gt.prototype.init=function(){this.svg=this.cont.querySelector("svg.main_svg"),this.getCard=()=>Xt.elements.CardHtml({store:this.store,card_display:this.card_display,cardImageField:this.cardImageField,defaultPersonIcon:this.defaultPersonIcon,onCardClick:this.onCardClick,style:this.style,mini_tree:this.mini_tree,onCardUpdate:this.onCardUpdate,card_dim:this.card_dim,empty_card_label:this.store.state.single_parent_empty_card_label,cardInnerHtmlCreator:this.cardInnerHtmlCreator,duplicate_branch_toggle:this.store.state.duplicate_branch_toggle,onCardMouseenter:this.onCardMouseenter?this.onCardMouseenter.bind(this):null,onCardMouseleave:this.onCardMouseleave?this.onCardMouseleave.bind(this):null})},Gt.prototype.setCardDisplay=function(t){return this.card_display=Jt(t),this},Gt.prototype.setCardImageField=function(t){return this.cardImageField=t,this},Gt.prototype.setDefaultPersonIcon=function(t){return this.defaultPersonIcon=t,this},Gt.prototype.setOnCardClick=function(t){return this.onCardClick=t,this},Gt.prototype.onCardClickDefault=function(t,e){this.store.updateMainId(e.data.id),this.store.updateTree({})},Gt.prototype.setStyle=function(t){return this.style=t,this},Gt.prototype.setMiniTree=function(t){return this.mini_tree=t,this},Gt.prototype.setOnCardUpdate=function(t){return this.onCardUpdate=t,this},Gt.prototype.setCardDim=function(t){if("object"!=typeof t)return console.error("card_dim must be an object"),this;for(let e in t){const n=t[e];if("number"!=typeof n&&"boolean"!=typeof n)return console.error(`card_dim.${e} must be a number or boolean`),this;"width"===e&&(e="w"),"height"===e&&(e="h"),"img_width"===e&&(e="img_w"),"img_height"===e&&(e="img_h"),"img_x"===e&&(e="img_x"),"img_y"===e&&(e="img_y"),this.card_dim[e]=n}return this},Gt.prototype.resetCardDim=function(){return this.card_dim={},this},Gt.prototype.setCardInnerHtmlCreator=function(t){return this.cardInnerHtmlCreator=t,this},Gt.prototype.setOnHoverPathToMain=function(){return this.onCardMouseenter=this.onEnterPathToMain.bind(this),this.onCardMouseleave=this.onLeavePathToMain.bind(this),this},Gt.prototype.unsetOnHoverPathToMain=function(){return this.onCardMouseenter=null,this.onCardMouseleave=null,this},Gt.prototype.onEnterPathToMain=function(t,e){this.to_transition=e.data.id;const i=this.store.getTreeMainDatum(),r=n.select(this.cont).select("div.cards_view").selectAll(".card_cont"),a=n.select(this.cont).select("svg.main_svg .links_view").selectAll(".link"),[s,o]=function(t,e,n,i){const r=n.is_ancestry,a=e.data();let s=[],o=[];if(r){const r=[];let c=n,h=0;for(;c!==i.data&&h<100;){h++;const t=a.find(t=>!0===t.spouse&&(t.source===c||t.target===c));if(t){const e=l(a.filter(e=>Array.isArray(e.target)&&e.target.includes(t.source)&&e.target.includes(t.target)),i);if(!e)break;r.push(t),r.push(e),c=e.source}else{const t=l(a.filter(t=>Array.isArray(t.target)&&t.target.includes(c)),i);if(!t)break;r.push(t),c=t.source}}e.each(function(t){r.includes(t)&&s.push({link:t,node:this})});const u=d(n,r);t.each(function(t){u.includes(t)&&o.push({card:t,node:this})})}else if(n.spouse&&n.spouse.data===i.data){e.each(function(t){t.target===n&&s.push({link:t,node:this})});const r=[i,n];t.each(function(t){r.includes(t)&&o.push({card:t,node:this})})}else if(n.sibling){e.each(function(t){t.source===n&&s.push({link:t,node:this}),t.source===i&&2===t.target.length&&s.push({link:t,node:this}),n.parents.includes(t.source)&&n.parents.includes(t.target)&&s.push({link:t,node:this})});const r=[i,n,...n.parents];t.each(function(t){r.includes(t)&&o.push({card:t,node:this})})}else{let r=[],l=n,c=0;for(;l!==i.data&&c<100;){c++;const t=a.find(t=>t.target===l&&Array.isArray(t.source));if(t){const e=a.find(e=>{return!0===e.spouse&&(n=[e.source,e.target],i=t.source,n.every(t=>i.some(e=>t===e)));var n,i});r.push(t),r.push(e),l=e?e.source:t.source[0]}else{const t=a.find(t=>t.target===l&&!Array.isArray(t.source));if(!t)break;r.push(t),l=t.source}}e.each(function(t){r.includes(t)&&s.push({link:t,node:this})});const h=d(i,r);t.each(function(t){h.includes(t)&&o.push({card:t,node:this})})}return[o,s];function d(t,e){const r=e.filter(t=>t).reduce((t,e)=>(Array.isArray(e.target)?t.push(...e.target):t.push(e.target),Array.isArray(e.source)?t.push(...e.source):t.push(e.source),t),[]),a=[i,n];return function t(e){e.data.rels.children&&e.data.rels.children.forEach(e=>{const n=r.find(t=>t.data.id===e);n&&(a.push(n),t(n))})}(t),a}function l(t,e){return 0===t.length?null:1===t.length?t[0]:t.find(t=>t.source===e)}}(r,a,e,i);return s.forEach(t=>{const i=200*Math.abs(e.depth-t.card.depth);n.select(t.node.querySelector("div.card-inner")).transition().duration(0).delay(i).on("end",()=>this.to_transition===e.data.id&&n.select(t.node.querySelector("div.card-inner")).classed("f3-path-to-main",!0))}),o.forEach(t=>{const i=200*Math.abs(e.depth-t.link.depth);n.select(t.node).transition().duration(0).delay(i).on("end",()=>this.to_transition===e.data.id&&n.select(t.node).classed("f3-path-to-main",!0))}),this},Gt.prototype.onLeavePathToMain=function(t,e){return this.to_transition=!1,n.select(this.cont).select("div.cards_view").selectAll("div.card-inner").classed("f3-path-to-main",!1),n.select(this.cont).select("svg.main_svg .links_view").selectAll(".link").classed("f3-path-to-main",!1),this};var Qt=Yt(class{constructor(t={}){this.baseUrl=t.baseUrl||"/api",this.familyId=t.familyId,this.headers={"Content-Type":"application/json",...t.headers}}setFamilyId(t){this.familyId=t}async fetchFamily(t=this.familyId){if(!t)throw new Error("Family ID is required");try{const e=await fetch(`${this.baseUrl}/family/${t}`,{method:"GET",headers:this.headers});if(!e.ok)throw new Error(`Failed to fetch family data: ${e.statusText}`);const n=await e.json();return this.transformFromApi(n)}catch(t){throw console.error("Error fetching family data:",t),t}}async saveFamily(t,e=this.familyId){if(!e)throw new Error("Family ID is required");try{const n=this.transformToApi(t),i=await fetch(`${this.baseUrl}/family/${e}`,{method:"PUT",headers:this.headers,body:JSON.stringify(n)});if(!i.ok)throw new Error(`Failed to save family data: ${i.statusText}`);return await i.json()}catch(t){throw console.error("Error saving family data:",t),t}}async addPerson(t,e=this.familyId){if(!e)throw new Error("Family ID is required");try{const n=await fetch(`${this.baseUrl}/family/${e}/person`,{method:"POST",headers:this.headers,body:JSON.stringify(t)});if(!n.ok)throw new Error(`Failed to add person: ${n.statusText}`);return await n.json()}catch(t){throw console.error("Error adding person:",t),t}}async updatePerson(t,e,n=this.familyId){if(!n)throw new Error("Family ID is required");try{const i=await fetch(`${this.baseUrl}/family/${n}/person/${t}`,{method:"PUT",headers:this.headers,body:JSON.stringify(e)});if(!i.ok)throw new Error(`Failed to update person: ${i.statusText}`);return await i.json()}catch(t){throw console.error("Error updating person:",t),t}}async deletePerson(t,e=this.familyId){if(!e)throw new Error("Family ID is required");try{const n=await fetch(`${this.baseUrl}/family/${e}/person/${t}`,{method:"DELETE",headers:this.headers});if(!n.ok)throw new Error(`Failed to delete person: ${n.statusText}`);return await n.json()}catch(t){throw console.error("Error deleting person:",t),t}}transformFromApi(t){return Array.isArray(t)?t:t.members?t.members:t.data||t}transformToApi(t){return t.map(t=>({id:t.id,data:{...t.data},rels:{...t.rels}})).filter(t=>!t.data._new_rel_data&&!t.to_add)}async batchUpdate(t,e=this.familyId){if(!e)throw new Error("Family ID is required");try{const n=await fetch(`${this.baseUrl}/family/${e}/batch`,{method:"POST",headers:this.headers,body:JSON.stringify({operations:t})});if(!n.ok)throw new Error(`Failed to perform batch update: ${n.statusText}`);return await n.json()}catch(t){throw console.error("Error performing batch update:",t),t}}});const Xt={CalculateTree:k,createStore:function(t){let e;const n=t;return n.main_id_history=[],{state:n,updateTree:t=>{n.tree=k({data:n.data,main_id:n.main_id,node_separation:n.node_separation,level_separation:n.level_separation,single_parent_empty_card:n.single_parent_empty_card,is_horizontal:n.is_horizontal,one_level_rels:n.one_level_rels,sortChildrenFunction:n.sortChildrenFunction,sortSpousesFunction:n.sortSpousesFunction,ancestry_depth:n.ancestry_depth,progeny_depth:n.progeny_depth,show_siblings_of_main:n.show_siblings_of_main,modifyTreeHierarchy:n.modifyTreeHierarchy,private_cards_config:n.private_cards_config,duplicate_branch_toggle:n.duplicate_branch_toggle}),n.main_id||r(n.tree.main_id),e&&e(t)},updateData:t=>n.data=t,updateMainId:r,getMainId:()=>n.main_id,getData:()=>n.data,getTree:()=>n.tree,setOnUpdate:t=>e=t,getMainDatum:function(){return n.data.find(t=>t.id===n.main_id)},getDatum:i,getTreeMainDatum:function(){return n.tree?n.tree.data.find(t=>t.data.id===n.main_id):null},getTreeDatum:function(t){return n.tree?n.tree.data.find(e=>e.data.id===t):null},getLastAvailableMainDatum:function(){let t=n.main_id_history.slice(0).reverse().find(t=>i(t));t||(t=n.data[0].id);t!==n.main_id&&r(t);return i(t)},methods:{}};function i(t){return n.data.find(e=>e.id===t)}function r(t){t!==n.main_id&&(n.main_id_history=n.main_id_history.filter(e=>e!==t).slice(-10),n.main_id_history.push(t),n.main_id=t)}},view:function(t,e,i,a={}){a.initial=a.hasOwnProperty("initial")?a.initial:!n.select(e.parentNode).select(".card_cont").node(),a.transition_time=a.hasOwnProperty("transition_time")?a.transition_time:2e3,a.cardComponent?function(t,e,i,a={}){const s=n.select(T(()=>t)).selectAll("div.card_cont_fake").data(e.data,t=>t.data.id),o=s.exit(),d=s.enter().append("div").attr("class","card_cont_fake").style("display","none"),l=d.merge(s);o.each(t=>r(t,!1,!0)),d.each(t=>r(t,!0,!1)),o.each(function(t){const e=n.select(i(t)),r=n.select(this);e.transition().duration(a.transition_time).style("opacity",0).style("transform",`translate(${t._x}px, ${t._y}px)`).on("end",()=>r.remove())}),s.each(function(t){}),d.each(function(t){n.select(i(t)).style("position","absolute").style("top","0").style("left","0").style("opacity",0).style("transform",`translate(${t._x}px, ${t._y}px)`)}),l.each(function(t){const r=n.select(i(t)),s=a.initial?R(e,t,a.transition_time):0;r.transition().duration(a.transition_time).delay(s).style("transform",`translate(${t.x}px, ${t.y}px)`).style("opacity",1)})}(a.cardComponent,t,i,a):a.cardHtml?function(t,e,i,a={}){const s=n.select(t).select(".cards_view").selectAll("div.card_cont").data(e.data,t=>t.tid),o=s.exit(),d=s.enter().append("div").attr("class","card_cont").style("pointer-events","none"),l=d.merge(s);o.each(t=>r(t,!1,!0)),d.each(t=>r(t,!0,!1)),o.each(function(t){const e=n.select(this);e.transition().duration(a.transition_time).style("opacity",0).style("transform",`translate(${t._x}px, ${t._y}px)`).on("end",()=>e.remove())}),s.each(function(t){}),d.each(function(t){n.select(this).style("position","absolute").style("top","0").style("left","0").style("transform",`translate(${t._x}px, ${t._y}px)`).style("opacity",0),i.call(this,t)}),l.each(function(t){i.call(this,t);const r=a.initial?R(e,t,a.transition_time):0;n.select(this).transition().duration(a.transition_time).delay(r).style("transform",`translate(${t.x}px, ${t.y}px)`).style("opacity",1)})}(a.cardHtml,t,i,a):function(t,e,i,a={}){const s=n.select(t).select(".cards_view").selectAll("g.card_cont").data(e.data,t=>t.data.id),o=s.exit(),d=s.enter().append("g").attr("class","card_cont"),l=d.merge(s);o.each(t=>r(t,!1,!0)),d.each(t=>r(t,!0,!1)),o.each(function(t){const e=n.select(this);e.transition().duration(a.transition_time).style("opacity",0).attr("transform",`translate(${t._x}, ${t._y})`).on("end",()=>e.remove())}),s.each(function(t){}),d.each(function(t){n.select(this).attr("transform",`translate(${t._x}, ${t._y})`).style("opacity",0),i.call(this,t)}),l.each(function(t){i.call(this,t);const r=a.initial?R(e,t,a.transition_time):0;n.select(this).transition().duration(a.transition_time).delay(r).attr("transform",`translate(${t.x}, ${t.y})`).style("opacity",1)})}(e,t,i,a),function(t,e,i={}){const r=e.data.reduce((t,n)=>(function({d:t,tree:e,is_horizontal:n=!1}){const i=[];return(t.spouses||t._spouse)&&function({d:t}){function e(t,e){return{d:[[t.x,t.y],[e.x,e.y]],_d:()=>[t.is_ancestry?[a(t,"x")-1e-4,a(t,"y")]:[t.x,t.y],t.is_ancestry?[a(e,"x"),a(e,"y")]:[t.x-1e-4,t.y]],curve:!1,id:o(t,e),depth:t.depth,spouse:!0,is_ancestry:e.is_ancestry,source:t,target:e}}t.spouses?t.spouses.forEach(n=>i.push(e(t,n))):t._spouse&&i.push(e(t,t._spouse))}({d:t}),function({d:t}){if(!t.parents)return;const e=t.parents[0],n=t.parents[1]||e,a={x:r(e,n,"x"),y:r(e,n,"y")};i.push({d:s(t,a),_d:()=>s({x:t.x,y:t.y},{x:t.x,y:t.y}),curve:!0,id:o(t,e,n),depth:t.depth+1,is_ancestry:!0,source:t,target:[e,n]})}({d:t}),function({d:t}){t.children&&0!==t.children.length&&t.children.forEach((e,r)=>{const d=function(t,e){const n=(e.spouses||[]).find(e=>e.data.id===t.data.rels.mother||e.data.id===t.data.rels.father);return n}(e,t)||t,l=d.sx,c=n?{x:t.x,y:l}:{x:l,y:t.y};i.push({d:s(e,c),_d:()=>s(c,{x:a(c,"x"),y:a(c,"y")}),curve:!0,id:o(e,t,d),depth:t.depth+1,is_ancestry:!1,source:[t,d],target:e})})}({d:t}),i;function r(t,e,n,i){return t[n]-(t[n]-e[n])/2}function a(t,e){return t.hasOwnProperty("_"+e)?t["_"+e]:t[e]}function s(t,e){return n?function(t,e){const n=t.x+(e.x-t.x)/2;return[[t.x,t.y],[n,t.y],[n,t.y],[n,e.y],[n,e.y],[e.x,e.y]]}(t,e):function(t,e){const n=t.y+(e.y-t.y)/2;return[[t.x,t.y],[t.x,n],[t.x,n],[e.x,n],[e.x,n],[e.x,e.y]]}(t,e)}function o(...t){return t.map(t=>t.tid).sort().join(", ")}}({d:n,tree:e.data,is_horizontal:e.is_horizontal}).forEach(e=>t[e.id]=e),t),{}),a=Object.values(r),s=n.select(t).select(".links_view").selectAll("path.link").data(a,t=>t.id),o=s.exit(),d=s.enter().append("path").attr("class","link"),l=d.merge(s);o.each(function(t){const e=n.select(this);e.transition("op").duration(800).style("opacity",0),e.transition("path").duration(i.transition_time).attr("d",A(t,!0)).on("end",()=>e.remove())}),d.each(function(t){n.select(this).attr("fill","none").attr("stroke","#fff").attr("stroke-width",1).style("opacity",0).attr("d",A(t,!0))}),l.each(function(t){const r=n.select(this),a=i.initial?R(e,t,i.transition_time):0;r.transition("path").duration(i.transition_time).delay(a).attr("d",A(t)).style("opacity",1)})}(e,t,a);const s=a.tree_position||"fit";return a.initial?E({svg:e,svg_dim:e.getBoundingClientRect(),tree_dim:t.dim,transition_time:0}):"fit"===s?E({svg:e,svg_dim:e.getBoundingClientRect(),tree_dim:t.dim,transition_time:a.transition_time}):"main_to_middle"===s&&M({datum:t.data[0],svg:e,svg_dim:e.getBoundingClientRect(),scale:a.scale,transition_time:a.transition_time}),!0},createSvg:function(t,e={}){const i=t.getBoundingClientRect(),r=`\n    <svg class="main_svg">\n      <rect width="${i.width}" height="${i.height}" fill="transparent" />\n      <g class="view">\n        <g class="links_view"></g>\n        <g class="cards_view"></g>\n      </g>\n      <g style="transform: translate(100%, 100%)">\n        <g class="fit_screen_icon cursor-pointer" style="transform: translate(-50px, -50px); display: none">\n          <rect width="27" height="27" stroke-dasharray="13.5" stroke-dashoffset="6.75" \n            style="stroke:#fff;stroke-width:4px;fill:transparent;"/>\n          <circle r="5" cx="13.5" cy="13.5" style="fill:#fff" />          \n        </g>\n      </g>\n    </svg>\n  `,a=function(t){let e=t.querySelector("#f3Canvas");e||(e=n.create("div").attr("id","f3Canvas").attr("style","position: relative; overflow: hidden; width: 100%; height: 100%;").node());return e}(t),s=n.create("div").node();s.innerHTML=r;const o=s.querySelector("svg");return a.appendChild(o),t.appendChild(a),function(t,e={}){if(t.__zoom)return;const i=t.querySelector(".view"),r=n.zoom().on("zoom",e.onZoom||a);n.select(t).call(r),t.__zoomObj=r,e.zoom_polite&&r.filter(s);function a(t){n.select(i).attr("transform",t.transform)}function s(t){return!("wheel"===t.type&&!t.ctrlKey)&&!(t.touches&&t.touches.length<2)}}(a,e),o},handlers:bt,elements:At,htmlHandlers:D,icons:vt,createChart:function(t,e,n={}){const i=Nt(t,e);if(n.apiConfig&&(i.api=new Qt(n.apiConfig),i.loadFromApi=async function(t){try{t&&this.api.setFamilyId(t);const e=await this.api.fetchFamily();return this.updateData(e),this.updateTree({initial:!0}),e}catch(t){throw console.error("Failed to load from API:",t),t}},i.saveToApi=async function(){try{const t=this.store.getData();return await this.api.saveFamily(t),!0}catch(t){throw console.error("Failed to save to API:",t),t}},i.setApiConfig=function(t){return this.api=new Qt(t),this},n.autoSave)){const t=i.updateData.bind(i);i.updateData=function(e){return t(e),n.autoSave&&setTimeout(()=>this.saveToApi().catch(console.error),1e3),this}}return i},createChartBasic:Nt,CardSvg:Zt,CardHtml:Kt,FamilyApi:Qt,utils:{createPersonId:()=>"xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx".replace(/[xy]/g,function(t){var e=16*Math.random()|0;return("x"==t?e:3&e|8).toString(16)}),validatePersonData:t=>{if(!t.id)throw new Error("Person must have an id");if(!t.data)throw new Error("Person must have data object");if(!t.rels)throw new Error("Person must have rels object");return!0},createEmptyPerson:(t={})=>({id:Xt.utils.createPersonId(),data:{gender:"M",...t},rels:{}}),findPersonById:(t,e)=>t.find(t=>t.id===e)||null,getChildren:(t,e)=>{const n=Xt.utils.findPersonById(t,e);return n&&n.rels.children?n.rels.children.map(e=>Xt.utils.findPersonById(t,e)).filter(t=>null!==t):[]},getParents:(t,e)=>{const n=Xt.utils.findPersonById(t,e);return n?{father:n.rels.father?Xt.utils.findPersonById(t,n.rels.father):null,mother:n.rels.mother?Xt.utils.findPersonById(t,n.rels.mother):null}:{father:null,mother:null}}}};module.exports=Xt;
